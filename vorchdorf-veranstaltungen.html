<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veranstaltungen | Willkommen in Vorchdorf</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0d9488;
            --primary-light: #14b8a6;
            --primary-dark: #0f766e;
            --secondary: #f0fdfa;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --radius: 12px;
            --radius-lg: 16px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--gray-50) 100%);
            color: var(--text-dark);
            min-height: 100vh;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 1.5rem 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header h1 { font-size: 1.5rem; font-weight: 700; }
        .back-link {
            color: var(--white);
            text-decoration: none;
            font-weight: 500;
            opacity: 0.9;
        }
        .back-link:hover { opacity: 1; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem 1rem; }
        .loading { text-align: center; padding: 4rem 2rem; }
        .loading-spinner {
            width: 50px; height: 50px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .config-notice {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .config-notice h3 { color: #92400e; margin-bottom: 0.5rem; }
        .config-notice code { background: #fef9c3; padding: 0.2rem 0.5rem; border-radius: 4px; }
        .controls-bar {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            background: var(--gray-100);
            padding: 0.25rem;
            border-radius: var(--radius);
            width: fit-content;
            margin-bottom: 1rem;
        }
        .view-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            color: var(--text-light);
        }
        .view-btn.active { background: var(--white); color: var(--primary); }
        .filter-row { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; }
        .search-box { flex: 1; min-width: 200px; position: relative; }
        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.75rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 1rem;
        }
        .search-box input:focus { outline: none; border-color: var(--primary); }
        .search-box::before { content: "üîç"; position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); }
        .category-pills { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .category-pill {
            padding: 0.5rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 50px;
            background: var(--white);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
        }
        .category-pill:hover { border-color: var(--primary-light); color: var(--primary); }
        .category-pill.active { background: var(--primary); border-color: var(--primary); color: var(--white); }
        .calendar-view { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow: hidden; }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }
        .calendar-nav { display: flex; align-items: center; gap: 1rem; }
        .calendar-nav button {
            width: 40px; height: 40px;
            border: 2px solid var(--gray-200);
            background: var(--white);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
        }
        .calendar-nav button:hover { border-color: var(--primary); color: var(--primary); }
        .calendar-month { font-size: 1.25rem; font-weight: 600; }
        .today-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--primary);
            background: var(--white);
            color: var(--primary);
            border-radius: var(--radius);
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
        }
        .today-btn:hover { background: var(--primary); color: var(--white); }
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }
        .weekday { padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.875rem; color: var(--text-light); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day {
            min-height: 100px;
            border-right: 1px solid var(--gray-100);
            border-bottom: 1px solid var(--gray-100);
            padding: 0.5rem;
            cursor: pointer;
        }
        .calendar-day:nth-child(7n) { border-right: none; }
        .calendar-day:hover { background: var(--gray-50); }
        .calendar-day.other-month { background: var(--gray-50); }
        .calendar-day.other-month .day-number { color: var(--gray-300); }
        .calendar-day.today { background: var(--secondary); }
        .calendar-day.today .day-number { background: var(--primary); color: var(--white); }
        .day-number {
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.875rem;
            border-radius: 50%;
            margin-bottom: 0.25rem;
        }
        .day-events { display: flex; flex-direction: column; gap: 2px; }
        .day-event {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .day-event.kultur { background: #dbeafe; color: #1e40af; }
        .day-event.sport { background: #dcfce7; color: #166534; }
        .day-event.verein { background: #fef3c7; color: #92400e; }
        .day-event.fest { background: #fce7f3; color: #9d174d; }
        .day-event.markt { background: #f3e8ff; color: #7c3aed; }
        .day-event.kinder { background: #ffedd5; color: #c2410c; }
        .more-events { font-size: 0.7rem; color: var(--text-light); font-weight: 500; padding: 2px 6px; }
        .list-view { display: none; }
        .list-view.active { display: block; }
        .calendar-view.hidden { display: none; }
        .event-list { display: flex; flex-direction: column; gap: 1rem; }
        .date-group { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow: hidden; }
        .date-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .date-header .day-num { font-size: 2rem; font-weight: 700; line-height: 1; }
        .date-header .day-info { display: flex; flex-direction: column; }
        .date-header .day-name { font-weight: 600; }
        .date-header .month-year { font-size: 0.875rem; opacity: 0.9; }
        .event-card {
            display: flex;
            gap: 1rem;
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
        }
        .event-card:last-child { border-bottom: none; }
        .event-card:hover { background: var(--gray-50); }
        .event-time { min-width: 60px; text-align: center; }
        .event-time .time { font-weight: 600; color: var(--primary); font-size: 1.1rem; }
        .event-time .duration { font-size: 0.75rem; color: var(--text-light); }
        .event-content { flex: 1; }
        .event-title { font-weight: 600; font-size: 1.1rem; margin-bottom: 0.25rem; }
        .event-meta { display: flex; flex-wrap: wrap; gap: 0.75rem; font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .event-category {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .event-category.kultur { background: #dbeafe; color: #1e40af; }
        .event-category.sport { background: #dcfce7; color: #166534; }
        .event-category.verein { background: #fef3c7; color: #92400e; }
        .event-category.fest { background: #fce7f3; color: #9d174d; }
        .event-category.markt { background: #f3e8ff; color: #7c3aed; }
        .event-category.kinder { background: #ffedd5; color: #c2410c; }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--white);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }
        .modal-title { font-size: 1.5rem; font-weight: 700; }
        .modal-close {
            width: 40px; height: 40px;
            border: none;
            background: var(--gray-100);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
        }
        .modal-close:hover { background: var(--gray-200); }
        .modal-body { padding: 1.5rem; }
        .modal-info-grid { display: grid; gap: 1rem; margin-bottom: 1.5rem; }
        .modal-info-item { display: flex; gap: 0.75rem; align-items: flex-start; }
        .modal-info-item .icon { font-size: 1.25rem; width: 32px; text-align: center; }
        .modal-info-item .label { font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; }
        .modal-info-item .value { font-weight: 500; }
        .modal-description { line-height: 1.7; color: var(--text-dark); }
        .modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        .btn-primary { background: var(--primary); color: var(--white); border: none; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--white); color: var(--primary); border: 2px solid var(--primary); }
        .btn-secondary:hover { background: var(--secondary); }
        .empty-state { text-align: center; padding: 4rem 2rem; background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow); }
        .empty-state .icon { font-size: 4rem; margin-bottom: 1rem; }
        .empty-state h3 { font-size: 1.25rem; margin-bottom: 0.5rem; }
        .empty-state p { color: var(--text-light); }
        .stats-bar { display: flex; gap: 1rem; margin-bottom: 1.5rem; overflow-x: auto; }
        .stat-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .stat-icon { font-size: 1.5rem; }
        .stat-content .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .stat-content .stat-label { font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; }
        .data-source {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: 0.75rem 1rem;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.25rem; }
            .filter-row { flex-direction: column; }
            .search-box { min-width: 100%; }
            .calendar-day { min-height: 70px; padding: 0.25rem; }
            .day-number { width: 24px; height: 24px; font-size: 0.75rem; }
            .day-event { font-size: 0.6rem; padding: 1px 4px; }
            .event-card { flex-direction: column; gap: 0.75rem; }
            .event-time { text-align: left; display: flex; gap: 0.5rem; }
            .modal-actions { flex-direction: column; }
            .btn { justify-content: center; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="vorchdorf-willkommen.html" class="back-link">‚Üê Zur App</a>
            <h1>üìÖ Veranstaltungen</h1>
            <div style="width: 80px;"></div>
        </div>
    </header>

    <div class="container">
        <div class="loading" id="loadingState">
            <div class="loading-spinner"></div>
            <p>Lade Veranstaltungen...</p>
        </div>

        <div class="config-notice" id="configNotice" style="display: none;">
            <h3>‚öôÔ∏è Konfiguration erforderlich</h3>
            <p>Bitte trage die URL deines ver√∂ffentlichten Google Sheets in der Variable <code>GOOGLE_SHEET_URL</code> ein.</p>
            <p style="margin-top: 0.5rem;">Format: <code>https://docs.google.com/spreadsheets/d/e/XXXXX/pub?output=csv</code></p>
        </div>

        <div id="mainContent" style="display: none;">
            <div class="data-source">üìä Daten aus Google Sheet ‚Ä¢ Letzte Aktualisierung: <span id="lastUpdate">-</span></div>
            
            <div class="stats-bar">
                <div class="stat-card"><span class="stat-icon">üìÖ</span><div class="stat-content"><div class="stat-value" id="totalEvents">0</div><div class="stat-label">Veranstaltungen</div></div></div>
                <div class="stat-card"><span class="stat-icon">üìÜ</span><div class="stat-content"><div class="stat-value" id="thisMonth">0</div><div class="stat-label">Diesen Monat</div></div></div>
                <div class="stat-card"><span class="stat-icon">üéØ</span><div class="stat-content"><div class="stat-value" id="thisWeek">0</div><div class="stat-label">Diese Woche</div></div></div>
            </div>

            <div class="controls-bar">
                <div class="view-toggle">
                    <button class="view-btn active" data-view="calendar">üìÖ Kalender</button>
                    <button class="view-btn" data-view="list">üìã Liste</button>
                </div>
                <div class="filter-row">
                    <div class="search-box"><input type="text" id="searchInput" placeholder="Veranstaltung suchen..."></div>
                </div>
                <div class="category-pills">
                    <button class="category-pill active" data-category="all">üé™ Alle</button>
                    <button class="category-pill" data-category="kultur">üé≠ Kultur</button>
                    <button class="category-pill" data-category="sport">‚öΩ Sport</button>
                    <button class="category-pill" data-category="verein">üë• Vereine</button>
                    <button class="category-pill" data-category="fest">üéâ Feste</button>
                    <button class="category-pill" data-category="markt">üõí M√§rkte</button>
                    <button class="category-pill" data-category="kinder">üë∂ Kinder</button>
                </div>
            </div>

            <div class="calendar-view" id="calendarView">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button id="prevMonth">‚Äπ</button>
                        <span class="calendar-month" id="currentMonth">Dezember 2025</span>
                        <button id="nextMonth">‚Ä∫</button>
                    </div>
                    <button class="today-btn" id="todayBtn">Heute</button>
                </div>
                <div class="calendar-weekdays">
                    <div class="weekday">Mo</div><div class="weekday">Di</div><div class="weekday">Mi</div>
                    <div class="weekday">Do</div><div class="weekday">Fr</div><div class="weekday">Sa</div><div class="weekday">So</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>

            <div class="list-view" id="listView">
                <div class="event-list" id="eventList"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="eventModal">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <span class="event-category" id="modalCategory">Kultur</span>
                    <h2 class="modal-title" id="modalTitle">Veranstaltungstitel</h2>
                </div>
                <button class="modal-close" id="modalClose">√ó</button>
            </div>
            <div class="modal-body">
                <div class="modal-info-grid">
                    <div class="modal-info-item"><span class="icon">üìÖ</span><div><div class="label">Datum</div><div class="value" id="modalDate">-</div></div></div>
                    <div class="modal-info-item"><span class="icon">üïê</span><div><div class="label">Uhrzeit</div><div class="value" id="modalTime">-</div></div></div>
                    <div class="modal-info-item"><span class="icon">üìç</span><div><div class="label">Ort</div><div class="value" id="modalLocation">-</div></div></div>
                    <div class="modal-info-item" id="organizerItem"><span class="icon">üë§</span><div><div class="label">Veranstalter</div><div class="value" id="modalOrganizer">-</div></div></div>
                </div>
                <div class="modal-description" id="modalDescription"></div>
                <div class="modal-actions">
                    <a href="#" class="btn btn-primary" id="modalWebsite" target="_blank">üåê Website</a>
                    <button class="btn btn-secondary" id="addToCalendar">üìÖ Zum Kalender</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // KONFIGURATION - HIER GOOGLE SHEET URL EINTRAGEN
        // ============================================================
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR6Pi8u-l21PXA8Qls1zBJK1Y5XWDmdwr5TLgioOuWSRhhoToDG1tmHt8NBR7S7jqn10WdHIk1zhK7g/pub?output=csv';
        // ============================================================

        let events = [];
        let currentDate = new Date();
        let selectedCategory = 'all';
        let searchQuery = '';

        const monthNames = ['J√§nner', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
        const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
        const categoryNames = { kultur: 'Kultur', sport: 'Sport', verein: 'Vereine', fest: 'Feste', markt: 'M√§rkte', kinder: 'Kinder' };

        document.addEventListener('DOMContentLoaded', () => {
            if (!GOOGLE_SHEET_URL) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('configNotice').style.display = 'block';
                loadDemoData();
                return;
            }
            loadEventsFromSheet();
        });

        function loadDemoData() {
            events = [
                { id: 1, titel: "Neujahrskonzert Vorchdorf", datum: "2026-01-04", zeit_start: "19:00", zeit_ende: "22:00", ort: "Kitzmantelfabrik", kategorie: "kultur", veranstalter: "Musikkapelle Vorchdorf", beschreibung: "Rhapsody in Blue: Vorchdorfer Neujahrskonzert!", website: "" },
                { id: 2, titel: "Gl√∂cklerlauf", datum: "2026-01-05", zeit_start: "17:00", zeit_ende: "19:00", ort: "Schlo√üplatz", kategorie: "fest", veranstalter: "Gemeinde Vorchdorf", beschreibung: "Traditioneller Gl√∂cklerlauf", website: "" },
                { id: 3, titel: "Punscht√ºr bei der Kulturvilla", datum: "2025-12-22", zeit_start: "16:00", zeit_ende: "19:30", ort: "Kulturvilla", kategorie: "fest", veranstalter: "", beschreibung: "√ñffentlicher Punschstand", website: "" },
                { id: 4, titel: "Christbaumverkauf FF Vorchdorf", datum: "2025-12-22", zeit_start: "09:00", zeit_ende: "17:00", ort: "Feuerwehr Vorchdorf", kategorie: "markt", veranstalter: "FF Vorchdorf", beschreibung: "Christbaumverkauf", website: "" }
            ];
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('lastUpdate').textContent = 'Demo-Daten';
            initializeApp();
        }

        async function loadEventsFromSheet() {
            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                if (!response.ok) throw new Error('Fehler beim Laden');
                const csvText = await response.text();
                events = parseCSV(csvText);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('de-AT');
                initializeApp();
            } catch (error) {
                document.getElementById('loadingState').innerHTML = '<div class="error-state"><h3>‚ö†Ô∏è Fehler beim Laden</h3><p>' + error.message + '</p></div>';
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split('\t').map(h => h.trim().toLowerCase());
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const values = line.split('\t');
                const event = { id: i };
                headers.forEach((header, index) => {
                    let value = values[index] || '';
                    value = value.replace(/^"|"$/g, '').replace(/""/g, '"');
                    event[header] = value;
                });
                if (event.titel && event.datum) result.push(event);
            }
            return result;
        }

        function initializeApp() {
            renderCalendar();
            renderListView();
            updateStats();
            setupEventListeners();
        }

        function setupEventListeners() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const view = btn.dataset.view;
                    document.getElementById('calendarView').classList.toggle('hidden', view !== 'calendar');
                    document.getElementById('listView').classList.toggle('active', view === 'list');
                });
            });
            document.querySelectorAll('.category-pill').forEach(pill => {
                pill.addEventListener('click', () => {
                    document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');
                    selectedCategory = pill.dataset.category;
                    renderCalendar();
                    renderListView();
                });
            });
            document.getElementById('prevMonth').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            document.getElementById('nextMonth').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
            document.getElementById('todayBtn').addEventListener('click', () => { currentDate = new Date(); renderCalendar(); });
            document.getElementById('searchInput').addEventListener('input', (e) => { searchQuery = e.target.value.toLowerCase(); renderCalendar(); renderListView(); });
            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('eventModal').addEventListener('click', (e) => { if (e.target.id === 'eventModal') closeModal(); });
            document.getElementById('addToCalendar').addEventListener('click', () => {
                const eventId = parseInt(document.getElementById('eventModal').dataset.eventId);
                const event = events.find(e => e.id === eventId);
                if (event) downloadICS(event);
            });
        }

        function filterEvents(eventsList) {
            return eventsList.filter(event => {
                const matchesCategory = selectedCategory === 'all' || event.kategorie === selectedCategory;
                const matchesSearch = searchQuery === '' || 
                    (event.titel || '').toLowerCase().includes(searchQuery) ||
                    (event.ort || '').toLowerCase().includes(searchQuery) ||
                    (event.veranstalter || '').toLowerCase().includes(searchQuery);
                return matchesCategory && matchesSearch;
            });
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('currentMonth').textContent = monthNames[month] + ' ' + year;
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;
            const daysInMonth = lastDay.getDate();
            const today = new Date();
            let html = '';
            const prevMonth = new Date(year, month, 0);
            const prevMonthDays = prevMonth.getDate();
            for (let i = startDay - 1; i >= 0; i--) {
                html += '<div class="calendar-day other-month"><div class="day-number">' + (prevMonthDays - i) + '</div></div>';
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                const dayEvents = filterEvents(events.filter(e => e.datum === dateStr));
                html += '<div class="calendar-day' + (isToday ? ' today' : '') + '" data-date="' + dateStr + '">';
                html += '<div class="day-number">' + day + '</div><div class="day-events">';
                dayEvents.slice(0, 2).forEach(event => {
                    html += '<div class="day-event ' + (event.kategorie || 'kultur') + '" data-event-id="' + event.id + '">' + event.titel + '</div>';
                });
                if (dayEvents.length > 2) html += '<div class="more-events">+' + (dayEvents.length - 2) + ' weitere</div>';
                html += '</div></div>';
            }
            const totalCells = startDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 1; i <= remainingCells; i++) {
                html += '<div class="calendar-day other-month"><div class="day-number">' + i + '</div></div>';
            }
            document.getElementById('calendarGrid').innerHTML = html;
            document.querySelectorAll('.day-event').forEach(el => {
                el.addEventListener('click', (e) => { e.stopPropagation(); openModal(parseInt(el.dataset.eventId)); });
            });
            document.querySelectorAll('.calendar-day[data-date]').forEach(el => {
                el.addEventListener('click', () => {
                    const dayEvents = filterEvents(events.filter(e => e.datum === el.dataset.date));
                    if (dayEvents.length === 1) openModal(dayEvents[0].id);
                    else if (dayEvents.length > 1) {
                        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                        document.querySelector('[data-view="list"]').classList.add('active');
                        document.getElementById('calendarView').classList.add('hidden');
                        document.getElementById('listView').classList.add('active');
                    }
                });
            });
        }

        function renderListView() {
            const filteredEvents = filterEvents(events);
            const eventList = document.getElementById('eventList');
            if (filteredEvents.length === 0) {
                eventList.innerHTML = '<div class="empty-state"><div class="icon">üìÖ</div><h3>Keine Veranstaltungen gefunden</h3><p>Versuche andere Filter.</p></div>';
                return;
            }
            const grouped = {};
            filteredEvents.sort((a, b) => new Date(a.datum) - new Date(b.datum)).forEach(event => {
                if (!grouped[event.datum]) grouped[event.datum] = [];
                grouped[event.datum].push(event);
            });
            let html = '';
            Object.keys(grouped).forEach(date => {
                const dateObj = new Date(date);
                const dayNum = dateObj.getDate();
                const dayName = dayNames[dateObj.getDay()];
                const monthYear = monthNames[dateObj.getMonth()] + ' ' + dateObj.getFullYear();
                html += '<div class="date-group"><div class="date-header"><div class="day-num">' + dayNum + '</div><div class="day-info"><span class="day-name">' + dayName + '</span><span class="month-year">' + monthYear + '</span></div></div>';
                grouped[date].forEach(event => {
                    html += '<div class="event-card" data-event-id="' + event.id + '"><div class="event-time"><div class="time">' + (event.zeit_start || '-') + '</div>';
                    if (event.zeit_ende) html += '<div class="duration">- ' + event.zeit_ende + '</div>';
                    html += '</div><div class="event-content"><div class="event-title">' + event.titel + '</div><div class="event-meta"><span>üìç ' + (event.ort || 'Vorchdorf') + '</span>';
                    if (event.veranstalter) html += '<span>üë§ ' + event.veranstalter + '</span>';
                    html += '</div><span class="event-category ' + (event.kategorie || 'kultur') + '">' + (categoryNames[event.kategorie] || 'Kultur') + '</span></div></div>';
                });
                html += '</div>';
            });
            eventList.innerHTML = html;
            document.querySelectorAll('.event-card').forEach(el => {
                el.addEventListener('click', () => openModal(parseInt(el.dataset.eventId)));
            });
        }

        function openModal(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            const dateObj = new Date(event.datum);
            const formattedDate = dayNames[dateObj.getDay()] + ', ' + dateObj.getDate() + '. ' + monthNames[dateObj.getMonth()] + ' ' + dateObj.getFullYear();
            document.getElementById('modalTitle').textContent = event.titel;
            document.getElementById('modalCategory').textContent = categoryNames[event.kategorie] || 'Kultur';
            document.getElementById('modalCategory').className = 'event-category ' + (event.kategorie || 'kultur');
            document.getElementById('modalDate').textContent = formattedDate;
            document.getElementById('modalTime').textContent = event.zeit_start ? event.zeit_start + (event.zeit_ende ? ' - ' + event.zeit_ende : '') + ' Uhr' : '-';
            document.getElementById('modalLocation').textContent = event.ort || 'Vorchdorf';
            document.getElementById('modalOrganizer').textContent = event.veranstalter || '-';
            document.getElementById('organizerItem').style.display = event.veranstalter ? 'flex' : 'none';
            document.getElementById('modalDescription').textContent = event.beschreibung || '';
            const websiteBtn = document.getElementById('modalWebsite');
            if (event.website) { websiteBtn.href = event.website; websiteBtn.style.display = 'flex'; }
            else { websiteBtn.style.display = 'none'; }
            document.getElementById('eventModal').dataset.eventId = eventId;
            document.getElementById('eventModal').classList.add('active');
        }

        function closeModal() { document.getElementById('eventModal').classList.remove('active'); }

        function updateStats() {
            const today = new Date();
            const thisMonthEvents = events.filter(e => { const d = new Date(e.datum); return d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear(); });
            const nextWeek = new Date(today); nextWeek.setDate(nextWeek.getDate() + 7);
            const thisWeekEvents = events.filter(e => { const d = new Date(e.datum); return d >= today && d <= nextWeek; });
            document.getElementById('totalEvents').textContent = events.length;
            document.getElementById('thisMonth').textContent = thisMonthEvents.length;
            document.getElementById('thisWeek').textContent = thisWeekEvents.length;
        }

        function downloadICS(event) {
            const dateStr = event.datum.replace(/-/g, '');
            const startTime = (event.zeit_start || '12:00').replace(':', '') + '00';
            const endTime = (event.zeit_ende || '13:00').replace(':', '') + '00';
            const ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Vorchdorf Events//DE\nBEGIN:VEVENT\nDTSTART:' + dateStr + 'T' + startTime + '\nDTEND:' + dateStr + 'T' + endTime + '\nSUMMARY:' + event.titel + '\nLOCATION:' + (event.ort || 'Vorchdorf') + '\nDESCRIPTION:' + (event.beschreibung || '') + '\nEND:VEVENT\nEND:VCALENDAR';
            const blob = new Blob([ics], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = event.titel.replace(/[^a-zA-Z0-9√§√∂√º√Ñ√ñ√ú√ü]/g, '_') + '.ics';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
