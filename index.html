<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Koordinaten f√ºr Direktvermarkter -->
    <script src="company-coordinates.js"></script>

    <!-- QR Code Library (Scan & Generate) -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, public, proxy-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="ETag" content="">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Willkommen in Vorchdorf - Dein Neustart-Guide</title>

    <!-- PWA Meta Tags -->
    <meta name="description"
        content="Alle wichtigen Infos zu Vorchdorf: 247 Betriebe, 61 Vereine, Notfallnummern, Bildungseinrichtungen und mehr!">
    <meta name="theme-color" content="#4a90e2">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vorchdorf">

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json?v=9.7">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png?v=4.0">
    <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png?v=4.0">
    <link rel="apple-touch-icon" href="./icon-192.png?v=4.0">

    <link rel="stylesheet" href="css/styles.css">
    <script src="js/common.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- Header loaded by js/common.js -->

        <!-- PWA Install Button -->
        <div class="install-container">
            <button id="installButton" class="install-button hidden">
                üì± Als App installieren
            </button>
        </div>

        <!-- Search -->
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Suche nach Informationen, Vereinen, Betrieben...">
                <button onclick="performSearch()" class="search-button">üîç Suchen</button>
            </div>
        </div>

        <!-- Back Button - Below Search -->
        <div class="navigation-container">
            <button id="backButton" class="back-button hidden" onclick="goBack()">
                ‚Üê Zur√ºck
            </button>
        </div>



        <!-- Breadcrumb Navigation -->
        <div id="breadcrumb" class="breadcrumb hidden"></div>

        <!-- Main Content (Categories rendered here) -->
        <div id="mainContent"></div>

        <!-- Emergency Banner (always visible on home) -->
        <div id="emergencyBanner" class="emergency-banner hidden">
            <div class="icon">üö®</div>
            <div>
                <h3>Notrufnummern - Immer f√ºr dich da!</h3>
                <div class="emergency-numbers">
                    <a href="tel:141" class="emergency-number">üè•<br>√Ñrztefunkdienst<br>141</a>
                    <a href="tel:122" class="emergency-number">üöí<br>Feuerwehr<br>122</a>
                    <a href="tel:133" class="emergency-number">üëÆ<br>Polizei<br>133</a>
                    <a href="tel:144" class="emergency-number">üöë<br>Rettung<br>144</a>
                </div>
            </div>
        </div>

        <!-- Weather Widget (shown on home below emergency) -->
        <div id="weatherWidget" class="weather-widget hidden"></div>



        <!-- Flohmarkt Container -->
        <div id="flohmarktContainer" class="flohmarkt-container">
            <div class="flohmarkt-header">
                <h2>üõí Flohmarkt der Werberingmitglieder</h2>
                <p>Kaufen & Verkaufen in der Region</p>
                <button class="flohmarkt-info-btn" onclick="openFlohmarktInfo()">‚ÑπÔ∏è Info</button>
            </div>

            <section class="flohmarkt-filter">
                <input type="text" id="flohmarktSearch" class="flohmarkt-search" placeholder="Produkt suchen...">
                <select id="flohmarktCategory" class="flohmarkt-filter-select">
                    <option value="">Alle Kategorien</option>
                    <option value="Schulsachen">üìö Schulsachen</option>
                    <option value="B√ºromaterial">‚úèÔ∏è B√ºromaterial</option>
                    <option value="Spiele">üéÆ Spiele</option>
                    <option value="B√ºcher">üìñ B√ºcher</option>
                    <option value="Handarbeit">üß∂ Handarbeit</option>
                    <option value="Deko">üè† Deko</option>
                    <option value="Elektro">‚ö° Elektro</option>
                    <option value="Kinderartikel">üß∏ Kinderartikel</option>
                    <option value="M√∂bel">ü™ë M√∂bel</option>
                    <option value="Kleidung">üëï Kleidung</option>
                    <option value="Lederwaren">üëú Lederwaren</option>
                    <option value="Rauchzubeh√∂r">üö¨ Rauchzubeh√∂r</option>
                    <option value="Sonstiges">üì¶ Sonstiges</option>
                </select>
                <select id="flohmarktVerkaeifer" class="flohmarkt-filter-select">
                    <option value="">Alle Verk√§ufer</option>
                    <option value="Trafik Fischer">üë§ Trafik Fischer</option>
                </select>
            </section>

            <div class="flohmarkt-stats" id="flohmarktStats"></div>

            <div class="flohmarkt-grid" id="flohmarktGrid"></div>

            <div class="flohmarkt-empty" id="flohmarktEmpty" style="display: none;">
                <div class="flohmarkt-empty-icon">üîç</div>
                <h3>Keine Produkte gefunden</h3>
                <p>Versuche eine andere Suche oder Kategorie</p>
            </div>

            <!-- Footer im Flohmarkt unten -->
            <!-- Footer loaded by js/common.js (global) -->
        </div>

        <!-- Flohmarkt Modal -->
        <div class="flohmarkt-modal-overlay" id="flohmarktModalOverlay">
            <div class="flohmarkt-modal" id="flohmarktModal">
                <button class="flohmarkt-modal-close" id="flohmarktModalClose">‚úï</button>
                <div class="flohmarkt-modal-images" id="flohmarktModalImages">
                    <img src="" alt="" class="flohmarkt-modal-image" id="flohmarktModalImage">
                    <button class="flohmarkt-modal-image-nav prev" id="flohmarktPrevImage">‚Äπ</button>
                    <button class="flohmarkt-modal-image-nav next" id="flohmarktNextImage">‚Ä∫</button>
                    <div class="flohmarkt-modal-image-dots" id="flohmarktModalDots"></div>
                </div>
                <div class="flohmarkt-modal-content">
                    <span class="flohmarkt-modal-category" id="flohmarktModalCategory"></span>
                    <h2 class="flohmarkt-modal-title" id="flohmarktModalTitle"></h2>
                    <div class="flohmarkt-modal-price" id="flohmarktModalPrice"></div>
                    <p class="flohmarkt-modal-description" id="flohmarktModalDescription"></p>
                    <div class="flohmarkt-modal-seller">
                        <div class="flohmarkt-modal-seller-avatar" id="flohmarktModalAvatar"></div>
                        <div class="flohmarkt-modal-seller-info">
                            <h4 id="flohmarktModalSellerName"></h4>
                            <small>Verk√§ufer/in</small>
                        </div>
                    </div>
                    <a href="" class="flohmarkt-modal-contact-btn" id="flohmarktModalContactBtn">
                        ‚úâÔ∏è Verk√§ufer kontaktieren
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Regionale Produkte Container -->
    <div id="rpContainer" class="rp-container">
        <!-- Header -->
        <div class="rp-header">
            <h2>üçé Regionale Produkte aus der Region Vorchdorf</h2>
            <button class="rp-info-btn" onclick="openRPInfo()">‚ÑπÔ∏è Info</button>
        </div>

        <!-- Back Button -->
        <button id="rpBackBtn" class="rp-back-btn hidden" onclick="rpGoBack()">‚Üê Zur√ºck</button>

        <!-- MAIN VIEW: Categories -->
        <div id="rpCategoriesView">
            <!-- Info Box (Immer sichtbar in der Hauptansicht) -->
            <div id="rpMainInfoBox" class="info-item" style="margin-bottom: 20px;">
                <h4>üçé Qualit√§t aus unserer Region</h4>
                <p>In Vorchdorf produzieren viele engagierte Betriebe hochwertige Lebensmittel. Hier finden Sie eine
                    √úbersicht aller Anbieter und Produkte direkt vom Erzeuger.</p>
            </div>
            <h3 class="rp-section-title">Kategorien</h3>
            <div id="rpCategoryGrid" class="rp-category-grid"></div>

            <!-- Trennlinie -->
            <div class="rp-section-divider"></div>

            <!-- √úberschrift -->
            <h3 class="rp-section-title" style="margin-bottom: 25px;">üè° Unsere Direktvermarkter</h3>

            <!-- Bauernm√§rkte & Direktvermarkter Kacheln -->
            <div class="rp-info-tiles">
                <div class="rp-info-tile" onclick="window.open('bauernmaerkte.html', '_self')">
                    <div class="rp-info-tile-icon">ü•ï</div>
                    <h3 class="rp-info-tile-title">Bauernm√§rkte</h3>
                    <p class="rp-info-tile-text">11 M√§rkte in der Region - jeden Tag frische Produkte!</p>
                    <div class="rp-info-tile-arrow">‚Üí</div>
                </div>

                <div class="rp-info-tile" onclick="rpShowDirectMarketersAZ()">
                    <div class="rp-info-tile-icon">üìã</div>
                    <h3 class="rp-info-tile-title">Direktvermarkter A-Z</h3>
                    <p class="rp-info-tile-text">Alle regionalen Anbieter alphabetisch nach Orten sortiert</p>
                    <div class="rp-info-tile-arrow">‚Üí</div>
                </div>
            </div>
            <!-- COMPANIES VIEW (hidden by default) -->
            <div id="rpCompaniesView" class="hidden">
                <h3 id="rpCompaniesTitle" class="rp-section-title"></h3>
                <div id="rpCompaniesGrid" class="rp-companies-grid"></div>
            </div>

            <!-- PRODUCTS SECTION (ganz am Ende) -->
            <div id="rpProductsSection" class="rp-products-section">
                <h3 class="rp-section-title">üõí Alle Produkte</h3>

                <!-- Filters -->
                <div class="rp-filters">
                    <input type="text" id="rpSearchInput" class="rp-search-input"
                        placeholder="üîç Produkte durchsuchen...">
                    <select id="rpCategoryFilter" class="rp-filter-select">
                        <option value="">Alle Kategorien</option>
                    </select>
                    <select id="rpCompanyFilter" class="rp-filter-select">
                        <option value="">Alle Firmen</option>
                    </select>
                </div>

                <!-- Products Grid -->
                <div id="rpProductsGrid" class="rp-products-grid"></div>

                <!-- Empty State -->
                <div id="rpEmptyState" class="hidden"
                    style="text-align: center; padding: 40px; color: var(--text-light);">
                    <div style="font-size: 3rem; margin-bottom: 15px;">üîç</div>
                    <h3>Keine Produkte gefunden</h3>
                    <p>Versuche eine andere Suche oder Kategorie</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Stempelpass Container (Ausserhalb von rpContainer!) -->
    <div id="stempelContainer" class="stempel-container">
        <!-- Info Box (Neu) -->
        <div id="stempelMainInfoBox" class="info-item" style="margin-bottom: 20px;">
            <h4>üéüÔ∏è "DIGITAL & REGIONAL" - Sammeln & profitieren</h4>
        </div>

        <div id="stempelGrid" class="stempel-grid">
            <!-- P√§sse werden dynamisch geladen -->
        </div>

        <div id="stempelEmpty" class="hidden" style="text-align: center; padding: 50px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üéüÔ∏è</div>
            <h3>Keine aktiven P√§sse gefunden</h3>
            <p>Aktuell gibt es keine laufenden Stempel-Aktionen.</p>
        </div>

        <!-- Sicherungs-Information -->
        <div id="stempelBackupInfo" class="stempel-backup-box hidden">
            <div class="stempel-backup-content">
                <h4>üîí Einmalige Sicherung empfohlen</h4>
                <p>Speichern Sie Ihren Backup-QR-Code einmalig. Damit sind <strong>alle aktuellen und zuk√ºnftigen
                        Stempel</strong> bei einem Handywechsel wiederherstellbar.</p>
            </div>
            <button class="stempel-backup-btn" onclick="openBackupModal()">Sicherungs-QR</button>
        </div>
    </div>

    <!-- Backup QR Modal -->
    <div id="backupModal" class="backup-modal-overlay">
        <div class="backup-modal">
            <button class="backup-modal-close" onclick="closeBackupModal()">‚úï</button>
            <h3 style="color: var(--primary);">Ihre Sicherung</h3>
            <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                Machen Sie einen Screenshot von diesem QR-Code. Mit diesem k√∂nnen Sie <strong>alle Ihre Stempel aller
                    P√§sse</strong> jederzeit wiederherstellen - auch zuk√ºnftige P√§sse!
            </p>

            <div id="backupQrCanvas"></div>

            <div class="backup-user-id" id="backupUserIdDisplay">vch_...</div>

            <p style="font-size: 0.8rem; color: #888;">
                ‚ö†Ô∏è Geben Sie diesen Code niemals an andere weiter. Er ist Ihre anonyme Identit√§t.
            </p>

            <button class="stempel-scan-btn" onclick="window.print()" style="background: #666;">
                üñ®Ô∏è PDF / Drucken
            </button>
        </div>
    </div>

    <!-- QR Scanner Overlay -->
    <div id="scannerOverlay" class="scanner-overlay">
        <button class="scanner-close" onclick="closeScanner()">‚úï</button>
        <div style="color: white; margin-bottom: 20px; text-align: center; padding: 0 20px;">
            <h3>QR-Code scannen</h3>
            <p>Richte die Kamera auf den Stempel-Code im Betrieb.</p>
        </div>
        <div id="qr-reader"></div>
    </div>

    <!-- Footer loaded by js/common.js -->
    </div> <!-- Ende app-container -->

    <!-- Regionale Produkte Modal -->
    <div class="rp-modal-overlay" id="rpModalOverlay">
        <div class="rp-modal" id="rpModal">
            <button class="rp-modal-close" id="rpModalClose">‚úï</button>

            <div class="rp-modal-images" id="rpModalImages">
                <img id="rpModalImage" src="" alt="" class="rp-modal-image">
                <button id="rpPrevImage" class="rp-modal-nav prev">‚Äπ</button>
                <button id="rpNextImage" class="rp-modal-nav next">‚Ä∫</button>
            </div>

            <div class="rp-modal-content">
                <span id="rpModalCategory" class="rp-product-category-tag"></span>
                <h2 id="rpModalTitle" class="rp-modal-title"></h2>
                <div id="rpModalPrice" class="rp-modal-price"></div>
                <p id="rpModalDescription" class="rp-modal-description"></p>

                <div style="margin-top: 20px;">
                    <strong>Anbieter:</strong>
                    <div id="rpModalCompanyName" style="font-size: 1.1rem; color: var(--primary); margin-top: 5px;">
                    </div>
                    <a id="rpModalContactBtn" href="#" class="rp-modal-contact-btn"
                        style="margin-top: 15px; display: block;">
                        üìß Anbieter kontaktieren
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Flohmarkt Daten
        const FLOHMARKT_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1CrRpZwA19JcKfZsfbm9yZ3r_lEup-piI-QL4mY2kHnc/export?format=csv';

        let flohmarktAllProducts = [];
        let flohmarktCurrentProduct = null;
        let flohmarktCurrentImageIndex = 0;
        let showOnlyWerbering = true; // Standardm√§√üig nur Werbering zeigen

        const flohmarktCategoryIcons = {
            'Schulsachen': 'üìö',
            'B√ºromaterial': '‚úèÔ∏è',
            'Spiele': 'üéÆ',
            'B√ºcher': 'üìñ',
            'Handarbeit': 'üß∂',
            'Deko': 'üè†',
            'Elektro': '‚ö°',
            'Kinderartikel': 'üß∏',
            'M√∂bel': 'ü™ë',
            'Kleidung': 'üëï',
            'Lederwaren': 'üëú',
            'Rauchzubeh√∂r': 'üö¨',
            'Sonstiges': 'üì¶'
        };

        // Robuster CSV Parser mit Trennzeichen-Erkennung und Fallback
        function parseCSV(text) {
            // Detect delimiter based on first line
            const firstLine = text.split('\n')[0];
            const delimiter = firstLine.includes(';') ? ';' : ',';

            const arr = [];
            let quote = false;
            let col = 0, row = 0;

            // Normalize line endings
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

            for (let c = 0; c < text.length; c++) {
                let cc = text[c];
                let nc = text[c + 1];
                arr[row] = arr[row] || [];
                arr[row][col] = arr[row][col] || '';

                if (cc == '"') {
                    if (quote && nc == '"') {
                        arr[row][col] += cc; ++c;
                    } else {
                        quote = !quote;
                    }
                }
                else if (cc == delimiter && !quote) { ++col; }
                else if (cc == '\n' && !quote) { ++row; col = 0; }
                else { arr[row][col] += cc; }
            }

            // Clean headers
            const headers = arr[0].map(h => h.trim().replace(/^[\uFEFF\u200B]/, ''));
            const result = [];

            for (let i = 1; i < arr.length; i++) {
                const rowData = arr[i];
                if (rowData.length < 2) continue;

                const obj = {};

                // Strategy 1: Standard Map
                headers.forEach((h, idx) => {
                    obj[h] = rowData[idx] ? rowData[idx].trim() : '';
                });

                // Strategy 2: Fallback for critical fields if empty (using fixed indices based on Google Sheet structure)
                // 0:Timestamp, 1:Status, 2:Name, 3:Category, 4:Price, 5:Desc, 6:Firm, 7:Email, 8:Img1
                if (!obj['Produktname'] && rowData[2]) obj['Produktname'] = rowData[2];
                if (!obj['Kategorie'] && rowData[3]) obj['Kategorie'] = rowData[3];
                if (!obj['Preis in Euro'] && rowData[4]) obj['Preis in Euro'] = rowData[4];
                if (!obj['Firmenname'] && rowData[6]) obj['Firmenname'] = rowData[6];

                // Fallback for Address (Adresse)
                if (!obj['adresse']) {
                    const addressCandidates = ['Adresse', 'Anschrift', 'Strasse', 'Stra√üe', 'Standort'];
                    for (const key of addressCandidates) {
                        if (obj[key]) {
                            obj['adresse'] = obj[key];
                            break;
                        }
                    }
                    // If still empty, try to find a column that looks like an address (contains digit and zip)
                    if (!obj['adresse']) {
                        // Look through all fields
                        for (const k in obj) {
                            if (obj[k] && typeof obj[k] === 'string' && obj[k].match(/\d{4}\s+/)) {
                                obj['adresse'] = obj[k];
                                break;
                            }
                        }
                    }
                }

                // Flexible Image Search
                if (!obj['Bild 1 Url von Imgur']) {
                    // Try column 8 or find any http link
                    if (rowData[8] && rowData[8].startsWith('http')) obj['Bild 1 Url von Imgur'] = rowData[8];
                }

                result.push(obj);
            }
            return result;
        }

        async function loadFlohmarktProducts() {
            try {
                // Footer nicht mehr verstecken!

                // const proxyUrl = 'https://api.allorigins.win/raw?url=';
                // let response;

                try {
                    response = await fetch(FLOHMARKT_SHEET_URL);
                } catch (e) {
                    console.error('Fetch error:', e);
                }

                if (!response || !response.ok) {
                    throw new Error('Network response was not ok');
                }

                const csv = await response.text();
                const products = parseCSV(csv);

                // Neueste zuerst
                products.reverse();

                flohmarktAllProducts = products;

                renderFlohmarktProducts(flohmarktAllProducts);

                renderFlohmarktProducts(flohmarktAllProducts);
            } catch (error) {
                console.error('Fehler beim Laden des Flohmarkts:', error);
                document.getElementById('flohmarktGrid').innerHTML = `
                    <div class="flohmarkt-empty" style="display: block; grid-column: 1/-1;">
                        <div class="flohmarkt-empty-icon">‚ö†Ô∏è</div>
                        <h3>Fehler beim Laden</h3>
                        <p>Bitte sp√§ter erneut versuchen</p>
                    </div>
                `;
            }
        }

        // Flohmarkt Produkte rendern
        function cleanImageUrl(url) {
            if (!url || typeof url !== 'string') return '';

            let cleaned = url.trim();

            // Entferne HTML-Tags und Whitespace
            cleaned = cleaned.replace(/<[^>]*>/g, '').trim();

            // Wenn es ein href-Link ist, extrahiere die URL
            if (cleaned.includes('href=')) {
                const match = cleaned.match(/href=["']([^"']+)["']/i);
                if (match && match[1]) {
                    cleaned = match[1].trim();
                }
            }

            // Entferne f√ºhrende/nachfolgende Quotes
            cleaned = cleaned.replace(/^["']|["']$/g, '').trim();

            // Pr√ºfe ob es eine echte URL ist (muss mit http anfangen)
            if (cleaned && (cleaned.startsWith('http://') || cleaned.startsWith('https://'))) {
                return cleaned;
            }

            return '';
        }

        function renderFlohmarktProducts(products) {
            const grid = document.getElementById('flohmarktGrid');
            const emptyState = document.getElementById('flohmarktEmpty');
            const stats = document.getElementById('flohmarktStats');

            if (products.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                stats.textContent = '';
                return;
            }

            emptyState.style.display = 'none';
            stats.textContent = `${products.length} Produkt${products.length !== 1 ? 'e' : ''} gefunden`;

            grid.innerHTML = products.map((product, index) => {
                // EXTREM ROBUSTE BILD-EXTRAKTION
                let imageUrl = '';

                // 1. Suche in bekannten Spalten
                const knownFields = ['Bild 1 Url von Imgur', 'Bild 1', 'Bild', 'Bild 2', 'Bild 3', 'Bild 4'];
                for (const field of knownFields) {
                    if (product[field] && String(product[field]).trim().startsWith('http')) {
                        imageUrl = String(product[field]).trim();
                        break;
                    }
                }

                // 2. Fallback: Suche in ALLEN Feldern nach einer URL (falls Spalten verschoben)
                if (!imageUrl) {
                    for (let key in product) {
                        const val = String(product[key]).trim();
                        if (val.startsWith('http') && (val.includes('imgur.com') || val.match(/\.(jpg|jpeg|png|gif|webp)$/i))) {
                            imageUrl = val;
                            break;
                        }
                    }
                }

                if (imageUrl) {
                    // Falls es HTML enth√§lt, extrahiere reine URL
                    if (imageUrl.includes('href=')) {
                        const m = imageUrl.match(/href=["']([^"']+)["']/);
                        if (m) imageUrl = m[1];
                    }

                    // Imgur-Optimierung
                    if (imageUrl.includes('imgur.com/')) {
                        // Bereinige Album/Gallery-Links
                        imageUrl = imageUrl.replace(/\/(a|gallery)\//, '/');

                        // Stelle sicher dass es i.imgur.com ist und eine Endung hat
                        if (!imageUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                            // Extrahiere ID (letzter Teil der URL)
                            const parts = imageUrl.trim().split('/');
                            let lastPart = parts[parts.length - 1];
                            if (lastPart === '') lastPart = parts[parts.length - 2];
                            let id = lastPart.split(/[?#.]/)[0];
                            if (id) {
                                imageUrl = `https://i.imgur.com/${id}.jpg`;
                            }
                        } else {
                            // Nur Domain anpassen falls Endung schon da
                            imageUrl = imageUrl.replace('//imgur.com', '//i.imgur.com');
                        }
                    }
                }

                const category = product.Kategorie || 'Sonstiges';
                const icon = flohmarktCategoryIcons[category] || 'üì¶';
                const price = flohmarktFormatPrice(product['Preis in Euro']);
                const seller = product.Firmenname || 'Anonym';

                return `
                    <article class="flohmarkt-product-card" onclick="openFlohmarktModal(${index})">
                        ${imageUrl ?
                        `<img src="${imageUrl}" alt="${product.Produktname}" class="flohmarkt-product-image" onerror="this.outerHTML='<div class=\\'flohmarkt-product-placeholder\\'>${icon}</div>'">` :
                        `<div class="flohmarkt-product-placeholder">${icon}</div>`
                    }
                        <div class="flohmarkt-product-info">
                            <span class="flohmarkt-product-category">${icon} ${category}</span>
                            <h3 class="flohmarkt-product-title">${product.Produktname || 'Ohne Titel'}</h3>
                            <div class="flohmarkt-product-price">${price}</div>
                            <div class="flohmarkt-product-seller">üë§ ${seller}</div>
                        </div>
                    </article>
                `;
            }).join('');
        }

        // Preis formatieren
        function flohmarktFormatPrice(price) {
            if (!price) return 'Preis auf Anfrage';
            const num = parseFloat(price.replace(',', '.').replace(/[^0-9.]/g, ''));
            if (isNaN(num)) return price;
            return `‚Ç¨ ${num.toFixed(2).replace('.', ',')}`;
        }

        // Filter
        function filterFlohmarktProducts() {
            const search = document.getElementById('flohmarktSearch').value.toLowerCase();
            const category = document.getElementById('flohmarktCategory').value;
            const verkaeufer = document.getElementById('flohmarktVerkaeifer').value;

            const filtered = flohmarktAllProducts.filter(product => {
                const matchesSearch = !search ||
                    (product.Produktname && product.Produktname.toLowerCase().includes(search)) ||
                    (product.Beschreibung && product.Beschreibung.toLowerCase().includes(search));

                const matchesCategory = !category || product.Kategorie === category;
                const matchesVerkaeufer = !verkaeufer || product.Firmenname === verkaeufer;

                return matchesSearch && matchesCategory && matchesVerkaeufer;
            });

            renderFlohmarktProducts(filtered);
        }

        // Flohmarkt Modal √∂ffnen
        function openFlohmarktModal(index) {
            const search = document.getElementById('flohmarktSearch').value.toLowerCase();
            const category = document.getElementById('flohmarktCategory').value;
            const verkaeufer = document.getElementById('flohmarktVerkaeifer').value;
            // Gefilterte Liste verwenden
            const filtered = flohmarktAllProducts.filter(product => {
                const matchesSearch = !search ||
                    (product.Produktname && product.Produktname.toLowerCase().includes(search)) ||
                    (product.Beschreibung && product.Beschreibung.toLowerCase().includes(search));
                const matchesCategory = !category || product.Kategorie === category;
                const matchesVerkaeufer = !verkaeufer || product.Firmenname === verkaeufer;
                return matchesSearch && matchesCategory && matchesVerkaeufer;
            });

            flohmarktCurrentProduct = filtered[index];
            flohmarktCurrentImageIndex = 0;

            if (!flohmarktCurrentProduct) return;

            // Bilder sammeln und direkt cleanieren
            const images = [
                flohmarktCurrentProduct['Bild 1 Url von Imgur'],
                flohmarktCurrentProduct['Bild 2'],
                flohmarktCurrentProduct['Bild 3'],
                flohmarktCurrentProduct['Bild 4']
            ].map(url => {
                if (!url) return '';
                let cleaned = url.trim();
                if (cleaned.includes('href=')) {
                    const m = cleaned.match(/href=["']([^"']+)["']/);
                    cleaned = m ? m[1] : '';
                }
                if (!cleaned.startsWith('http')) {
                    return '';
                }
                // Repariere unvollst√§ndige imgur.com URLs
                if (cleaned.includes('imgur.com/') && !cleaned.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                    const match = cleaned.match(/imgur\.com\/([a-zA-Z0-9]+)$/);
                    if (match) {
                        cleaned = `https://i.imgur.com/${match[1]}.jpg`;
                    }
                }
                return cleaned;
            }).filter(url => url);

            flohmarktCurrentProduct.images = images;

            // Modal bef√ºllen
            const cat = flohmarktCurrentProduct.Kategorie || 'Sonstiges';
            const icon = flohmarktCategoryIcons[cat] || 'üì¶';

            document.getElementById('flohmarktModalCategory').textContent = `${icon} ${cat}`;
            document.getElementById('flohmarktModalTitle').textContent = flohmarktCurrentProduct.Produktname || 'Ohne Titel';
            document.getElementById('flohmarktModalPrice').textContent = flohmarktFormatPrice(flohmarktCurrentProduct['Preis in Euro']);
            document.getElementById('flohmarktModalDescription').textContent = flohmarktCurrentProduct.Beschreibung || 'Keine Beschreibung vorhanden.';

            const sellerName = flohmarktCurrentProduct.Firmenname || 'Anonym';
            document.getElementById('flohmarktModalSellerName').textContent = sellerName;
            document.getElementById('flohmarktModalAvatar').textContent = sellerName.charAt(0).toUpperCase();

            const email = flohmarktCurrentProduct['Deine E-mail'] || 'kontakt@vorchdorf.at';
            // Cleaniere Image-URL direkt
            let imageUrl = flohmarktCurrentProduct['Bild 1 Url von Imgur'] || '';
            if (imageUrl) {
                imageUrl = imageUrl.trim();
                if (imageUrl.includes('href=')) {
                    const m = imageUrl.match(/href=["']([^"']+)["']/);
                    imageUrl = m ? m[1] : '';
                }
                if (!imageUrl.startsWith('http')) {
                    imageUrl = '';
                }
            }

            const subject = encodeURIComponent(`Anfrage zu: ${flohmarktCurrentProduct.Produktname}`);

            // Baue Email-Body mit allen Infos + Base64-Bild
            let emailBody = `Hallo ${sellerName},

ich interessiere mich f√ºr Ihr Produkt "${flohmarktCurrentProduct.Produktname}" auf dem Vorchdorf Flohmarkt.

Produktbeschreibung: ${flohmarktCurrentProduct.Beschreibung || 'Keine Angabe'}

Mit freundlichen Gr√º√üen`;

            // Wenn Bild vorhanden, versuche es zu laden und als Base64 einzubinden
            if (imageUrl) {
                // Starte asynchrones Laden des Bildes - wird in openEmailPreviewModal verwendet
                loadImageAsBase64(imageUrl).then(base64Image => {
                    if (base64Image) {
                        window.flohmarktEmailImageBase64 = base64Image;
                    }
                });
            }

            // Click-Handler f√ºr Contact-Button - √∂ffne Email-Modal
            document.getElementById('flohmarktModalContactBtn').onclick = function (e) {
                e.preventDefault();
                closeFlohmarktModal();
                openEmailPreviewModal(email, subject, emailBody, imageUrl, sellerName);
            };
            document.getElementById('flohmarktModalContactBtn').href = 'javascript:void(0)'; // Verhindere default-Link

            // Bilder
            updateFlohmarktModalImage();
            updateFlohmarktImageDots();

            // Navigation anzeigen/verstecken
            const hasMultipleImages = images.length > 1;
            document.getElementById('flohmarktPrevImage').style.display = hasMultipleImages ? 'block' : 'none';
            document.getElementById('flohmarktNextImage').style.display = hasMultipleImages ? 'block' : 'none';

            document.getElementById('flohmarktModalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function updateFlohmarktModalImage() {
            const images = flohmarktCurrentProduct.images || [];
            const container = document.getElementById('flohmarktModalImages');
            const img = document.getElementById('flohmarktModalImage');

            if (images.length > 0 && images[flohmarktCurrentImageIndex]) {
                img.src = images[flohmarktCurrentImageIndex];
                img.style.display = 'block';
            } else {
                const cat = flohmarktCurrentProduct.Kategorie || 'Sonstiges';
                const icon = flohmarktCategoryIcons[cat] || 'üì¶';
                container.innerHTML = `
                    <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:4rem;background:linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);">${icon}</div>
                `;
            }
        }

        function updateFlohmarktImageDots() {
            const images = flohmarktCurrentProduct.images || [];
            const dotsContainer = document.getElementById('flohmarktModalDots');

            if (images.length <= 1) {
                dotsContainer.innerHTML = '';
                return;
            }

            dotsContainer.innerHTML = images.map((_, i) => `
                <button class="flohmarkt-modal-image-dot ${i === flohmarktCurrentImageIndex ? 'active' : ''}" onclick="goToFlohmarktImage(${i})"></button>
            `).join('');
        }

        function goToFlohmarktImage(index) {
            flohmarktCurrentImageIndex = index;
            updateFlohmarktModalImage();
            updateFlohmarktImageDots();
        }

        // ============================================
        // REGIONALE PRODUKTE LOGIC
        // ============================================
        const RP_PRODUCTS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1a-aYkGryPJiXjhp-6hPOrjRYHz199x8cy1t1mg6RVIE/export?format=csv&gid=0';
        const RP_COMPANIES_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1a-aYkGryPJiXjhp-6hPOrjRYHz199x8cy1t1mg6RVIE/export?format=csv&gid=760538274';

        const rpCategories = {
            'Obst & Beeren': 'üçé',
            'Gem√ºse & Kartoffeln': 'ü•ï',
            'Fleisch & Wurst': 'ü•©',
            'Milch & K√§se': 'üßÄ',
            'Eier & Gefl√ºgel': 'ü•ö',
            'Brot & S√º√üwaren': 'ü•ñ',
            'Honig & Imkereiprodukte': 'üçØ',
            '√ñle & Essig': 'ü´í',
            'Mehl & Getreide': 'üåæ',
            'Kr√§uter & Gew√ºrze': 'üåø',
            'S√§fte & Getr√§nke': 'üßÉ',
            'Eingelegtes & Konserven': 'ü•´',
            'Fisch': 'üêü'
        };

        let rpAllProducts = [];
        let rpAllCompanies = [];
        let rpCurrentView = 'categories';
        let rpCurrentCategory = null;
        let rpCurrentProduct = null;
        let rpCurrentImageIndex = 0;

        // Laden der Produkte
        async function loadRPProducts() {
            try {
                const response = await fetch(RP_PRODUCTS_SHEET_URL);
                const csv = await response.text();
                rpAllProducts = parseCSV(csv);

                console.log('‚úì Regionale Produkte geladen:', rpAllProducts.length);
                return rpAllProducts;
            } catch (error) {
                console.error('Fehler beim Laden der Produkte:', error);
                return [];
            }
        }

        // Laden der Firmen
        async function loadRPCompanies() {
            try {
                const response = await fetch(RP_COMPANIES_SHEET_URL);
                const csv = await response.text();
                rpAllCompanies = parseCSV(csv);

                console.log('‚úì Regionale Produkte Firmen geladen:', rpAllCompanies.length);
                return rpAllCompanies;
            } catch (error) {
                console.error('Fehler beim Laden der Firmen:', error);
                return [];
            }
        }

        // Initialisierung
        async function initializeRP() {
            await Promise.all([
                loadRPProducts(),
                loadRPCompanies()
            ]);

            renderRPCategories();
            populateRPFilters();
            renderRPProducts();
            renderDirectMarketers(); // NEU!
        }

        // Kategorien anzeigen
        function renderRPCategories() {
            const grid = document.getElementById('rpCategoryGrid');

            // Z√§hle Firmen pro Kategorie
            const categoryCounts = {};
            Object.keys(rpCategories).forEach(cat => {
                categoryCounts[cat] = rpAllCompanies.filter(company => company[cat] === 'x').length;
            });

            // Sortiere Kategorien alphabetisch
            const sortedCategories = Object.keys(rpCategories).sort();

            grid.innerHTML = sortedCategories.map(category => {
                const icon = rpCategories[category];
                const count = categoryCounts[category] || 0;
                const countClass = count === 0 ? 'zero' : '';

                return `
            <div class="rp-category-card" onclick="rpShowCompanies('${category}')">
                <span class="rp-category-icon">${icon}</span>
                <div class="rp-category-name">${category}</div>
                <div class="rp-category-count ${countClass}">${count} ${count === 1 ? 'Anbieter' : 'Anbieter'}</div>
            </div>
        `;
            }).join('');
        }

        // Firmen anzeigen
        function rpShowCompanies(category) {
            rpCurrentCategory = category;
            rpCurrentView = 'companies';

            // Views umschalten
            document.getElementById('rpCategoriesView').classList.add('hidden');
            document.getElementById('rpCompaniesView').classList.remove('hidden');
            document.getElementById('rpProductsSection').classList.add('hidden');
            document.getElementById('rpBackBtn').classList.remove('hidden');
            document.getElementById('backButton').classList.remove('hidden');
            document.getElementById('rpMainInfoBox').classList.add('hidden'); // Verstecke Info in Unterkategorien

            // Firmen f√ºr diese Kategorie filtern
            const companies = rpAllCompanies
                .filter(company => company[category] === 'x')
                .sort((a, b) => a.Firma.localeCompare(b.Firma, 'de'));

            // Titel setzen
            const icon = rpCategories[category];
            document.getElementById('rpCompaniesTitle').innerHTML = `${icon} ${category} - ${companies.length} Anbieter`;

            // Grid rendern
            const grid = document.getElementById('rpCompaniesGrid');
            grid.innerHTML = companies.map(company => {

                return `
            <div class="rp-company-card">
                <div class="rp-company-name">
                    üè¢ ${company.Firma} ${company.homepage ? ' <span style="font-size: 0.8em; margin-left: 5px;">üåê</span>' : ''}
                </div>
                
                ${company.adresse ? `
                    <div class="rp-company-info-row">
                        <span class="rp-company-info-icon">üìç</span>
                        <span class="rp-company-info-text">${company.adresse}</span>
                    </div>
                ` : ''}
                
                ${company.telefonnummer ? `
                    <div class="rp-company-info-row">
                        <span class="rp-company-info-icon">üìû</span>
                        <span class="rp-company-info-text">
                            <a href="tel:${company.telefonnummer.replace(/\s/g, '')}" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                                ${company.telefonnummer}
                            </a>
                        </span>
                    </div>
                ` : ''}
                
                ${company.email ? `
                    <div class="rp-company-info-row">
                        <span class="rp-company-info-icon">üìß</span>
                        <span class="rp-company-info-text">
                            <a href="mailto:${company.email}" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                                ${company.email}
                            </a>
                      </span>
    </div>
` : ''}
                
                ${company.√∂ffnungszeiten ? `
                    <div class="rp-company-info-row">
                        <span class="rp-company-info-icon">üïê</span>
                        <span class="rp-company-info-text"><strong>√ñffnungszeiten:</strong> ${company.√∂ffnungszeiten}</span>
                    </div>
                ` : ''}
                
                ${company.verkaufsdaten ? `
                    <div class="rp-company-info-row">
                        <span class="rp-company-info-icon">üè™</span>
                        <span class="rp-company-info-text">
                            <strong>Verkauf auch bei:</strong><br>
                            ${company.verkaufsdaten.split(/(?=Bauernmarkt|Almtaler)/g)
                            .filter(s => s.trim())
                            .map(s => '‚Ä¢ ' + s.trim())
                            .join('<br>')}
                        </span>
                    </div>
                ` : ''}
                
                ${company.zusatzinfos ? `
                    <div class="rp-company-info-row">
                        <span class="rp-company-info-icon">‚ÑπÔ∏è</span>
                        <span class="rp-company-info-text">${company.zusatzinfos}</span>
                    </div>
                ` : ''}
                
                ${company.homepage && company.homepage.trim() ? `
                    <a href="${company.homepage.startsWith('http') ? company.homepage : 'https://' + company.homepage}" 
                       target="_blank" 
                       class="rp-company-website">
                        üåê Website besuchen
                    </a>
                ` : ''}
            </div>
        `;
            }).join('');

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Filter bef√ºllen
        function populateRPFilters() {
            // Kategorie-Filter
            const categoryFilter = document.getElementById('rpCategoryFilter');
            const sortedCategories = Object.keys(rpCategories).sort();
            categoryFilter.innerHTML = '<option value="">Alle Kategorien</option>' +
                sortedCategories.map(cat => `<option value="${cat}">${rpCategories[cat]} ${cat}</option>`).join('');

            // Firmen-Filter
            const companyFilter = document.getElementById('rpCompanyFilter');
            const uniqueCompanies = [...new Set(rpAllProducts.map(p => p.Firmenname).filter(f => f))].sort();
            companyFilter.innerHTML = '<option value="">Alle Firmen</option>' +
                uniqueCompanies.map(company => `<option value="${company}">${company}</option>`).join('');
        }

        // Produkte anzeigen & filtern
        function renderRPProducts() {
            const search = document.getElementById('rpSearchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('rpCategoryFilter').value;
            const companyFilter = document.getElementById('rpCompanyFilter').value;

            const filtered = rpAllProducts.filter(product => {
                const matchesSearch = !search ||
                    (product.Produktname && product.Produktname.toLowerCase().includes(search)) ||
                    (product.Beschreibung && product.Beschreibung.toLowerCase().includes(search)) ||
                    (product.Firmenname && product.Firmenname.toLowerCase().includes(search));

                const matchesCategory = !categoryFilter || product.Kategorie === categoryFilter;
                const matchesCompany = !companyFilter || product.Firmenname === companyFilter;

                return matchesSearch && matchesCategory && matchesCompany;
            });

            const grid = document.getElementById('rpProductsGrid');
            const emptyState = document.getElementById('rpEmptyState');

            if (filtered.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            grid.innerHTML = filtered.map((product, index) => {
                const images = extractRPImages(product);
                const icon = rpCategories[product.Kategorie] || 'üçé';

                return `
            <div class="rp-product-card" onclick="rpShowProduct(${rpAllProducts.indexOf(product)})">
                ${images.length > 0 ?
                        `<img src="${images[0]}" alt="${product.Produktname}" class="rp-product-image" onerror="this.outerHTML='<div class=\\'rp-product-placeholder\\'>${icon}</div>'">` :
                        `<div class="rp-product-placeholder">${icon}</div>`
                    }
                <div class="rp-product-info">
                    <span class="rp-product-category-tag">${icon} ${product.Kategorie}</span>
                    <h3 class="rp-product-title">${product.Produktname || 'Unbenannt'}</h3>
                    <div class="rp-product-price">${product['Preis in Euro'] ? product['Preis in Euro'] + ' ‚Ç¨' : 'Preis auf Anfrage'}</div>
                    <div class="rp-product-company-name">üè¢ ${product.Firmenname || 'Privat'}</div>
                </div>
            </div>
        `;
            }).join('');
        }
        function renderDirectMarketers() {
            const grid = document.getElementById('rpDirectMarketersGrid');

            // Extrahiere Ort aus Adresse
            const companiesByLocation = {};

            rpAllCompanies.forEach(company => {
                let location = 'Sonstige';
                if (company.adresse) {
                    // Handle multiple separators: dash or comma
                    const parts = company.adresse.split(/[-,]/);
                    if (parts.length > 0) {
                        const zipCity = parts[0].trim();
                        const match = zipCity.match(/(\d{4})\s+(.+)/);
                        if (match && match[2]) {
                            location = match[2].trim();
                        } else {
                            location = zipCity;
                        }
                    }
                }

                // Korrektur Meindlhof Spezialfall
                if (company.Firma && company.Firma.includes('Meindlhof')) {
                    location = 'Schlatt'; // Korrigierter Standort
                }

                if (!companiesByLocation[location]) {
                    companiesByLocation[location] = [];
                }

                companiesByLocation[location].push(company);
            });

            // Sortiere Orte: Vorchdorf zuerst, dann alphabetisch
            const sortedLocations = Object.keys(companiesByLocation).sort((a, b) => {
                if (a.includes('Vorchdorf')) return -1;
                if (b.includes('Vorchdorf')) return 1;
                return a.localeCompare(b, 'de');
            });

            // Rendere HTML
            grid.innerHTML = sortedLocations.map((location, locIndex) => {
                // Reset numbering for each location
                let companyNumber = 1;

                const companies = companiesByLocation[location].sort((a, b) =>
                    a.Firma.localeCompare(b.Firma, 'de')
                );

                // Assign display numbers for this location group
                companies.forEach(c => c._displayNumber = companyNumber++);

                return `
                        <div class="rp-dm-location-group">
                            <h4 class="rp-dm-location-title">
                                üìç ${location} (${companies.length} ${companies.length === 1 ? 'Anbieter' : 'Anbieter'})
                            </h4>
                            <div class="rp-dm-company-list">
                                ${companies.map(company => {
                    const hasWebsite = company.homepage && company.homepage.trim().length > 3;
                    const url = hasWebsite ? (company.homepage.startsWith('http') ? company.homepage : 'https://' + company.homepage) : null;

                    return `
                                        <${url ? `a href="${url}" target="_blank"` : 'div'} class="rp-dm-company-item">
                                            <span class="rp-dm-company-number">${company._displayNumber}</span>
                                            <span class="rp-dm-company-name">${company.Firma} ${url ? ' üåê' : ''}</span>
                                        </${url ? 'a' : 'div'}>
                                    `;
                }).join('')}
                            </div>
                        </div>
                    `;
            }).join('');
        }

        // Direktvermarkter A-Z anzeigen
        function rpShowDirectMarketersAZ() {
            // Verstecke alles andere
            document.getElementById('rpCategoriesView').classList.add('hidden');
            document.getElementById('rpProductsSection').classList.add('hidden');
            document.querySelector('.rp-info-tiles').style.display = 'none';
            document.querySelector('.rp-section-divider').style.display = 'none';

            // Zeige Direktvermarkter
            document.getElementById('rpDirectMarketersSection').classList.remove('hidden');
            document.getElementById('rpBackBtn').classList.remove('hidden');

            rpCurrentView = 'az';
            document.getElementById('floatingBackButton').classList.add('visible');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function extractRPImages(product) {

            const images = [];

            // Sammle alle Bild-URLs
            const potentialImages = [
                product['Bild 1 Url von Imgur'],
                product['Bild 2'],
                product['Bild 3'],
                product['Bild 4']
            ];

            potentialImages.forEach(url => {
                if (!url) return;

                let cleaned = url.trim();

                // Entferne HTML-Tags
                if (cleaned.includes('href=')) {
                    const match = cleaned.match(/href=["']([^"']+)["']/);
                    if (match) cleaned = match[1];
                }

                // Pr√ºfe ob es eine g√ºltige URL ist
                if (cleaned.startsWith('http')) {
                    // Imgur-URLs reparieren
                    if (cleaned.includes('imgur.com') && !cleaned.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                        const parts = cleaned.split('/');
                        const id = parts[parts.length - 1].split(/[?#]/)[0];
                        if (id) cleaned = `https://i.imgur.com/${id}.jpg`;
                    }
                    images.push(cleaned);
                }
            });

            return images;
        }

        // Produkt Detail Modal
        function rpShowProduct(index) {
            rpCurrentProduct = rpAllProducts[index];
            rpCurrentImageIndex = 0;

            const images = extractRPImages(rpCurrentProduct);
            const icon = rpCategories[rpCurrentProduct.Kategorie] || 'üçé';

            document.getElementById('rpModalCategory').textContent = `${icon} ${rpCurrentProduct.Kategorie}`;
            document.getElementById('rpModalTitle').textContent = rpCurrentProduct.Produktname || 'Unbenannt';
            document.getElementById('rpModalPrice').textContent = rpCurrentProduct['Preis in Euro'] ? rpCurrentProduct['Preis in Euro'] + ' ‚Ç¨' : 'Preis auf Anfrage';
            document.getElementById('rpModalDescription').textContent = rpCurrentProduct.Beschreibung || 'Keine Beschreibung vorhanden.';
            document.getElementById('rpModalCompanyName').textContent = rpCurrentProduct.Firmenname || 'Privat';

            // Email-Kontakt Setup
            const company = rpAllCompanies.find(c => c.Firma === rpCurrentProduct.Firmenname);
            const email = company?.email || 'kontakt@vorchdorf.at';
            const subject = encodeURIComponent(`Anfrage zu: ${rpCurrentProduct.Produktname}`);
            const imageUrl = images.length > 0 ? images[0] : '';
            const emailBody = `Hallo,

ich interessiere mich f√ºr Ihr Produkt "${rpCurrentProduct.Produktname}".

${rpCurrentProduct.Beschreibung ? 'Produktbeschreibung: ' + rpCurrentProduct.Beschreibung : ''}

Preis: ${rpCurrentProduct['Preis in Euro'] ? rpCurrentProduct['Preis in Euro'] + ' ‚Ç¨' : 'Auf Anfrage'}

${imageUrl ? 'Produktbild: ' + imageUrl : ''}

Mit freundlichen Gr√º√üen`;

            document.getElementById('rpModalContactBtn').onclick = function (e) {
                e.preventDefault();
                const mailtoLink = `mailto:${email}?subject=${subject}&body=${encodeURIComponent(emailBody)}`;
                window.location.href = mailtoLink;
            };

            // Bild anzeigen
            const modalImage = document.getElementById('rpModalImage');
            if (images.length > 0) {
                modalImage.src = images[rpCurrentImageIndex];
                modalImage.style.display = 'block';
                document.getElementById('rpPrevImage').style.display = images.length > 1 ? 'block' : 'none';
                document.getElementById('rpNextImage').style.display = images.length > 1 ? 'block' : 'none';
            } else {
                modalImage.style.display = 'none';
            }

            document.getElementById('rpModalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeRPModal() {
            document.getElementById('rpModalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        function rpPrevImage() {
            const images = extractRPImages(rpCurrentProduct);
            rpCurrentImageIndex = (rpCurrentImageIndex - 1 + images.length) % images.length;
            document.getElementById('rpModalImage').src = images[rpCurrentImageIndex];
        }

        function rpNextImage() {
            const images = extractRPImages(rpCurrentProduct);
            rpCurrentImageIndex = (rpCurrentImageIndex + 1) % images.length;
            document.getElementById('rpModalImage').src = images[rpCurrentImageIndex];
        }

        // Navigation
        function rpGoBack() {
            if (rpCurrentView === 'companies' || rpCurrentView === 'az') {
                // Von Firmen oder A-Z zur√ºck zu Kategorien
                rpCurrentView = 'categories';
                document.getElementById('rpCategoriesView').classList.remove('hidden');
                document.getElementById('rpCompaniesView').classList.add('hidden');
                document.getElementById('rpProductsSection').classList.remove('hidden');
                document.getElementById('rpDirectMarketersSection').classList.add('hidden');
                document.querySelector('.rp-info-tiles').style.display = 'grid';
                document.querySelector('.rp-section-divider').style.display = 'block';
                document.getElementById('rpBackBtn').classList.add('hidden');
                document.getElementById('backButton').classList.remove('hidden');
                document.getElementById('floatingBackButton').classList.add('visible');
                document.getElementById('rpMainInfoBox').classList.remove('hidden'); // Zeige Info wieder auf Start
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Filter Event Listeners
        function filterRPProducts() {
            renderRPProducts();
        }

        // Lade Bild als Base64 (f√ºr Email-Einbettung)
        function loadImageAsBase64(imageUrl) {
            return fetch(imageUrl)
                .then(response => response.blob())
                .then(blob => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(blob);
                    });
                })
                .catch(() => null);
        }

        function closeFlohmarktModal() {
            document.getElementById('flohmarktModalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Flohmarkt Info Modal
        function openFlohmarktInfo() {
            console.log('openFlohmarktInfo called');
            const infoHtml = `
                <div class="flohmarkt-info-modal" style="background: white; border-radius: 16px; max-width: 800px; width: 95%; max-height: 90vh; padding: 50px 40px; position: relative; z-index: 10001; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <button class="flohmarkt-info-close" onclick="closeFlohmarktInfo()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 2rem; cursor: pointer; color: #666;">‚úï</button>
                    <h2 style="font-size: 2rem; color: #000000; margin: 0 0 20px 0;">‚ÑπÔ∏è Willkommen beim Vorchdorfer-Flohmarkt!</h2>
                    
                    <p style="font-size: 1.1rem; color: #000000; line-height: 1.6; margin: 10px 0;">Hier bieten unsere Werberingmitglieder ausgew√§hlte Artikel an ‚Äì Schn√§ppchen, Einzelst√ºcke oder Waren, f√ºr die im Gesch√§ft einfach der Platz fehlt.</p>
                    
                    <h3 style="font-size: 1.3rem; color: #000000; margin: 20px 0 10px 0;">So funktioniert's:</h3>
                    <p style="font-size: 1.1rem; color: #000000; line-height: 1.6; margin: 10px 0;">St√∂bern Sie in den Angeboten. Wenn Ihnen etwas gef√§llt, dr√ºcken Sie einfach auf E-Mail senden. Der Verk√§ufer meldet sich bei Ihnen, um einen Abholtermin zu vereinbaren. Bezahlt wird erst bei der Abholung ‚Äì direkt und unkompliziert, ganz ohne Online-Zahlung.</p>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button class="flohmarkt-info-btn-close" onclick="closeFlohmarktInfo()" style="background: #4CAF50; color: white; border: none; padding: 12px 30px; font-size: 1.1rem; border-radius: 8px; cursor: pointer;">‚úì Schlie√üen</button>
                    </div>
                </div>
            `;

            // Entferne alte Modal wenn existiert
            let oldModal = document.getElementById('flohmarktInfoModal');
            if (oldModal) {
                oldModal.remove();
            }

            // Erstelle neuen Modal mit INLINE STYLES
            const modal = document.createElement('div');
            modal.id = 'flohmarktInfoModal';
            modal.innerHTML = infoHtml;
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.5) !important;
                z-index: 999999 !important;
                padding: 20px !important;
                overflow-y: auto !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            document.body.appendChild(modal);

            // Click-handler zum schlie√üen
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    closeFlohmarktInfo();
                }
            });

            document.body.style.overflow = 'hidden';
            console.log('Modal created and shown with inline styles');
        }

        function closeFlohmarktInfo() {
            console.log('closeFlohmarktInfo called');
            const modal = document.getElementById('flohmarktInfoModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
            console.log('Modal closed');
        }

        // Regionale Produkte Info Modal
        function openRPInfo() {
            const infoHtml = `
                <div class="rp-info-modal" style="background: white; border-radius: 16px; max-width: 800px; width: 95%; max-height: 90vh; padding: 50px 40px; position: relative; z-index: 10001; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <button class="rp-info-close" onclick="closeRPInfo()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 2rem; cursor: pointer; color: #666;">‚úï</button>
                    <h2 style="font-size: 2rem; color: #1a472a; margin: 0 0 20px 0;">‚ÑπÔ∏è Regionale Produkte aus Vorchdorf</h2>
                    
                    <h3 style="font-size: 1.3rem; color: #1a472a; margin: 20px 0 10px 0;">Qualit√§t, die man kennt ‚Äì aus der Region, f√ºr die Region</h3>
                    <p style="font-size: 1.1rem; color: #1a1a1a; line-height: 1.6; margin: 10px 0;">Wissen Sie, woher Ihr Brot kommt? Wer Ihre Eier produziert? Oder wo das Gem√ºse auf Ihrem Teller gewachsen ist?<br><br>
                    In Vorchdorf haben wir das Gl√ºck, von einer Vielzahl engagierter Produzenten umgeben zu sein, die mit Leidenschaft und Fachwissen hochwertige Lebensmittel und Produkte erzeugen. Menschen, die wir oft pers√∂nlich kennen. Nachbarn, die mit Sorgfalt und nach bestem Wissen und Gewissen arbeiten.</p>
                    
                    <h3 style="font-size: 1.3rem; color: #1a472a; margin: 25px 0 10px 0;">Regionalit√§t ist mehr als ein Trend</h3>
                    <p style="font-size: 1.1rem; color: #1a1a1a; line-height: 1.6; margin: 10px 0;">Wenn wir regional kaufen, w√§hlen wir Qualit√§t. Wir w√§hlen Frische. Wir w√§hlen kurze Wege und damit auch Nachhaltigkeit. Vor allem aber w√§hlen wir Vertrauen ‚Äì denn wir wissen, wer hinter den Produkten steht.<br><br>
                    Diese √úbersicht soll Ihnen zeigen, welche Vielfalt unsere Region zu bieten hat: von frischem Obst und Gem√ºse √ºber handwerklich hergestellte Spezialit√§ten bis hin zu traditionellen Produkten. Entdecken Sie, wer was produziert und wo Sie diese Sch√§tze direkt beziehen k√∂nnen.</p>

                    <h3 style="font-size: 1.3rem; color: #1a472a; margin: 25px 0 10px 0;">Gemeinsam st√§rken wir unsere Region</h3>
                    <p style="font-size: 1.1rem; color: #1a1a1a; line-height: 1.6; margin: 10px 0;">Jeder Einkauf bei unseren regionalen Erzeugern ist ein Beitrag zur St√§rkung der lokalen Wirtschaft, zur Erhaltung unserer Kulturlandschaft und zur Sicherung von Arbeitspl√§tzen in Vorchdorf und Umgebung.<br><br>
                    Lernen Sie unsere Produzenten kennen ‚Äì ihre Geschichten, ihre Produkte, ihre Leidenschaft f√ºr das, was sie tun.</p>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button class="rp-info-btn-close" onclick="closeRPInfo()" style="background: var(--primary); color: white; border: none; padding: 12px 30px; font-size: 1.1rem; border-radius: 8px; cursor: pointer; transition: all 0.3s;">‚úì Schlie√üen</button>
                    </div>
                </div>
            `;

            // Entferne alte Modal wenn existiert
            let oldModal = document.getElementById('rpInfoModal');
            if (oldModal) {
                oldModal.remove();
            }

            // Erstelle neuen Modal mit INLINE STYLES
            const modal = document.createElement('div');
            modal.id = 'rpInfoModal';
            modal.innerHTML = infoHtml;
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.5) !important;
                z-index: 999999 !important;
                padding: 20px !important;
                overflow-y: auto !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            document.body.appendChild(modal);

            // Click-handler zum schlie√üen
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    closeRPInfo();
                }
            });

            document.body.style.overflow = 'hidden';
        }

        function closeRPInfo() {
            const modal = document.getElementById('rpInfoModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }

        // Email Preview Modal - mit Bild und HTML-Vorschau
        function openEmailPreviewModal(toEmail, subject, body, imageUrl, sellerName) {
            window.flohmarktEmailImageURL = imageUrl; // URL f√ºr sendEmailFromPreview speichern
            // Erstelle Modal-HTML
            let previewHtml = `
                <div class="email-preview-modal">
                    <div class="email-preview-content">
                        <h3>üìß Email-Vorschau</h3>
                        
                        <div class="email-header">
                            <p><strong>An:</strong> ${toEmail}</p>
                            <p><strong>Betreff:</strong> ${decodeURIComponent(subject)}</p>
                        </div>
                        
                        <div class="email-body">
                            <div style="white-space: pre-wrap; color: #333; line-height: 1.6;">${body.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                            ${imageUrl ? `<div class="email-image" style="margin-top: 20px; text-align: center;">
                                <img src="${imageUrl}" alt="Produktbild" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid #ddd;">
                            </div>` : ''}
                        </div>
                        
                        <div class="email-actions">
                            <button class="btn-primary" onclick="sendEmailFromPreview('${toEmail}', '${subject}', '${btoa(body)}')">üì§ Email senden</button>
                            <button class="btn-secondary" onclick="closeEmailPreviewModal()">Abbrechen</button>
                        </div>
                    </div>
                </div>
            `;

            // Erstelle Modal-Container falls nicht vorhanden
            let modal = document.getElementById('emailPreviewModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'emailPreviewModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                    z-index: 10000; padding: 20px;
                `;
                document.body.appendChild(modal);
            }

            modal.innerHTML = previewHtml;
            modal.style.display = 'flex';

            // Style Modal
            const styleTag = document.createElement('style');
            styleTag.textContent = `
                .email-preview-modal {
                    background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                    max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;
                    padding: 30px;
                }
                .flohmarkt-info-modal {
                    background: #ffffff; border-radius: 16px; box-shadow: 0 20px 80px rgba(0,0,0,0.5);
                    max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto;
                    padding: 50px 40px; position: relative; z-index: 10001;
                }
                .flohmarkt-info-close {
                    position: absolute; top: 20px; right: 20px;
                    width: 40px; height: 40px; border: none; background: #f0f0f0; border-radius: 50%;
                    font-size: 1.5rem; cursor: pointer; transition: all 0.3s;
                }
                .flohmarkt-info-close:hover {
                    background: #e0e0e0;
                }
                .flohmarkt-info-modal h2 {
                    margin-top: 0; color: #1a1a1a; margin-bottom: 25px; font-size: 2rem; font-weight: 700;
                }
                .flohmarkt-info-modal h3 {
                    color: #1a472a; margin-top: 30px; margin-bottom: 15px; font-size: 1.3rem; font-weight: 700;
                }
                .flohmarkt-info-modal p {
                    color: #1a1a1a; line-height: 1.8; margin-bottom: 20px; font-size: 1.1rem;
                }
                .flohmarkt-info-btn-close {
                    background: var(--primary); color: white; border: none;
                    padding: 15px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: 700;
                    cursor: pointer; transition: all 0.3s;
                }
                .flohmarkt-info-btn-close:hover {
                    background: var(--primary-lighter); transform: translateY(-2px);
                    box-shadow: 0 8px 20px rgba(26, 71, 42, 0.3);
                }
                .flohmarkt-info-overlay {
                    display: none;
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0, 0, 0, 1); align-items: center; justify-content: center;
                    z-index: 999999; padding: 20px; overflow-y: auto;
                }
                .flohmarkt-info-overlay.active {
                    display: flex !important;
                }
                .email-preview-content h3 {
                    margin-top: 0; color: #1a472a; margin-bottom: 20px; font-size: 1.3rem;
                }
                .email-header {
                    background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;
                    border-left: 4px solid #1a472a;
                }
                .email-header p {
                    margin: 5px 0; font-size: 0.95rem;
                }
                .email-body {
                    padding: 20px; background: #fafafa; border-radius: 8px; margin-bottom: 20px;
                    border: 1px solid #e0e0e0;
                }
                .email-actions {
                    display: flex; gap: 10px; justify-content: flex-end;
                }
                .btn-primary, .btn-secondary {
                    padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;
                    font-size: 0.95rem; font-weight: 500; transition: all 0.3s;
                }
                .btn-primary {
                    background: #1a472a; color: white;
                }
                .btn-primary:hover {
                    background: #2d7a47; transform: translateY(-2px);
                }
                .btn-secondary {
                    background: #ddd; color: #333;
                }
                .btn-secondary:hover {
                    background: #ccc;
                }
                .email-image {
                    text-align: center;
                }
            `;
            document.head.appendChild(styleTag);
        }

        function closeEmailPreviewModal() {
            const modal = document.getElementById('emailPreviewModal');
            if (modal) modal.style.display = 'none';
        }

        function sendEmailFromPreview(toEmail, subject, encodedBody) {
            let body = atob(encodedBody); // Decode from base64

            // Wenn Bild-URL verf√ºgbar, f√ºge sie dem Text hinzu
            if (window.flohmarktEmailImageURL) {
                body += `\n\nProdukt-Bild: ${window.flohmarktEmailImageURL}`;
            }

            const mailtoLink = `mailto:${toEmail}?subject=${subject}&body=${encodeURIComponent(body)}`;
            // Schlie√üe zuerst das Modal, dann √∂ffne Email
            closeEmailPreviewModal();
            // Kurze Verz√∂gerung damit das Modal geschlossen ist bevor Email √∂ffnet
            setTimeout(() => {
                window.open(mailtoLink, '_blank');
            }, 300);
        }

        // Event Listeners f√ºr Flohmarkt
        document.getElementById('flohmarktSearch').addEventListener('input', filterFlohmarktProducts);
        document.getElementById('flohmarktCategory').addEventListener('change', filterFlohmarktProducts);
        document.getElementById('flohmarktVerkaeifer').addEventListener('change', filterFlohmarktProducts);
        document.getElementById('flohmarktModalClose').addEventListener('click', closeFlohmarktModal);
        document.getElementById('flohmarktModalOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('flohmarktModalOverlay')) closeFlohmarktModal();
        });
        document.getElementById('flohmarktPrevImage').addEventListener('click', flohmarktPrevImage);
        document.getElementById('flohmarktNextImage').addEventListener('click', flohmarktNextImage);
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('flohmarktModalOverlay').classList.contains('active')) {
                if (e.key === 'Escape') closeFlohmarktModal();
                if (e.key === 'ArrowLeft') flohmarktPrevImage();
                if (e.key === 'ArrowRight') flohmarktNextImage();
            }
        });

        // ===== IMMEDIATE CACHE & SERVICE WORKER CLEANUP =====
        // MUST run FIRST before anything else
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(regs => {
                regs.forEach(reg => {
                    reg.unregister();
                    console.log('‚ùå SW unregistered');
                });
            });
        }
        if ('caches' in window) {
            caches.keys().then(names => names.forEach(name => caches.delete(name)));
        }

        // App Version - Update this with each release
        // App Version - Update this with each release
        // APP_VERSION is defined in js/common.js
        const CACHE_BUSTER = Date.now();
        // AGGRESSIVE CACHE BUSTING - Pr√ºfe online ob neue Version existiert
        // Legacy checkForUpdates removed to prevent reload loops during refactoring
        // Version check is handled by common.js and localStorage logic below

        // AGGRESSIVE CACHE CLEARING
        // 1. Unregister all service workers
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(reg => reg.unregister());
            });
        }

        // 2. Clear all caches
        if ('caches' in window) {
            caches.keys().then(cacheNames => {
                cacheNames.forEach(cacheName => caches.delete(cacheName));
            });
        }

        // 3. Clear storage if version mismatch
        if (localStorage.getItem('appVersion') !== APP_VERSION) {
            localStorage.clear();
            sessionStorage.clear();
            localStorage.setItem('appVersion', APP_VERSION);
            localStorage.setItem('cacheBuster', CACHE_BUSTER);
            // Force hard refresh
            setTimeout(() => location.reload(true), 200);
        }

        // App State
        let currentView = 'home';
        let navigationHistory = [];
        let currentCategory = null;
        let currentSubcategory = null;
        let categoryCounts = {};

        // Stempelpass State
        let activePasses = [];
        let userStamps = JSON.parse(localStorage.getItem('vorchdorf_stamps') || '{}');
        let html5QrCode = null;

        // Anonyme User-ID generieren/laden (vch_ + 12 hex chars)
        function getUserId() {
            let userId = localStorage.getItem('vorchdorf_user_id');
            if (!userId) {
                // Generiere anonymen 12-stelligen Hex-Token
                const hex = Array.from({ length: 12 }, () => Math.floor(Math.random() * 16).toString(16)).join('');
                userId = 'vch_' + hex;
                localStorage.setItem('vorchdorf_user_id', userId);
            }
            return userId;
        }

        // Vormals device_id, jetzt vereinheitlicht auf user_id
        function getDeviceId() { return getUserId(); }

        // Stempelpass Initialisierung
        async function initializeStempelp√§sse() {
            const grid = document.getElementById('stempelGrid');
            const empty = document.getElementById('stempelEmpty');

            try {
                // 1. Lade Pass-Definitionen
                const response = await fetch('./stempel_data.json?v=' + Date.now());
                const data = await response.json();
                activePasses = data.passes;

                // 2. Vollst√§ndige Cloud-Synchronisation
                await fullSync();

                if (activePasses.length === 0) {
                    grid.innerHTML = '';
                    empty.classList.remove('hidden');
                    document.getElementById('stempelBackupInfo').classList.add('hidden');
                } else {
                    empty.classList.add('hidden');
                    // Backup Info nur zeigen wenn mindestens ein Stempel vorhanden ist
                    const totalStamps = Object.values(userStamps).reduce((acc, curr) => acc + curr.length, 0);
                    if (totalStamps > 0) {
                        document.getElementById('stempelBackupInfo').classList.remove('hidden');
                    }
                    renderStempelCards();
                }
            } catch (error) {
                console.error('Fehler beim Laden der Stempelp√§sse:', error);
                showDataError('Stempelp√§sse');
            }
        }

        function renderStempelCards() {
            const grid = document.getElementById('stempelGrid');
            grid.innerHTML = activePasses.map(pass => {
                const stamps = userStamps[pass.id] || [];
                const count = stamps.length;
                const progress = Math.min((count / pass.target_stamps) * 100, 100);

                return `
                            <div class="stempel-card">
                                <div class="stempel-card-title">
                                    <span>üéüÔ∏è</span>
                                    <span>${pass.name}</span>
                                </div>
                                <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 15px;">${pass.description}</p>
                                
                                <div class="stempel-progress-container">
                                    <div class="stempel-progress-bar" style="width: ${progress}%"></div>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 700; color: var(--primary);">
                                    <span>Fortschritt</span>
                                    <span>${count} / ${pass.target_stamps}</span>
                                </div>

                                <div class="stempel-dots">
                                    ${Array.from({ length: pass.target_stamps }).map((_, i) => `
                                        <div class="stempel-dot ${i < count ? 'active' : ''}">
                                            ${i < count ? '‚úÖ' : i + 1}
                                        </div>
                                    `).join('')}
                                </div>

                                <button class="stempel-scan-btn" onclick="openScanner('${pass.id}')">
                                    üì∏ QR-Code scannen
                                </button>
                                
                                ${count >= pass.target_stamps ? `
                                    <button class="stempel-scan-btn" style="background: #4CAF50; margin-top: 10px;" onclick="redeemReward('${pass.id}')">
                                        üéÅ Belohnung einl√∂sen
                                    </button>
                                ` : ''}
                            </div>
                        `;
            }).join('');
        }

        function openScanner(passId) {
            const overlay = document.getElementById('scannerOverlay');
            if (!overlay) {
                alert("Fehler: Scanner-UI nicht gefunden.");
                return;
            }

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';

            try {
                html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    (decodedText) => {
                        handleQrResult(decodedText, passId);
                    }
                ).catch(err => {
                    console.error("Kamera-Fehler:", err);
                    let msg = "Kamera konnte nicht gestartet werden.\n\n";
                    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                        msg += "HINWEIS: Browser erlauben Kamera-Zugriff oft nur √ºber HTTPS (verschl√ºsselt).\nBeim Testen per IP-Adresse kann dies blockiert werden.";
                    } else {
                        msg += "Bitte pr√ºfe, ob du der App den Zugriff auf die Kamera erlaubt hast.";
                    }
                    alert(msg);
                    closeScanner();
                });
            } catch (e) {
                alert("Scanner-Initialisierungsfehler: " + e.message);
                closeScanner();
            }
        }

        function closeScanner() {
            const overlay = document.getElementById('scannerOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';

            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode = null;
                }).catch(err => console.error("Scanner Error:", err));
            }
        }

        function handleQrResult(text, passId) {
            closeScanner();

            try {
                const data = JSON.parse(text);

                // FALL 1: Stempel-QR gescannt
                // Unterst√ºtzt altes Format (vorchdorf_stamp) und neues Format (type: VORCHDORF_STAMP)
                if ((data.vorchdorf_stamp || data.type === 'VORCHDORF_STAMP') && data.pass_id === passId) {
                    validateAndAddStamp(passId, data.company_id);
                }
                // FALL 2: Backup-QR gescannt
                else if (data.type === 'VORCHDORF_USER_BACKUP' && data.user_id) {
                    restoreFromBackup(data.user_id);
                }
                else {
                    alert("‚ùå Ung√ºltiger QR-Code f√ºr diesen Stempelpass.");
                }
            } catch (e) {
                alert("‚ùå Dieser QR-Code geh√∂rt nicht zum Vorchdorfer Stempel-System.");
            }
        }

        async function restoreFromBackup(newUserId) {
            if (confirm("M√∂chten Sie Ihren Stempelpass von der ID " + newUserId + " wiederherstellen?\n\nIhre aktuellen lokalen Stempel werden dabei √ºberschrieben.")) {
                localStorage.setItem('vorchdorf_user_id', newUserId);

                // Hier in Zukunft: API Call um St√§nde vom Server zu laden
                // await loadStampsFromServer(newUserId);

                alert("‚úÖ Stempelpass erfolgreich wiederhergestellt!");
                location.reload();
            }
        }

        async function validateAndAddStamp(passId, companyId) {
            if (!userStamps[passId]) userStamps[passId] = [];

            // Regel: Nur 1 Stempel pro Tag pro Firma
            const today = new Date().toISOString().split('T')[0];
            const existing = userStamps[passId].find(s => s.companyId === companyId && s.date === today);

            if (existing) {
                alert("‚ö†Ô∏è Du hast heute bereits einen Stempel f√ºr diesen Betrieb erhalten!");
                return;
            }

            // Stempel hinzuf√ºgen
            const newStamp = {
                companyId: companyId,
                date: today,
                timestamp: new Date().toISOString()
            };

            userStamps[passId].push(newStamp);
            localStorage.setItem('vorchdorf_stamps', JSON.stringify(userStamps));
            renderStempelCards();

            // Cloud-Sync (async im Hintergrund)
            syncStampToCloud(passId, companyId).catch(err => {
                console.warn('Cloud-Sync failed, will retry later:', err);
            });

            // Backup Info einblenden
            document.getElementById('stempelBackupInfo').classList.remove('hidden');

            // Erfolgssound/Vibration
            if ("vibrate" in navigator) navigator.vibrate(200);

            alert("‚úÖ Stempel erfolgreich hinzugef√ºgt!");
        }

        // ============================================
        // BACKUP LOGIC
        // ============================================
        let backupQrInstance = null;

        function openBackupModal() {
            const overlay = document.getElementById('backupModal');
            const userId = getUserId();
            document.getElementById('backupUserIdDisplay').innerText = userId;
            overlay.classList.add('active');

            const qrContainer = document.getElementById('backupQrCanvas');
            qrContainer.innerHTML = ''; // Clear

            const backupData = {
                type: 'VORCHDORF_USER_BACKUP',
                user_id: userId
            };

            backupQrInstance = new QRCode(qrContainer, {
                text: JSON.stringify(backupData),
                width: 250,
                height: 250,
                colorDark: "#1a472a",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function closeBackupModal() {
            document.getElementById('backupModal').classList.remove('active');
        }

        function redeemReward(passId) {
            const pass = activePasses.find(p => p.id === passId);
            if (confirm(`M√∂chtest du deine Belohnung f√ºr "${pass.name}" jetzt beim Wirt/H√§ndler einl√∂sen?\n\nACHTUNG: Dies darf nur im Beisein des Personals geschehen!`)) {
                // In echt w√ºrde hier ein Server-Call passieren
                userStamps[passId] = []; // Zur√ºcksetzen nach Einl√∂sung
                localStorage.setItem('vorchdorf_stamps', JSON.stringify(userStamps));
                renderStempelCards();
                alert("üéâ Belohnung eingel√∂st! Herzlichen Gl√ºckwunsch.");
            }
        }

        // Hilfsfunktion: Z√§hlt Eintr√§ge pro Kategorie
        function getCategoryItemCount(catId) {
            if (catId === 'shopping') {
                return allBusinesses.filter(b => b.werbering === true).length;
            }
            if (catId === 'clubs') {
                return Object.values(allClubs).reduce((acc, list) => acc + list.length, 0);
            }
            const cat = categories[catId];
            if (!cat) return 0;

            let count = 0;
            if (cat.items) count += cat.items.length;
            if (cat.subcategories) {
                Object.values(cat.subcategories).forEach(sub => {
                    if (sub.items) count += sub.items.length;
                });
            }
            if (cat.content && cat.content.items) count += cat.content.items.length;
            if (cat.content && cat.content.sections) {
                cat.content.sections.forEach(s => count += s.items.length);
            }
            return count;
        }

        // Global Business Data - Loaded from businesses.json
        let allBusinesses = [];
        let allClubs = {};

        // Gemeinde-Verwaltung Daten - Loaded from JSON
        let allFormulare = [];
        let allMitarbeiter = [];
        let allAbteilungen = [];
        let allGemeindebetriebe = [];

        // Data Structure
        // Kategorien werden aus categories.json geladen
        let categories = {};

        // Lade Kategorien aus JSON Datei
        async function loadCategories() {
            try {
                const response = await fetch('./categories.json?v=' + Date.now());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                categories = await response.json();
                console.log(`‚úì ${Object.keys(categories).length} Kategorien geladen`);
            } catch (error) {
                console.error('Fehler beim Laden von categories.json:', error);
                showDataError('Kategorien');
            }
        }

        // Lade Businesses aus JSON Datei
        async function loadBusinesses() {
            try {
                // AGGRESSIVE CACHE BUSTING
                const response = await fetch('./businesses.json?v=' + Date.now());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const businesses = await response.json();

                // Speichere in allBusinesses Variable
                allBusinesses = businesses;

                console.log(`‚úì ${businesses.length} Betriebe geladen`);

                if (businesses.length === 0) {
                    console.warn('Warnung: businesses.json ist leer');
                }
            } catch (error) {
                console.error('Fehler beim Laden von businesses.json:', error);
                allBusinesses = []; // Fallback zu leerem Array
                showDataError('Betriebe');
            }
        }

        async function loadClubs() {
            try {
                const response = await fetch('./clubs.json?v=' + Date.now());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const clubs = await response.json();
                allClubs = clubs;

                // Populate categories from the loaded data
                if (categories.clubs && categories.clubs.subcategories) {
                    Object.keys(clubs).forEach(key => {
                        if (categories.clubs.subcategories[key]) {
                            categories.clubs.subcategories[key].items = clubs[key];
                        }
                    });
                }

                // Sync Sport & Fitness subcategory
                if (categories.sport_fitness && categories.sport_fitness.subcategories && categories.sport_fitness.subcategories.sports_clubs) {
                    categories.sport_fitness.subcategories.sports_clubs.items = clubs.sport || [];
                }

                console.log(`‚úì Vereine geladen`);
            } catch (error) {
                console.error('Fehler beim Laden von clubs.json:', error);
                allClubs = {};
                showDataError('Vereine');
            }
        }

        // Lade Gemeinde-Verwaltung Daten
        async function loadGemeindeData() {
            const ts = Date.now();
            try {
                // Lade Formulare
                const formResponse = await fetch(`./gemeinde-verwaltung/data/formulare.json?v=${ts}`);
                if (!formResponse.ok) throw new Error(`HTTP error! status: ${formResponse.status}`);
                const formData = await formResponse.json();
                allFormulare = formData.formulare || [];
                console.log(`‚úì ${allFormulare.length} Formulare geladen`);
            } catch (error) {
                console.error('Fehler beim Laden von formulare.json:', error);
                allFormulare = [];
            }

            try {
                // Lade Mitarbeiter
                const mitResponse = await fetch(`./gemeinde-verwaltung/data/mitarbeiter.json?v=${ts}`);
                if (!mitResponse.ok) throw new Error(`HTTP error! status: ${mitResponse.status}`);
                const mitData = await mitResponse.json();
                allMitarbeiter = mitData.mitarbeiter || [];
                console.log(`‚úì ${allMitarbeiter.length} Mitarbeiter geladen`);
            } catch (error) {
                console.error('Fehler beim Laden von mitarbeiter.json:', error);
                allMitarbeiter = [];
            }

            try {
                // Lade Abteilungen
                const abtResponse = await fetch(`./gemeinde-verwaltung/data/abteilungen.json?v=${ts}`);
                if (!abtResponse.ok) throw new Error(`HTTP error! status: ${abtResponse.status}`);
                const abtData = await abtResponse.json();
                allAbteilungen = abtData.abteilungen || [];
                console.log(`‚úì ${allAbteilungen.length} Abteilungen geladen`);
            } catch (error) {
                console.error('Fehler beim Laden von abteilungen.json:', error);
                allAbteilungen = [];
            }

            try {
                // Lade Gemeindebetriebe
                const betResponse = await fetch(`./gemeinde-verwaltung/data/gemeindebetriebe.json?v=${ts}`);
                if (!betResponse.ok) throw new Error(`HTTP error! status: ${betResponse.status}`);
                const betData = await betResponse.json();
                allGemeindebetriebe = betData.betriebe || [];
                console.log(`‚úì ${allGemeindebetriebe.length} Gemeindebetriebe geladen`);
            } catch (error) {
                console.error('Fehler beim Laden von gemeindebetriebe.json:', error);
                allGemeindebetriebe = [];
            }
        }

        function showDataError(type) {
            // Zeige eine kleine Warnung in der UI wenn Daten nicht geladen werden k√∂nnen
            const banner = document.createElement('div');
            banner.style.cssText = 'background: #ff4d4d; color: white; padding: 10px; text-align: center; font-size: 0.9em; position: sticky; top: 0; z-index: 9999;';
            banner.innerHTML = `‚ö†Ô∏è <b>Fehler:</b> ${type} konnten nicht geladen werden. Bitte Seite neu laden oder Cache leeren.`;
            document.body.prepend(banner);
            setTimeout(() => banner.remove(), 10000);
        }

        // Initialize App
        function init() {
            getDeviceId(); // Sicherstellen, dass Device ID existiert
            renderHome();
        }

        // Fetch Weather Data
        async function fetchWeather() {
            try {
                const lat = 48.0039;
                const lon = 13.9485;
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=Europe/Vienna`
                );
                const data = await response.json();
                return data.daily;
            } catch (error) {
                console.error('Wetter konnte nicht geladen werden:', error);
                return null;
            }
        }

        function getWeatherIcon(weatherCode) {
            const wmoToIcon = {
                0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è', 45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
                51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üåßÔ∏è', 61: 'üåßÔ∏è', 63: '‚õàÔ∏è', 65: '‚õàÔ∏è',
                71: '‚ùÑÔ∏è', 73: '‚ùÑÔ∏è', 75: '‚ùÑÔ∏è', 77: '‚ùÑÔ∏è', 80: 'üåßÔ∏è', 81: '‚õàÔ∏è', 82: '‚õàÔ∏è',
                85: '‚ùÑÔ∏è', 86: '‚ùÑÔ∏è', 95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
            };
            return wmoToIcon[weatherCode] || 'üå§Ô∏è';
        }

        function getWeatherDescription(weatherCode) {
            const descriptions = {
                0: 'Klar', 1: 'Heiter', 2: 'Bew√∂lkt', 3: 'Bedeckt', 45: 'Nebel', 48: 'Nebel',
                51: 'Leicht Regen', 53: 'M√§√üig Regen', 55: 'Starker Regen', 61: 'Regen',
                63: 'Regen', 65: 'Starker Regen', 71: 'Schnee', 73: 'Schnee', 75: 'Schnee',
                77: 'Schnee', 80: 'Regen', 81: 'Starker Regen', 82: 'Extremer Regen',
                85: 'Schnee', 86: 'Schnee', 95: 'Gewitter', 96: 'Gewitter', 99: 'Gewitter'
            };
            return descriptions[weatherCode] || 'Unbekannt';
        }

        // Render Home View
        function renderHome() {
            currentView = 'home';
            navigationHistory = [];
            currentCategory = null;
            currentSubcategory = null;

            document.getElementById('emergencyBanner').classList.remove('hidden');
            document.getElementById('breadcrumb').classList.add('hidden');
            document.getElementById('backButton').classList.add('hidden');
            document.getElementById('floatingBackButton').classList.remove('visible');
            window.scrollTo({ top: 0, behavior: 'instant' });
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('flohmarktContainer').classList.remove('active');
            document.getElementById('rpContainer').classList.remove('active');
            document.getElementById('stempelContainer').classList.remove('active'); // Neu
            document.querySelector('.search-container').classList.remove('hidden');

            const mainContent = document.getElementById('mainContent');
            const weatherWidget = document.getElementById('weatherWidget');

            // Render categories in custom order
            const categoryOrder = ['welcome', 'municipality', 'health', 'emergency', 'administration', 'mobility', 'education', 'shopping', 'leisure', 'sport_fitness', 'clubs', 'events', 'gallery', 'mittagstisch', 'waste_calendar', 'stempelpass', 'flohmarkt', 'regionale_produkte', 'sags_uns'];
            const sortedCategories = categoryOrder.map(id => categories[id]).filter(cat => cat);

            mainContent.innerHTML = `
                <div class="cards-grid fade-in">
                    ${sortedCategories.map(cat => `
                        <div class="card" onclick="navigateToCategory('${cat.id}')">
                            <span class="card-icon">${cat.icon}</span>
                            <h3>${cat.title}</h3>
                            <p>${cat.description}</p>
                        </div>
                    `).join('')}
                </div>
            `;

            // Fetch and display weather in dedicated widget below emergency
            fetchWeather().then(weatherData => {
                if (weatherData && weatherData.time) {
                    weatherWidget.innerHTML = `
                        <div class="weather-container">
                            <h3>üå°Ô∏è Wetter in Vorchdorf</h3>
                            <div class="weather-content">
                                ${weatherData.time.slice(0, 3).map((date, idx) => {
                        const dateObj = new Date(date);
                        const dayName = dateObj.toLocaleDateString('de-DE', { weekday: 'short' });
                        const icon = getWeatherIcon(weatherData.weather_code[idx]);
                        const desc = getWeatherDescription(weatherData.weather_code[idx]);
                        const tempMax = Math.round(weatherData.temperature_2m_max[idx]);
                        const tempMin = Math.round(weatherData.temperature_2m_min[idx]);
                        return `
                                        <div class="weather-day">
                                            <h4>${dayName}</h4>
                                            <div class="weather-icon">${icon}</div>
                                            <div class="weather-temp">${tempMax}¬∞ / ${tempMin}¬∞</div>
                                            <div class="weather-description">${desc}</div>
                                        </div>
                                    `;
                    }).join('')}
                            </div>
                        </div>
                    `;
                    weatherWidget.classList.remove('hidden');
                } else {
                    weatherWidget.classList.add('hidden');
                }
            }).catch(error => {
                console.error('Wetter-Fehler, verstecke Widget:', error);
                weatherWidget.classList.add('hidden');
            });
        }

        // Toggle Werbering Filter
        function toggleWerberingFilter() {
            showOnlyWerbering = !showOnlyWerbering;
            navigateToCategory('shopping');
        }

        // Navigate to Category
        function navigateToCategory(categoryId) {
            const category = categories[categoryId];
            if (!category) return;
            // Verstecke Search-Container standardm√§√üig bei allen Kategorien
            document.querySelector('.search-container').classList.add('hidden');
            // ZEIGE BACK BUTTON IMMER WENN NICHT HOME
            document.getElementById('backButton').classList.remove('hidden');

            // Handle Flohmarkt
            if (category.isFlohmarkt) {
                currentView = 'flohmarkt';
                currentCategory = categoryId;
                navigationHistory.push({ type: 'home' });

                document.getElementById('emergencyBanner').classList.add('hidden');
                document.getElementById('weatherWidget').classList.add('hidden');
                document.getElementById('backButton').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'instant' });
                document.getElementById('mainContent').style.display = 'none';
                // document.getElementById('mainFooter').style.display = 'none'; // Footer removed
                document.getElementById('flohmarktContainer').classList.add('active');
                updateBreadcrumb([{ text: category.title }]);

                loadFlohmarktProducts();
                return;
            }

            // Handle Regionale Produkte
            if (category.isRegionaleProdukte) {
                currentView = 'regionale_produkte';
                currentCategory = categoryId;
                navigationHistory.push({ type: 'home' });

                document.getElementById('emergencyBanner').classList.add('hidden');
                document.getElementById('weatherWidget').classList.add('hidden');
                document.getElementById('backButton').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'instant' });
                document.getElementById('mainContent').style.display = 'none';
                document.querySelector('.search-container').classList.add('hidden');
                // document.getElementById('mainFooter').style.display = 'block'; // Footer removed
                document.getElementById('rpContainer').classList.add('active');
                updateBreadcrumb([{ text: category.title }]);

                initializeRP();
                rpCurrentView = 'categories';
                document.getElementById('rpCategoriesView').classList.remove('hidden');
                document.getElementById('rpCompaniesView').classList.add('hidden');
                document.getElementById('rpProductsSection').classList.remove('hidden');
                document.getElementById('rpBackBtn').classList.add('hidden'); // Verstecke lokalen Button auf Startseite
                document.getElementById('backButton').classList.remove('hidden'); // Zeige globalen Button
                return;
            }

            // Handle Stempelpass
            if (category.isStempelpass) {
                currentView = 'stempelpass';
                currentCategory = categoryId;
                navigationHistory.push({ type: 'home' });

                document.getElementById('emergencyBanner').classList.add('hidden');
                document.getElementById('weatherWidget').classList.add('hidden');
                document.getElementById('backButton').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'instant' });
                document.getElementById('mainContent').style.display = 'none';
                document.querySelector('.search-container').classList.add('hidden'); // Neu
                // document.getElementById('mainFooter').style.display = 'block'; // Footer removed
                document.getElementById('stempelContainer').classList.add('active');
                updateBreadcrumb([{ text: category.title }]);

                initializeStempelp√§sse();
                return;
            }

            // Handle Waste Calendar
            if (category.wasteCalendar) {
                openWasteCalendar();
                return;
            }

            // Handle external links
            if (category.externalLink) {
                if (category.externalLink.startsWith('http')) {
                    window.open(category.externalLink, '_blank');
                } else {
                    window.location.href = category.externalLink;
                }
                return;
            }

            currentView = 'category';
            currentCategory = categoryId;
            currentSubcategory = null;
            navigationHistory.push({ type: 'home' });

            document.getElementById('emergencyBanner').classList.add('hidden');
            document.getElementById('weatherWidget').classList.add('hidden');
            document.getElementById('backButton').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'instant' });
            document.getElementById('flohmarktContainer').classList.remove('active');
            document.getElementById('rpContainer').classList.remove('active');
            document.getElementById('mainContent').style.display = 'block';
            updateBreadcrumb([{ text: category.title }]);

            const mainContent = document.getElementById('mainContent');

            if (category.subcategories) {
                // Show subcategories in defined order (already alphabetically sorted)
                const subcategoryList = Object.values(category.subcategories);
                // Zeige Search bei Shopping und Clubs
                if (categoryId === 'shopping' || categoryId === 'clubs') {
                    document.querySelector('.search-container').classList.remove('hidden');
                }
                else {
                    document.querySelector('.search-container').classList.add('hidden');
                }

                mainContent.innerHTML = `
                    <div class="detail-view fade-in">
                        <h2>${category.icon} ${category.title}</h2>
                        ${categoryId === 'shopping' ? `
                            <div class="info-item">
                                <h4>‚ÑπÔ∏è √úber den Werbering</h4>
                                <p>üë• 179 Werbering-Mitgliedsbetriebe in Vorchdorf, Laakirchen und Umgebung. Zus√§tzlich ca. 100 weitere Nicht-Mitglieder.</p>
                                <p>üéÅ Werbering-Gutscheine bei allen Mitgliedern einl√∂sbar</p>
                                <p>‚òéÔ∏è 0699 15 05 88 57 ‚Ä¢ ‚úâÔ∏è tipp@werbering-vorchdorf.at</p>
                                <p><a href="https://www.vorchdorfonline.at" target="_blank">üåê www.vorchdorfonline.at</a></p>
                            </div>

                            <div onclick="toggleWerberingFilter()" style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 20px; padding: 15px; border-radius: 12px; background: ${showOnlyWerbering ? 'var(--secondary)' : 'white'}; border: 2px solid ${showOnlyWerbering ? 'var(--secondary)' : 'var(--border)'}; box-shadow: var(--shadow-md); transition: all 0.3s;">
                                <span style="font-size: 1.5rem;">üéñÔ∏è</span>
                                <span style="font-weight: 700; color: ${showOnlyWerbering ? 'white' : 'var(--primary)'}; font-size: 1rem;">${showOnlyWerbering ? 'Alle Betriebe anzeigen' : 'Nur Werberingmitglieder anzeigen'}</span>
                                <div style="margin-left: auto; width: 24px; height: 24px; border-radius: 50%; border: 2px solid ${showOnlyWerbering ? 'white' : 'var(--border)'}; background: ${showOnlyWerbering ? 'white' : 'transparent'}; position: relative;">
                                    ${showOnlyWerbering ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 12px; height: 12px; background: var(--secondary); border-radius: 50%;"></div>' : ''}
                                </div>
                            </div>
                        ` : ''}
                        <div class="subcategory-list">
                            ${subcategoryList.map(sub => {
                    let subCount = 0;
                    if (categoryId === 'shopping') {
                        if (sub.id === 'all_businesses_az') {
                            subCount = allBusinesses.filter(b => b.werbering === true).length;
                        } else {
                            subCount = allBusinesses.filter(b => {
                                const isCategory = b.category === sub.id;
                                const matchesFilter = showOnlyWerbering ? b.werbering === true : true;
                                return isCategory && matchesFilter;
                            }).length;
                        }
                    } else if (categoryId === 'clubs') {
                        subCount = (allClubs[sub.id] || []).length;
                    } else {
                        subCount = (sub.items || []).length;
                    }

                    return `
                                    <div class="subcategory-item" onclick="navigateToSubcategory('${categoryId}', '${sub.id}')">
                                        <h4>${sub.title}</h4>
                                        <p>${sub.description || 'Klicken f√ºr Details'}</p>
                                        ${subCount > 0 ? `<div class="sub-count">${subCount} Eintr√§ge</div>` : ''}
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            } else if (category.content) {
                // Show direct content
                mainContent.innerHTML = renderContent(category);
            }
        }

        // Render Business Directory
        function renderBusinessDirectory() {
            return `
                <div class="detail-view fade-in">
                    <h2>üõçÔ∏è Werbering Vorchdorf - Alle Mitgliedsbetriebe</h2>
                    <div class="info-item">
                        <h4>‚ÑπÔ∏è √úber den Werbering</h4>
                        <p>üë• 179 Werbering-Mitgliedsbetriebe in Vorchdorf, Laakirchen und Umgebung. Zus√§tzlich ca. 100 weitere Nicht-Mitglieder.</p>
                        <p>üéÅ Werbering-Gutscheine bei allen Mitgliedern einl√∂sbar</p>
                        <p>üìç Vorchdorf, Laakirchen und Umgebung</p>
                        <p>‚òéÔ∏è 0699 15 05 88 57 ‚Ä¢ ‚úâÔ∏è tipp@werbering-vorchdorf.at</p>
                        <p><a href="https://www.vorchdorfonline.at" target="_blank">üåê www.vorchdorfonline.at</a></p>
                    </div>
                    <div class="business-grid">
                        ${allBusinesses.map(business => {
                // Hole das Icon aus der entsprechenden Subcategory
                let categoryIcon = 'üìÅ';
                for (let catId in categories) {
                    const cat = categories[catId];
                    if (cat.subcategories && cat.subcategories[business.category]) {
                        const sub = cat.subcategories[business.category];
                        categoryIcon = sub.icon || sub.title.charAt(0);
                        break;
                    }
                }
                return `
                            <div class="business-card" ${business.link ? `onclick="window.open('${business.link}', '_blank')" style="cursor: pointer;"` : ''}>
                                <div class="business-name">${business.name}</div>
                                <div class="business-location">${business.location}</div>
                                ${business.link ? `<div class="business-link">üåê Website ‚Üí</div>` : ''}
                            </div>
                            `;
            }).join('')}
                    </div>
                </div>
            `;
        }

        // Navigate to Subcategory
        function navigateToSubcategory(categoryId, subcategoryId) {
            const category = categories[categoryId];
            const subcategory = category.subcategories[subcategoryId];
            if (!subcategory) return;

            // Check for direct link - if exists, open directly
            if (subcategory.directLink) {
                window.open(subcategory.directLink, '_blank');
                return;
            }

            // Check for external link - if exists, open in new tab if absolute
            if (subcategory.externalLink) {
                if (subcategory.externalLink.startsWith('http')) {
                    window.open(subcategory.externalLink, '_blank');
                } else {
                    window.location.href = subcategory.externalLink;
                }
                return;
            }

            currentView = 'subcategory';
            currentSubcategory = subcategoryId;
            navigationHistory.push({ type: 'category', categoryId });

            document.getElementById('backButton').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'instant' });
            document.getElementById('weatherWidget').classList.add('hidden');
            updateBreadcrumb([
                { text: category.title, action: `navigateToCategory('${categoryId}')` },
                { text: subcategory.title }
            ]);

            const mainContent = document.getElementById('mainContent');

            // Special handling for taxi quick call page
            if (categoryId === 'mobility' && subcategoryId === 'taxi_quick') {
                mainContent.innerHTML = `
                    <div class="detail-view fade-in">
                        <h2>‚òéÔ∏è ${subcategory.title}</h2>
                        <p style="color: var(--text-light); margin-bottom: 25px;">${subcategory.description}</p>
                        <div class="taxi-quick-grid">
                            <a href="tel:+436991824621" class="taxi-quick-box">
                                <div class="taxi-quick-icon">üìû</div>
                                <div class="taxi-quick-text">
                                    <strong>Taxi Wiedl</strong>
                                    <p>0699 18246216</p>
                                </div>
                            </a>
                            <a href="tel:+436643366333" class="taxi-quick-box">
                                <div class="taxi-quick-icon">üìû</div>
                                <div class="taxi-quick-text">
                                    <strong>Attwenger Taxi</strong>
                                    <p>0664 3366333</p>
                                </div>
                            </a>
                            <a href="https://www.gollinger.net" target="_blank" class="taxi-quick-box">
                                <div class="taxi-quick-icon">üöå</div>
                                <div class="taxi-quick-text">
                                    <strong>Gollinger</strong>
                                    <p>Website</p>
                                </div>
                            </a>
                            <a href="https://www.mietwagen-aigner.at" target="_blank" class="taxi-quick-box">
                                <div class="taxi-quick-icon">üöï</div>
                                <div class="taxi-quick-text">
                                    <strong>Aigner Taxi</strong>
                                    <p>Website</p>
                                </div>
                            </a>
                        </div>
                    </div>
                `;
            }
            // Special handling for shopping subcategories - show businesses
            else if (categoryId === 'shopping') {
                // Special handling for A-Z directory
                if (subcategoryId === 'all_businesses_az') {
                    // Group businesses by category and sort A-Z - NUR WERBERINGMITGLIEDER
                    const categoryMap = {};

                    // Group by category - nur Werberingmitglieder
                    allBusinesses.filter(b => b.werbering === true).forEach(business => {
                        if (!categoryMap[business.category]) {
                            categoryMap[business.category] = [];
                        }
                        categoryMap[business.category].push(business);
                    });

                    // Sort each category alphabetically by business name
                    Object.keys(categoryMap).forEach(cat => {
                        categoryMap[cat].sort((a, b) => a.name.localeCompare(b.name, 'de'));
                    });

                    // Get category titles from categories object and sort them alphabetically by title (without emoji)
                    const sortedCategories = Object.keys(categoryMap)
                        .map(catId => ({
                            id: catId,
                            title: categories.shopping.subcategories[catId].title,
                            businesses: categoryMap[catId]
                        }))
                        .sort((a, b) => {
                            // Remove emoji for sorting (emoji is usually at start with space after)
                            const titleA = a.title.replace(/^[^\w]*/, '').trim();
                            const titleB = b.title.replace(/^[^\w]*/, '').trim();
                            return titleA.localeCompare(titleB, 'de');
                        });

                    mainContent.innerHTML = `
                        <div class="detail-view fade-in">
                            <h2>üéñÔ∏è ${subcategory.title}</h2>
                            <p style="color: var(--text-light); margin-bottom: 30px;">${subcategory.description}</p>
                            <div style="max-width: 100%;">
                                ${sortedCategories.map(cat => `
                                    <div style="margin-bottom: 40px;">
                                        <h3 style="font-size: 1.3em; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--accent-color);">
                                            ${cat.title}
                                        </h3>
                                        <div class="business-grid">
                                            ${cat.businesses.map(business => `
                                                <div class="business-card" ${business.link ? `onclick="window.open('${business.link}', '_blank')" style="cursor: pointer;"` : ''}>
                                                    <div class="business-header" style="display: flex; justify-content: space-between; align-items: start;">
                                                        <div class="business-name" style="flex: 1;">${business.name}</div>
                                                        <span style="font-size: 1rem; margin-left: 8px;">üéñÔ∏è</span>
                                                    </div>
                                                    <div class="business-location">üìç ${business.location}</div>
                                                    ${business.search ? `<div class="business-services" style="font-size: 0.85rem; color: var(--text-light); margin-top: 6px;">üîß ${business.search}</div>` : ''}
                                                    ${business.link ? `<div class="business-link" style="margin-top: 8px; font-weight: 500;">üåê Website ‚Üí</div>` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    const categoryBusinesses = allBusinesses.filter(b =>
                        b.category === subcategoryId &&
                        (!showOnlyWerbering || b.werbering === true)
                    );
                    mainContent.innerHTML = `
                        <div class="detail-view fade-in">
                            <h2>${subcategory.title}</h2>
                            <p style="color: var(--text-light); margin-bottom: 20px;">${subcategory.description}</p>
                            <div class="business-grid">
                                ${categoryBusinesses.map(business => `
                                    <div class="business-card" ${business.link ? `onclick="window.open('${business.link}', '_blank')" style="cursor: pointer;"` : ''}>
                                        <div class="business-header" style="display: flex; justify-content: space-between; align-items: start;">
                                            <div class="business-name">${business.name}</div>
                                            ${business.werbering ? `<span style="font-size: 1.2rem;" title="Werberingmitglied">üéñÔ∏è</span>` : ''}
                                        </div>
                                        <div class="business-location">üìç ${business.location}</div>
                                        ${business.search ? `<div class="business-services" style="font-size: 0.85rem; color: var(--text-light); margin-top: 6px;">üîß ${business.search}</div>` : ''}
                                        ${business.link ? `<div class="business-link" style="margin-top: 8px; font-weight: 500;">üåê Website ‚Üí</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            } else {
                // Special handling for clubs - show both website and vorchdorfonline link
                if (categoryId === 'clubs') {
                    mainContent.innerHTML = `
                        <div class="detail-view fade-in">
                            <h2>${subcategory.title}</h2>
                            <p style="color: var(--text-light); margin-bottom: 20px;">${subcategory.description}</p>
                            <div class="items-grid">
                                ${subcategory.items.map(item => `
                                    <a href="${item.website || item.link}" target="_blank" class="item-card item-card-link">
                                        <div class="item-card-title">${item.title}</div>
                                        <div class="item-card-info">
                                            ${item.info.map(info => `<p>${info}</p>`).join('')}
                                        </div>
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    // Normal subcategory display for other categories
                    mainContent.innerHTML = `
                        <div class="detail-view fade-in">
                            <h2>${category.icon} ${subcategory.title}</h2>
                            <div class="items-grid">
                                ${subcategory.items.map(item => `
                                    <a href="${item.link || '#'}" target="_blank" class="item-card item-card-link">
                                        <div class="item-card-title">${item.title}</div>
                                        <div class="item-card-info">
                                            ${item.info.map(info => `<p>${info}</p>`).join('')}
                                        </div>
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Render Content
        function renderContent(category) {
            // Handle mixed type (like administration with intro + subcategories)
            if (category.content.type === 'mixed') {
                return `
                    <div class="detail-view fade-in">
                        <h2>${category.icon} ${category.title}</h2>
                        ${category.content.intro ? category.content.intro.map(item => `
                            <div class="info-item">
                                <h4>${item.title}</h4>
                                ${item.info.map(info => `<p>${info}</p>`).join('')}
                                ${item.link ? `<p><a href="${item.link}" target="_blank">‚Üí Mehr Informationen</a></p>` : ''}
                            </div>
                        `).join('') : ''}
                        ${category.subcategories ? `
                            <h3 style="margin-top: 30px;">Bereiche & Services</h3>
                            <div class="subcategory-list">
                                ${Object.values(category.subcategories).map(sub => `
                                    <div class="subcategory-item" onclick="navigateToSubcategory('${category.id}', '${sub.id}')">
                                        <h4>${sub.title}</h4>
                                        <p>${sub.description || ''}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Handle list type (like education)
            if (category.content.type === 'list') {
                return `
                    <div class="detail-view fade-in">
                        <h2>${category.icon} ${category.title}</h2>
                        <div class="info-item">
                            <p style="color: var(--text-light); margin-bottom: 20px;">Alle Bildungseinrichtungen in Vorchdorf - Details auf der Gemeinde-Website:</p>
                        </div>
                        <div class="items-grid">
                            ${category.content.items.map(item => `
                                <a href="${item.link || '#'}" target="_blank" class="item-card item-card-link">
                                    <div class="item-card-title">${item.title}</div>
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Handle section type (like emergency)
            return `
                <div class="detail-view fade-in">
                    <h2>${category.icon} ${category.title}</h2>
                    ${category.content.sections.map(section => {
                // Verstecke spezifische Header auf Mobile/Tablet
                const hideClass = (section.title.includes('Herzlich willkommen') || section.title.includes('Notfall-Standorte')) ? 'mobile-hide-header' : '';
                return `
                        <div class="${hideClass}">
                            <h3>${section.title}</h3>
                            ${section.items.map(item => `
                                <div class="info-item">
                                    <h4>${item.title}</h4>
                                    ${item.info.map(info => `<p>${info}</p>`).join('')}
                                    ${item.wasteCalendar ? `<p><a href="#" onclick="event.preventDefault(); openWasteCalendar();">‚Üí M√ºllkalender √∂ffnen</a></p>` : item.link ? `<p><a href="${item.link}" target="_blank">‚Üí Mehr Informationen</a></p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        // Go Back
        function handleFloatingBack() {
            if (currentView === 'regionale_produkte' && (rpCurrentView === 'companies' || rpCurrentView === 'az')) {
                rpGoBack();
            } else {
                goBack();
            }
        }
        function goBack() {
            window.scrollTo({ top: 0, behavior: 'instant' });
            if (navigationHistory.length === 0) {
                renderHome();
                return;
            }

            const last = navigationHistory.pop();
            if (last.type === 'home') {
                renderHome();
            } else if (last.type === 'category') {
                navigateToCategory(last.categoryId);
            }
        }

        // Go back to home
        function goHome() {
            navigationHistory = [];
            // Zeige Footer wieder wenn zur Home zur√ºck
            const mainFooter = document.getElementById('mainFooter');
            if (mainFooter) {
                mainFooter.style.display = 'block';
            }
            document.querySelector('.search-container').classList.remove('hidden');
            document.getElementById('floatingBackButton').classList.remove('visible');
            renderHome();

        }

        // Open Waste Calendar
        function openWasteCalendar() {
            window.location.href = './muellkalender-vorchdorf-final.html';
        }

        // Update Breadcrumb
        function updateBreadcrumb(items) {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.classList.remove('hidden');

            let html = '<span class="breadcrumb-item" style="cursor: pointer;" onclick="renderHome()">üè† Start</span>';

            items.forEach((item, index) => {
                html += '<span class="breadcrumb-separator">‚Ä∫</span>';
                if (item.action) {
                    html += `<span class="breadcrumb-item" style="cursor: pointer;" onclick="${item.action}">${item.text}</span>`;
                } else {
                    html += `<span class="breadcrumb-item">${item.text}</span>`;
                }
            });

            breadcrumb.innerHTML = html;
        }

        // Intelligent Search Mappings
        const searchMappings = {
            // Kategorie-Synonyme
            'bauen': ['construction', 'Bauen', 'Wohnen', 'Einrichten', 'Bau'],
            'bau': ['construction', 'Bauen', 'Wohnen', 'Einrichten'],
            'wohnen': ['construction', 'Bauen', 'Wohnen', 'Einrichten'],
            'einrichten': ['construction', 'Bauen', 'Wohnen', 'Einrichten'],
            'handwerker': ['construction', 'Bauen', 'Wohnen'],

            'hotel': ['gastro', 'Hotelerie', 'Gastronomie', 'Hotel', 'Pension', 'Bed & Breakfast'],
            'restaurant': ['gastro', 'Gastronomie', 'Restaurant', 'Gasthaus', 'Wirtshaus'],
            'gasthaus': ['gastro', 'Gastronomie', 'Gasthaus', 'Restaurant', 'Wirtshaus'],
            'cafe': ['gastro', 'Caf√©', 'Kaffee', 'B√§ckerei'],
            'kaffee': ['gastro', 'Caf√©', 'Kaffee'],

            'fris√∂r': ['beauty', 'Friseur', 'Haar', 'SCHNITT', 'HAARGENAU', 'HAARSTUDIO', 'BARBERSHOP'],
            'friseur': ['beauty', 'Friseur', 'Haar', 'SCHNITT', 'HAARGENAU', 'HAARSTUDIO', 'BARBERSHOP'],
            'haar': ['beauty', 'Haar', 'Friseur', 'SCHNITT', 'HAARGENAU', 'HAARSTUDIO'],
            'barbier': ['beauty', 'BARBERSHOP', 'Friseur', 'Haar'],

            'b√§cker': ['food', 'gastro', 'B√§ckerei', 'CAF√â', 'Probst', 'Gw√∂lb', 'Resch'],
            'b√§ckerei': ['food', 'gastro', 'B√§ckerei', 'CAF√â', 'Probst', 'Gw√∂lb', 'Resch'],
            'brot': ['food', 'B√§ckerei', 'CAF√â'],

            'arzt': ['healthcare', 'Arzt', 'Apotheke', 'Gesundheit', 'Medizin', 'Allgemeinmedizin'],
            'apotheke': ['healthcare', 'Apotheke', 'Medizin', 'Gesundheit'],
            'zahnarzt': ['dentists', 'Zahnarzt', 'Zahn√§rzte', 'Klinkert', 'Krenmayr', 'Zahn'],
            'zahn': ['dentists', 'Zahnarzt', 'Zahn√§rzte', 'Klinkert', 'Krenmayr'],
            'kinderarzt': ['specialists', 'Kinderarzt', 'Kinder√§rzte', 'Kinder- und Fach√§rzte', 'P√§diatrie'],
            'facharzt': ['specialists', 'Facharzt', 'Fach√§rzte', 'Kinder- und Fach√§rzte', 'Spezialist'],
            'gesundheit': ['healthcare', 'Gesundheit', 'Arzt', 'Apotheke'],
            'sozial': ['social', 'Sozial', 'Hilfe', 'Sozialfonds', 'WIR helfen', 'Beratung'],
            'hilfe': ['social', 'Hilfe', 'Sozialfonds', 'WIR helfen', 'Unterst√ºtzung'],

            'schule': ['education', 'Schule', 'Volksschule', 'Mittelschule', 'Bildung'],
            'bildung': ['education', 'Bildung', 'Schule', 'Kindergarten', 'Lernen', 'Otelo'],
            'kindergarten': ['education', 'Kindergarten', 'Kinder', 'Bildung'],
            'bibliothek': ['education', 'Bibliothek', 'B√ºcherei', 'Bildung'],
            'otelo': ['education', 'Otelo', 'Offenes Technologielabor', 'Bildung'],
            'fitness': ['beauty', 'FITNESS', 'Sport', 'Training', 'Gym'],
            'sport': ['beauty', 'FITNESS', 'Sport', 'Training'],

            'auto': ['cars', 'KFZ', 'Auto', 'Werkstatt', 'Autohaus'],
            'kfz': ['cars', 'KFZ', 'Auto', 'Werkstatt'],
            'werkstatt': ['cars', 'KFZ', 'Werkstatt', 'Auto'],
            'fahrrad': ['cars', 'Fahrrad', 'Rad', 'Bike'],

            'bank': ['banks', 'Bank', 'Sparkasse', 'Raiffeisen', 'Geld'],
            'geld': ['banks', 'Bank', 'Sparkasse', 'Versicherung'],
            'versicherung': ['banks', 'Versicherung', 'Bank'],

            'anwalt': ['legal', 'Anwalt', 'Rechtsanwalt', 'Notar', 'Recht'],
            'rechtsanwalt': ['legal', 'Rechtsanwalt', 'Anwalt', 'Recht'],
            'notar': ['legal', 'Notar', 'Notariat'],

            'steuer': ['accounting', 'Steuer', 'Buchhaltung', 'Steuerberater'],
            'buchhaltung': ['accounting', 'Buchhaltung', 'Steuer'],

            'blumen': ['flowers', 'Blumen', 'Florist', 'G√§rtnerei'],
            'garten': ['flowers', 'G√§rtnerei', 'Garten', 'Blumen'],

            'essen': ['food', 'gastro', 'Lebensmittel', 'Essen', 'Restaurant'],
            'lebensmittel': ['food', 'Lebensmittel', 'Essen', 'Supermarkt', 'SPAR'],
            'supermarkt': ['food', 'SPAR', 'Lebensmittel'],

            'mode': ['fashion', 'Mode', 'Kleidung', 'Schuhe'],
            'kleidung': ['fashion', 'Mode', 'Kleidung', 'Bekleidung'],
            'schuhe': ['fashion', 'Schuhe', 'Mode'],

            'taxi': ['transport', 'Taxi', 'Transport', 'Fahrdienst'],
            'transport': ['transport', 'Transport', 'Taxi', 'Spedition'],

            'schmuck': ['jewelry', 'Schmuck', 'Juwelier', 'Uhren'],
            'uhren': ['jewelry', 'Uhren', 'Schmuck', 'Juwelier'],

            'tankstelle': ['gas', 'Tankstelle', 'Tanken', 'Benzin'],
            'tanken': ['gas', 'Tankstelle'],

            'foto': ['photo', 'Fotografie', 'Foto', 'Fotograf'],
            'fotograf': ['photo', 'Fotografie', 'Fotograf'],

            // Vereine
            'verein': ['clubs', 'Verein', 'Sport', 'Kultur', 'Musik'],
            'vereine': ['clubs', 'Vereine', 'Sport', 'Kultur', 'Musik'],

            // Sportvereine
            'union': ['clubs', 'sport', 'Union', 'Badminton', 'Laufgruppe', 'Schiclub', 'Tennis', 'Vikings', 'Tischtennis'],
            'ask√∂': ['clubs', 'sport', 'ASK√ñ', 'Fu√üball', 'Stocksport'],
            'askoe': ['clubs', 'sport', 'ASK√ñ', 'Fu√üball', 'Stocksport'],
            'fussball': ['clubs', 'sport', 'Fu√üball', 'ASK√ñ'],
            'fu√üball': ['clubs', 'sport', 'Fu√üball', 'ASK√ñ'],
            'tennis': ['clubs', 'sport', 'Tennis', 'Tennisclub', 'BAM.wohnen'],
            'badminton': ['clubs', 'sport', 'Badminton', 'Union'],
            'tischtennis': ['clubs', 'sport', 'Tischtennis', 'Union'],
            'basketball': ['clubs', 'sport', 'Basketball', 'Vikings', 'Union'],
            'vikings': ['clubs', 'sport', 'Vikings', 'Basketball'],
            'schi': ['clubs', 'sport', 'Schi', 'Schiclub', 'Seyr Dach'],
            'ski': ['clubs', 'sport', 'Schi', 'Schiclub', 'Seyr Dach'],
            'laufen': ['clubs', 'sport', 'Laufen', 'Laufgruppe', 'Union'],
            'stocksport': ['clubs', 'sport', 'Stocksport', 'ASK√ñ'],
            'fischen': ['clubs', 'sport', 'Fischen', 'Fischerclub', 'Almtal'],
            'angeln': ['clubs', 'sport', 'Angeln', 'Fischerclub', 'Almtal'],
            'sch√ºtzen': ['clubs', 'sport', 'Sch√ºtzen', 'Sch√ºtzenverein', 'Schie√üen', 'Theuerwang'],
            'schiessen': ['clubs', 'sport', 'Schie√üen', 'Sch√ºtzen'],
            'fitness': ['clubs', 'sport', 'Fitness', 'Body Strength', 'Training'],
            'workout': ['clubs', 'sport', 'Workout', 'Body Strength'],

            // Musikvereine
            'musik': ['clubs', 'musik', 'Musik', 'Marktmusik', 'Musikverein', 'Chor'],
            'blasmusik': ['clubs', 'musik', 'Blasmusik', 'Marktmusik', 'Siebenb√ºrger'],
            'chor': ['clubs', 'musik', 'Chor', 'S√§ngerbund', 'Gesang', 'Sunshine', 'Trinitatis'],
            'singen': ['clubs', 'musik', 'Singen', 'Chor', 'S√§ngerbund'],
            'marktmusik': ['clubs', 'musik', 'Marktmusik', 'MMV'],

            // Kulturvereine
            'kultur': ['clubs', 'kultur', 'Kultur', 'Theater', 'Heimatverein', 'Museum'],
            'theater': ['clubs', 'kultur', 'Theater', 'Theatergruppe'],
            'museum': ['clubs', 'kultur', 'Museum', 'Heimatverein'],
            'heimatverein': ['clubs', 'kultur', 'Heimatverein', 'Museum'],
            'fasching': ['clubs', 'kultur', 'Fasching', 'Vori Dori', 'Faschingsgilde'],
            'foto': ['clubs', 'kultur', 'Foto', 'Fotoklub', 'Naturfreunde'],
            'fotografie': ['clubs', 'kultur', 'Fotografie', 'Fotoklub'],
            'kitzmantelfabrik': ['clubs', 'kultur', 'Kitzmantelfabrik', 'Kulturvilla'],

            // Sport & Fitness (neue Kategorie)
            'fitnessstudio': ['sport_fitness', 'fitness', 'Fitnessstudio', 'Training', 'Gym'],
            'gym': ['sport_fitness', 'fitness', 'Fitnessstudio', 'Training'],
            'anytime': ['sport_fitness', 'fitness', 'ANYTIME FITNESS', 'Fitnessstudio'],
            'training': ['sport_fitness', 'fitness', 'Training', 'Fitnessstudio'],
            'spielplatz': ['leisure', 'playgrounds', 'Spielplatz', 'Kinder', 'Spielger√§te', 'Kindertraum'],
            'spielpl√§tze': ['leisure', 'playgrounds', 'Spielplatz', 'Kinder', 'Spielger√§te'],
            'kinder': ['leisure', 'playgrounds', 'Kinder', 'Spielplatz', 'Kinderfreundlich'],
            'schulstra√üe': ['leisure', 'playgrounds', 'Schulstra√üe', 'Spielplatz'],
            'krumphuberweg': ['leisure', 'playgrounds', 'Krumphuberweg', 'Spielplatz'],
            'kirchham': ['leisure', 'playgrounds', 'Kirchham', 'Spielplatz'],

            // Notfall & Sicherheit
            'polizei': ['emergency', 'Polizei', 'Sicherheit', 'Notfall', 'Vorchdorf'],
            'rettung': ['emergency', 'Rettung', 'Notfall', 'Rettungsdienst', 'Ambulanz'],
            'feuerwehr': ['emergency', 'Feuerwehr', 'Notfall', 'Brand', 'Hilfe'],
            'notruf': ['emergency', 'Notruf', 'Notfall', '144', '133', '122'],
            'notfall': ['emergency', 'Notfall', 'Notfallkontakte', 'Standorte', 'Rettung'],
            'defibrillator': ['emergency', 'Defibrillator', 'AED', 'Pfarrhof', 'Rettung'],
            'aed': ['emergency', 'AED', 'Defibrillator'],
            'notfallstandorte': ['emergency', 'Notfall', 'Standorte', 'Polizei', 'Feuerwehr'],

            // Sozial & Jugend
            'jugend': ['clubs', 'soziales', 'Jugend', 'Jugendzentrum', 'Pfadfinder', 'Landjugend'],
            'juz': ['clubs', 'soziales', 'JUZ', 'Jugendzentrum'],
            'pfadfinder': ['clubs', 'soziales', 'Pfadfinder', 'Jugend'],
            'landjugend': ['clubs', 'soziales', 'Landjugend', 'Jugend'],
            'otelo': ['clubs', 'soziales', 'OTELO', 'Technologielabor', 'Offenes Labor'],
            'eltern': ['clubs', 'soziales', 'Eltern', 'Elternverein', 'Schule'],

            // Rettungsorganisationen
            'wasserrettung': ['clubs', 'sport', 'Wasserrettung', '√ñWR', 'Rettung'],
            '√∂wr': ['clubs', 'sport', '√ñWR', 'Wasserrettung'],
            'rotes kreuz': ['clubs', 'soziales', 'Rotes Kreuz', 'Rettung'],
            'roteskreuz': ['clubs', 'soziales', 'Rotes Kreuz', 'Rettung'],
            'rettung': ['clubs', 'Rettung', 'Wasserrettung', 'Rotes Kreuz'],

            // Religion
            'kirche': ['clubs', 'religion', 'Kirche', 'Katholisch', 'Evangelisch'],
            'katholisch': ['clubs', 'religion', 'Katholisch', 'Pfarre', 'Jungschar', 'Jugend'],
            'evangelisch': ['clubs', 'religion', 'Evangelisch', 'Kirche'],
            'jungschar': ['clubs', 'religion', 'Jungschar', 'Katholisch', 'Kinder'],

            // Sonstige
            'bibliothek': ['clubs', 'sonstiges', 'Bibliothek', 'B√ºcherei'],
            'werbering': ['clubs', 'sonstiges', 'Werbering', 'Wirtschaft'],
            'naturfreunde': ['clubs', 'sport', 'kultur', 'Naturfreunde', 'Fotoklub', 'Wandern'],
            'weltladen': ['clubs', 'soziales', 'Weltladen', 'Fair Trade']
        };

        // Normalisiere deutsche Umlaute und Sonderzeichen f√ºr besseres Matching
        function normalizeString(str) {
            if (!str) return '';
            return str.toLowerCase()
                .replace(/√§/g, 'ae')
                .replace(/√∂/g, 'oe')
                .replace(/√º/g, 'ue')
                .replace(/√ü/g, 'ss')
                .trim();
        }

        // Intelligente Synonym-Suche mit Fuzzy Matching
        function getSearchSynonyms(term) {
            const normalized = normalizeString(term);
            const synonymMap = {
                // Friseur/Friseuse Variationen
                'frisoe': ['friseur', 'friseurin', 'friseuse', 'haarschnitt', 'frisur', 'barber', 'barbershop', 'haargenau', 'haarstudio', 'schnitt'],
                'friseur': ['friseuse', 'friseurin', 'haarschnitt', 'barber', 'barbershop', 'haarschneid', 'haargenau', 'haarstudio', 'schnitt'],

                // Tabak/Zigaretten Variationen
                'zigaretten': ['tabak', 'trafik', 'rauchen', 'rauchwaren', 'smoker'],
                'tabak': ['zigaretten', 'trafik', 'rauchen', 'rauchwaren'],
                'trafik': ['tabak', 'zigaretten', 'rauchen', 'rauchwaren'],
                'rauchen': ['tabak', 'trafik', 'zigaretten', 'rauchwaren'],
                'rauchwaren': ['tabak', 'trafik', 'zigaretten', 'rauchen'],

                // Handwerker Variationen
                'handwerker': ['installateur', 'elektro', 'klempner', 'maler'],
                'installateur': ['installation', 'gas', 'heizung', 'sanitaer'],
                'klempner': ['installateur', 'sanitaer', 'heizung'],
                'wasser': ['installateur', 'klempner', 'rohre', 'sanitaer', 'heizung', 'installation'],
                'rohre': ['rohrverlegung', 'rohrleitungen', 'installation', 'klempner', 'sanitaer'],
                'maler': ['anstreicher', 'malermeister', 'malerarbeiten'],
                'anstreicher': ['maler', 'malermeister', 'malerarbeiten', 'anstrich'],

                // Arzt Variationen
                'arzt': ['doktor', 'zahnarzt', 'zahndoktor', 'facharzt', 'allgemeinarzt'],
                'zahnarzt': ['zahndoktor', 'dental', 'zahn', 'zaehnchen'],
                'zahndoktor': ['zahnarzt', 'dental', 'zahn'],

                // Auto Variationen
                'auto': ['auto', 'kfz', 'fahrzeug', 'wagen', 'pkw', 'automobile', 'autohaus', 'werkstatt'],
                'werkstatt': ['auto', 'kfz', 'service', 'reparatur'],
                'tankstelle': ['benzin', 'diesel', 'zapfsaeule', 'tanken'],

                // Restaurant/Gastro Variationen
                'restaurant': ['gaststaette', 'gasthof'],
                'gaststaette': ['gasthof', 'restaurant'],
                'pizzeria': ['pizza', 'italiener'],
                'cafe': ['kaffee', 'kaffe', 'baecker', 'baeckerei', 'bakery'],
                'baecker': ['baeckerei', 'cafe', 'kaffee', 'broetchen'],

                // Apotheke
                'apotheke': ['pharmazie', 'pharmazeut', 'medikament', 'arznei'],

                // Bank Variationen
                'bank': ['sparkasse', 'kasse', 'geldautomat', 'geldwechsel'],
                'sparkasse': ['bank', 'geldautomat', 'kasse'],

                // Fitness/Sport
                'fitness': ['gym', 'fitnessstudio', 'training', 'krafttraining', 'sport'],
                'gym': ['fitness', 'fitnessstudio', 'training'],

                // Frisur/Haarpflege
                'haarschnitt': ['friseur', 'friseurin', 'friseuse', 'schneid'],
                'haarschneid': ['friseur', 'friseuse', 'haarschnitt'],

                // Kleidung/Mode
                'mode': ['kleidung', 'kleidungsgschaft', 'boutique', 'fashion'],
                'kleidung': ['mode', 'boutique', 'fashion', 'garderobe'],

                // Spielzeug/Kinderartikel
                'spielzeug': ['spielwaren', 'kinderspielzeug', 'babyartikel'],
                'spielwaren': ['spielzeug', 'kinderspielzeug'],

                // Moebel
                'moebel': ['einrichtung', 'einrichtungshaus', 'mobilistaer', 'moebelladen'],
                'einrichtung': ['moebel', 'einrichtungshaus', 'mobilistaer'],

                // Blumen/Florist
                'blumen': ['florist', 'blumenladen', 'bluemchen', 'straus'],
                'florist': ['blumen', 'blumenladen', 'straus'],

                // Buecher/Buchhandlung
                'buecher': ['buchhandlung', 'buchhandel', 'buch', 'buecher', 'lesen'],
                'buchhandlung': ['buecher', 'buchhandel', 'buch'],

                // Elektro
                'elektro': ['elektrotechnik', 'elektrogeraete', 'strom'],
                'elektrotechnik': ['elektro', 'elektrogeraete'],

                // Schluessel/Schlosser
                'schluessel': ['schlosser', 'schloss', 'schluesseldienst'],
                'schlosser': ['schluessel', 'schloss', 'schluesseldienst'],

                // Photographie/Fotograf
                'foto': ['fotograf', 'fotografie', 'fotostudio', 'bilder'],
                'fotograf': ['foto', 'fotografie', 'fotostudio'],
                'fotografie': ['fotograf', 'foto', 'fotostudio'],

                // Versicherung
                'versicherung': ['versicherer', 'versicherungsagent', 'versicherungsmakler'],
                'versicherungsmakler': ['versicherung', 'versicherer'],

                // Rechtsanwalt
                'anwalt': ['rechtsanwalt', 'anwaeltin', 'jura', 'legal'],
                'rechtsanwalt': ['anwalt', 'anwaeltin', 'jura', 'legal'],

                // Zahnarzt Alternative
                'zaehne': ['zahnarzt', 'zahndoktor', 'dental', 'zahn'],
                'zahn': ['zahnarzt', 'zahndoktor', 'zaehne', 'dental'],

                // Verein/Club
                'verein': ['club'],
                'club': ['verein'],

                // Schule
                'schule': ['schulen', 'gymnasium', 'gymnasium', 'volksschule', 'unterstufe', 'oberstufe'],
                'kindergarten': ['vorschule', 'kinderbetreuung', 'vorschulisch'],

                // Kirche/Religion
                'kirche': ['religion', 'kirchen', 'evangelisch', 'katholisch'],
                'religion': ['kirche'],
                'pfarr': ['pfarre', 'pfarrkirche', 'pfarrer'],
            };

            // Sammle ALLE m√∂glichen Matches
            const allSynonyms = new Set(); // NICHT mit term starten - nur echte Matches

            // Suche in der Map nach Matches
            Object.entries(synonymMap).forEach(([key, synonyms]) => {
                // NUR wenn der Suchbegriff mit dem Key ANF√ÑNGT oder der Key ANF√ÑNGT mit dem Suchbegriff
                // (nicht bidirektional bei Synonymen, nur bei Keys)
                if (key.startsWith(normalized) || normalized.startsWith(key)) {
                    // F√ºge den Key und all seine Synonyme hinzu
                    allSynonyms.add(key);
                    synonyms.forEach(syn => allSynonyms.add(syn));
                }
                // ODER wenn ein Synonym mit dem Suchbegriff ANF√ÑNGT
                else if (synonyms.some(syn => syn.startsWith(normalized))) {
                    // F√ºge den Key und all seine Synonyme hinzu
                    allSynonyms.add(key);
                    synonyms.forEach(syn => allSynonyms.add(syn));
                }
            });

            // IMMER den Original-Suchbegriff hinzuf√ºgen (f√ºr direkte Firmennamen-Matches)
            allSynonyms.add(term);

            return Array.from(allSynonyms);
        }

        // Intelligente Such-Funktion mit Fuzzy Matching
        function performSmartSearch(text, searchVariations, normalizedSearchTerm) {
            // text = zu durchsuchender Text
            // searchVariations = Array von Such-Begriffen mit Synonymen
            // normalizedSearchTerm = normalisierte Version (Umlaute ersetzt)

            const textLower = text.toLowerCase();
            const textNormalized = normalizeString(text);

            // √úberpr√ºfe alle Variationen
            return searchVariations.some(variant => {
                const normalizedVariant = normalizeString(variant);
                return textLower.includes(variant) || textNormalized.includes(normalizedVariant);
            });
        }

        // Live Search Function with Intelligence
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            if (searchTerm.length === 0) {
                renderHome();
                return;
            }

            const results = [];

            // Hole alle Synonyme und Variationen
            const searchVariations = getSearchSynonyms(searchTerm);
            const normalizedSearchTerm = normalizeString(searchTerm);

            // VOLLTEXTSUCHE - Durchsuche ALLES mit Smart-Search!

            // 1. Suche in KATEGORIEN (h√∂chste Priorit√§t)
            Object.values(categories).forEach(category => {
                const categoryText = `${category.title} ${category.description} ${category.id}`;

                if (performSmartSearch(categoryText, searchVariations, normalizedSearchTerm)) {
                    results.push({
                        type: 'category',
                        priority: 1,
                        category: category,
                        matchText: category.title
                    });
                }
            });

            // 2. Suche in UNTERKATEGORIEN (Vereine, Werbering-Kategorien, etc.)
            Object.values(categories).forEach(category => {
                if (category.subcategories) {
                    Object.values(category.subcategories).forEach(sub => {
                        const subText = `${sub.title} ${sub.description || ''} ${sub.id}`;

                        if (performSmartSearch(subText, searchVariations, normalizedSearchTerm)) {
                            results.push({
                                type: 'subcategory',
                                priority: 2,
                                category: category,
                                subcategory: sub,
                                matchText: sub.title
                            });
                        }

                        // Suche auch in den ITEMS der Unterkategorie (z.B. einzelne Vereine)
                        if (sub.items) {
                            sub.items.forEach(item => {
                                // Durchsuche ALLES: Titel, Info, Link, Website
                                const itemText = [
                                    item.title || '',
                                    ...(item.info || []),
                                    item.link || '',
                                    item.website || '',
                                    item.email || '',
                                    item.adresse || ''
                                ].join(' ');

                                if (performSmartSearch(itemText, searchVariations, normalizedSearchTerm)) {
                                    results.push({
                                        type: 'item',
                                        priority: 3,
                                        category: category,
                                        subcategory: sub,
                                        item: item,
                                        matchText: item.title
                                    });
                                }
                            });
                        }
                    });
                }

                // Suche auch in CONTENT (z.B. Bildung, Notf√§lle)
                if (category.content) {
                    if (category.content.type === 'list') {
                        category.content.items.forEach(item => {
                            const itemText = `${item.title} ${item.link || ''}`;
                            if (performSmartSearch(itemText, searchVariations, normalizedSearchTerm)) {
                                results.push({
                                    type: 'content-item',
                                    priority: 3,
                                    category: category,
                                    item: item,
                                    matchText: item.title
                                });
                            }
                        });
                    } else if (category.content.sections) {
                        category.content.sections.forEach(section => {
                            section.items.forEach(item => {
                                const itemText = [
                                    item.title || '',
                                    ...(item.info || []),
                                    item.link || ''
                                ].join(' ');

                                if (performSmartSearch(itemText, searchVariations, normalizedSearchTerm)) {
                                    results.push({
                                        type: 'content-item',
                                        priority: 3,
                                        category: category,
                                        item: item,
                                        matchText: item.title
                                    });
                                }
                            });
                        });
                    }
                }
            });

            // 3. Suche in BUSINESSES (Werbering) - mit verbesserter Priorisierung
            allBusinesses.forEach(business => {
                const name = business.name || '';
                const search = business.search || '';
                const location = business.location || '';
                const cat = business.category || '';

                const coreText = `${name} ${search} ${cat}`.toLowerCase();
                const coreTextNormalized = normalizeString(coreText);
                const fullText = `${coreText} ${location}`.toLowerCase();
                const fullTextNormalized = normalizeString(fullText);

                let priority = 4;
                let match = false;

                // Check variations
                for (const variant of searchVariations) {
                    const normalizedVariant = normalizeString(variant);

                    // H√∂chste Priorit√§t: Wort-Treffer im Namen oder Suchbegriffen
                    const wordRegex = new RegExp('\\b' + variant.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                    const normalizedWordRegex = new RegExp('\\b' + normalizedVariant.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');

                    if (wordRegex.test(name) || normalizedWordRegex.test(normalizeString(name))) {
                        priority = 4; // Eigentlich 4.0, aber innerhalb der Businesses
                        match = true;
                        break;
                    }

                    if (wordRegex.test(search) || normalizedWordRegex.test(normalizeString(search))) {
                        priority = 4.1;
                        match = true;
                        break;
                    }

                    // Mittlere Priorit√§t: Teil-Treffer im Namen oder Suchbegriffen
                    if (coreText.includes(variant) || coreTextNormalized.includes(normalizedVariant)) {
                        priority = 4.2;
                        match = true;
                        break;
                    }

                    // Niedrige Priorit√§t: Treffer irgendwo (z.B. Adresse)
                    if (fullText.includes(variant) || fullTextNormalized.includes(normalizedVariant)) {
                        priority = 4.5;
                        match = true;
                        break;
                    }
                }

                if (match) {
                    results.push({
                        type: 'business',
                        priority: priority,
                        business: business,
                        matchText: business.name
                    });
                }
            });

            // 4. Suche in FORMULAREN (Gemeinde-Verwaltung)
            allFormulare.forEach(formular => {
                const text = (formular.title || '').toLowerCase();
                const normalizedText = normalizeString(text);

                for (const variant of searchVariations) {
                    const normalizedVariant = normalizeString(variant);
                    if (text.includes(variant) || normalizedText.includes(normalizedVariant)) {
                        results.push({
                            type: 'formular',
                            priority: 5,
                            formular: formular,
                            matchText: formular.title
                        });
                        break;
                    }
                }
            });

            // 5. Suche in MITARBEITERN (Gemeinde-Verwaltung)
            allMitarbeiter.forEach(person => {
                const text = `${person.name || ''} ${person.email || ''}`.toLowerCase();
                const normalizedText = normalizeString(text);

                for (const variant of searchVariations) {
                    const normalizedVariant = normalizeString(variant);
                    if (text.includes(variant) || normalizedText.includes(normalizedVariant)) {
                        results.push({
                            type: 'mitarbeiter',
                            priority: 5.1,
                            person: person,
                            matchText: person.name
                        });
                        break;
                    }
                }
            });

            // 6. Suche in ABTEILUNGEN (Gemeinde-Verwaltung)
            allAbteilungen.forEach(abteilung => {
                const abtText = `${abteilung.name || ''}`.toLowerCase();
                const normalizedAbtText = normalizeString(abtText);
                let abtMatch = false;

                for (const variant of searchVariations) {
                    const normalizedVariant = normalizeString(variant);
                    if (abtText.includes(variant) || normalizedAbtText.includes(normalizedVariant)) {
                        abtMatch = true;
                        results.push({
                            type: 'abteilung',
                            priority: 5.2,
                            abteilung: abteilung,
                            matchText: abteilung.name
                        });
                        break;
                    }
                }

                // Auch in Mitarbeitern der Abteilung suchen
                if (!abtMatch && abteilung.mitarbeiter) {
                    abteilung.mitarbeiter.forEach(person => {
                        const personText = `${person.name || ''} ${person.funktion || ''} ${person.email || ''}`.toLowerCase();
                        const normalizedPersonText = normalizeString(personText);

                        for (const variant of searchVariations) {
                            const normalizedVariant = normalizeString(variant);
                            if (personText.includes(variant) || normalizedPersonText.includes(normalizedVariant)) {
                                results.push({
                                    type: 'abteilung-person',
                                    priority: 5.3,
                                    abteilung: abteilung,
                                    person: person,
                                    matchText: person.name
                                });
                                break;
                            }
                        }
                    });
                }
            });

            // 7. Suche in GEMEINDEBETRIEBEN
            allGemeindebetriebe.forEach(betrieb => {
                const betText = `${betrieb.name || ''} ${betrieb.beschreibung || ''}`.toLowerCase();
                const normalizedBetText = normalizeString(betText);
                let betMatch = false;

                for (const variant of searchVariations) {
                    const normalizedVariant = normalizeString(variant);
                    if (betText.includes(variant) || normalizedBetText.includes(normalizedVariant)) {
                        betMatch = true;
                        results.push({
                            type: 'gemeindebetrieb',
                            priority: 5.4,
                            betrieb: betrieb,
                            matchText: betrieb.name
                        });
                        break;
                    }
                }

                // Auch in Mitarbeitern des Betriebs suchen
                if (!betMatch && betrieb.mitarbeiter) {
                    betrieb.mitarbeiter.forEach(person => {
                        const personText = `${person.name || ''} ${person.funktion || ''} ${person.email || ''}`.toLowerCase();
                        const normalizedPersonText = normalizeString(personText);

                        for (const variant of searchVariations) {
                            const normalizedVariant = normalizeString(variant);
                            if (personText.includes(variant) || normalizedPersonText.includes(normalizedVariant)) {
                                results.push({
                                    type: 'gemeindebetrieb-person',
                                    priority: 5.5,
                                    betrieb: betrieb,
                                    person: person,
                                    matchText: person.name
                                });
                                break;
                            }
                        }
                    });
                }
            });

            // Sortiere nach Priorit√§t (Kategorien zuerst, dann Unterkategorien, dann Items, dann Businesses)
            results.sort((a, b) => a.priority - b.priority);

            // Entferne Duplikate
            const uniqueResults = [];
            const seen = new Set();

            results.forEach(result => {
                let key;
                if (result.type === 'business') {
                    key = `business-${result.business.name}`;
                } else if (result.type === 'category') {
                    key = `category-${result.category.id}`;
                } else if (result.type === 'subcategory') {
                    key = `subcategory-${result.category.id}-${result.subcategory.id}`;
                } else if (result.type === 'item') {
                    key = `item-${result.category.id}-${result.subcategory.id}-${result.item.title}`;
                } else if (result.type === 'content-item') {
                    key = `content-${result.category.id}-${result.item.title}`;
                } else if (result.type === 'formular') {
                    key = `formular-${result.formular.title}`;
                } else if (result.type === 'mitarbeiter') {
                    key = `mitarbeiter-${result.person.name}`;
                } else if (result.type === 'abteilung') {
                    key = `abteilung-${result.abteilung.name}`;
                } else if (result.type === 'abteilung-person') {
                    key = `abteilung-person-${result.abteilung.name}-${result.person.name}`;
                } else if (result.type === 'gemeindebetrieb') {
                    key = `gemeindebetrieb-${result.betrieb.name}`;
                } else if (result.type === 'gemeindebetrieb-person') {
                    key = `gemeindebetrieb-person-${result.betrieb.name}-${result.person.name}`;
                }

                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueResults.push(result);
                }
            });

            // Reset navigation history
            navigationHistory = [];

            // Display results
            displaySearchResults(searchTerm, uniqueResults);
        }

        function displaySearchResults(searchTerm, results) {
            const content = document.getElementById('mainContent');
            document.getElementById('backButton').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'instant' });
            document.getElementById('emergencyBanner').classList.add('hidden');
            document.getElementById('weatherWidget').classList.add('hidden');
            updateBreadcrumb([{ text: `Suchergebnisse f√ºr "${searchTerm}"` }]);

            if (results.length === 0) {
                content.innerHTML = `
                    <div class="info-section fade-in">
                        <h2>Keine Ergebnisse gefunden</h2>
                        <p>F√ºr "${searchTerm}" wurden keine Ergebnisse gefunden.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="info-section fade-in">
                    <h2>Suchergebnisse: ${results.length} ${results.length === 1 ? 'Treffer' : 'Treffer'}</h2>
                </div>
                <div class="businesses-grid">
            `;

            results.forEach(result => {
                if (result.type === 'category') {
                    // Hauptkategorie
                    html += `
                        <div class="business-card" onclick="navigateToCategory('${result.category.id}')" style="cursor: pointer;">
                            <div class="business-name">${result.category.icon} ${result.category.title}</div>
                            <div class="business-location">${result.category.description}</div>
                        </div>
                    `;
                } else if (result.type === 'subcategory') {
                    // Unterkategorie (z.B. Sport, Kultur bei Vereinen)
                    html += `
                        <div class="business-card" onclick="navigateToSubcategory('${result.category.id}', '${result.subcategory.id}')" style="cursor: pointer;">
                            <div class="business-name">${result.subcategory.title}</div>
                            <div class="business-location">üìÇ ${result.category.title} ‚Üí ${result.subcategory.description || ''}</div>
                        </div>
                    `;
                } else if (result.type === 'item') {
                    // Einzelne Items in Unterkategorien (z.B. einzelne Vereine)
                    const item = result.item;
                    html += `
                        <div class="business-card" onclick="navigateToSubcategory('${result.category.id}', '${result.subcategory.id}')" style="cursor: pointer;">
                            <div class="business-name">${item.title}</div>
                            <div class="business-location">üìÇ ${result.category.title} ‚Üí ${result.subcategory.title}</div>
                            ${item.info && item.info[0] ? `<p style="font-size: 0.9em; color: var(--text-light); margin-top: 5px;">${item.info[0]}</p>` : ''}
                        </div>
                    `;
                } else if (result.type === 'content-item') {
                    // Content items (z.B. Bildungseinrichtungen)
                    html += `
                        <div class="business-card" onclick="navigateToCategory('${result.category.id}')" style="cursor: pointer;">
                            <div class="business-name">${result.item.title}</div>
                            <div class="business-location">üìÇ ${result.category.title}</div>
                        </div>
                    `;
                } else if (result.type === 'business') {
                    // Werbering-Betriebe
                    const b = result.business;
                    html += `
                        <div class="business-card">
                            <div class="business-name">${b.name}</div>
                            <div class="business-location">üìç ${b.location}</div>
                            ${b.link ? `<a href="${b.link}" class="business-link" target="_blank">üåê Website besuchen</a>` : ''}
                        </div>
                    `;
                } else if (result.type === 'formular') {
                    // Formulare
                    const f = result.formular;
                    html += `
                        <div class="business-card">
                            <div class="business-name">üìÑ ${f.title}</div>
                            <div class="business-location">üèõÔ∏è Gemeinde & Verwaltung ‚Üí Formulare</div>
                            <a href="${f.url}" class="business-link" target="_blank">‚Üí Formular √∂ffnen</a>
                        </div>
                    `;
                } else if (result.type === 'mitarbeiter') {
                    // Mitarbeiter
                    const p = result.person;
                    html += `
                        <div class="business-card" onclick="window.open('./gemeinde-verwaltung/mitarbeiter.html', '_self')" style="cursor: pointer;">
                            <div class="business-name">üë§ ${p.name}</div>
                            <div class="business-location">üèõÔ∏è Gemeindemitarbeiter</div>
                            ${p.telefon ? `<p style="font-size: 0.9em; color: var(--text-light); margin-top: 5px;">‚òéÔ∏è ${p.telefon}</p>` : ''}
                            ${p.email ? `<p style="font-size: 0.9em; color: var(--text-light);">üìß ${p.email}</p>` : ''}
                        </div>
                    `;
                } else if (result.type === 'abteilung') {
                    // Abteilungen
                    const a = result.abteilung;
                    html += `
                        <div class="business-card" onclick="window.open('./gemeinde-verwaltung/abteilungen.html', '_self')" style="cursor: pointer;">
                            <div class="business-name">üèõÔ∏è ${a.name}</div>
                            <div class="business-location">Gemeindeamt Vorchdorf</div>
                            ${a.url ? `<a href="${a.url}" class="business-link" target="_blank" onclick="event.stopPropagation()">‚Üí Mehr Infos</a>` : ''}
                        </div>
                    `;
                } else if (result.type === 'abteilung-person') {
                    // Person in Abteilung
                    const p = result.person;
                    const a = result.abteilung;
                    html += `
                        <div class="business-card" onclick="window.open('./gemeinde-verwaltung/abteilungen.html', '_self')" style="cursor: pointer;">
                            <div class="business-name">üë§ ${p.name}</div>
                            <div class="business-location">üèõÔ∏è ${a.name}</div>
                            ${p.funktion ? `<p style="font-size: 0.9em; color: var(--text-light); margin-top: 5px;">${p.funktion}</p>` : ''}
                            ${p.telefon ? `<p style="font-size: 0.9em; color: var(--text-light);">‚òéÔ∏è ${p.telefon}</p>` : ''}
                        </div>
                    `;
                } else if (result.type === 'gemeindebetrieb') {
                    // Gemeindebetriebe
                    const b = result.betrieb;
                    html += `
                        <div class="business-card" onclick="window.open('./gemeinde-verwaltung/gemeindebetriebe.html', '_self')" style="cursor: pointer;">
                            <div class="business-name">üèóÔ∏è ${b.name}</div>
                            <div class="business-location">üèõÔ∏è Gemeinde & Verwaltung ‚Üí Gemeindebetriebe</div>
                            ${b.url ? `<a href="${b.url}" class="business-link" target="_blank" onclick="event.stopPropagation()">‚Üí Mehr Infos</a>` : ''}
                        </div>
                    `;
                } else if (result.type === 'gemeindebetrieb-person') {
                    // Person in Gemeindebetrieb
                    const p = result.person;
                    const b = result.betrieb;
                    html += `
                        <div class="business-card" onclick="window.open('./gemeinde-verwaltung/gemeindebetriebe.html', '_self')" style="cursor: pointer;">
                            <div class="business-name">üë§ ${p.name}</div>
                            <div class="business-location">üèóÔ∏è ${b.name}</div>
                            ${p.funktion ? `<p style="font-size: 0.9em; color: var(--text-light); margin-top: 5px;">${p.funktion}</p>` : ''}
                            ${p.telefon ? `<p style="font-size: 0.9em; color: var(--text-light);">‚òéÔ∏è ${p.telefon}</p>` : ''}
                        </div>
                    `;
                }
            });

            html += '</div>';
            content.innerHTML = html;
        }

        // Enter key for search
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // Essenzielle Daten laden
                await Promise.all([
                    loadCategories(),
                    loadBusinesses(),
                    loadClubs()
                ]);

                // Optionale Daten laden (nicht blockierend f√ºr den ersten Render)
                loadGemeindeData();
                initializeRP();
                initializeStempelp√§sse();
            } catch (error) {
                console.error('Initialisierungsfehler:', error);
            }

            // Sicherstellen, dass die App gerendert wird
            init();

            // Ensure COMPANY_COORDINATES is loaded
            if (typeof COMPANY_COORDINATES === 'undefined') {
                const script = document.createElement('script');
                script.src = 'company-coordinates.js';
                script.onload = () => console.log('Coordinates loaded dynamically');
                document.head.appendChild(script);
            }

            // Scroll-Check f√ºr Floating Back Button
            window.addEventListener('scroll', function () {
                const floatBtn = document.getElementById('floatingBackButton');
                if (window.scrollY > 300) {
                    floatBtn.classList.add('visible');
                } else {
                    floatBtn.classList.remove('visible');
                }
            });

            // Browser History Handler f√ºr Android Zur√ºck-Taste
            // F√ºge initial State hinzu
            if (!window.history.state) {
                window.history.replaceState({ page: 'home' }, '', '');
            }

            // Handle Browser Back Button (Android Zur√ºck-Taste)
            window.addEventListener('popstate', function (event) {
                // Wenn wir auf der Home-Seite sind, lassen wir den Browser die Navigation durchf√ºhren
                if (currentView === 'home') {
                    // Lasse den Browser navigieren (aus der App raus)
                    return;
                }

                // Ansonsten navigieren wir intern zur√ºck
                event.preventDefault();
                goBack();

                // Stelle sicher, dass es immer einen History-Eintrag gibt
                if (currentView !== 'home') {
                    window.history.pushState({ page: currentView }, '', '');
                }
            });

            // Bei Navigation neuen History-Eintrag erstellen
            const originalNavigateToCategory = window.navigateToCategory;
            window.navigateToCategory = function (categoryId) {
                originalNavigateToCategory(categoryId);
                window.history.pushState({ page: 'category', categoryId: categoryId }, '', '');
            };

            const originalNavigateToSubcategory = window.navigateToSubcategory;
            window.navigateToSubcategory = function (categoryId, subcategoryId) {
                originalNavigateToSubcategory(categoryId, subcategoryId);
                window.history.pushState({ page: 'subcategory', categoryId: categoryId, subcategoryId: subcategoryId }, '', '');
            };


            // Display version in footer (with safety checks)
            if (document.getElementById('versionInfo'))
                document.getElementById('versionInfo').textContent = ' | Version ' + APP_VERSION;
            if (document.getElementById('flohmarktVersionInfo'))
                document.getElementById('flohmarktVersionInfo').textContent = ' | Version ' + APP_VERSION;
            if (document.getElementById('rpVersionInfo'))
                document.getElementById('rpVersionInfo').textContent = ' | Version ' + APP_VERSION;

            // Event Listeners for Regionale Produkte
            document.getElementById('rpSearchInput').addEventListener('input', filterRPProducts);
            document.getElementById('rpCategoryFilter').addEventListener('change', filterRPProducts);
            document.getElementById('rpCompanyFilter').addEventListener('change', filterRPProducts);
            document.getElementById('rpModalClose').addEventListener('click', closeRPModal);
            document.getElementById('rpPrevImage').addEventListener('click', (e) => { e.stopPropagation(); rpPrevImage(); });
            document.getElementById('rpNextImage').addEventListener('click', (e) => { e.stopPropagation(); rpNextImage(); });
            document.getElementById('rpModalOverlay').addEventListener('click', (e) => {
                // document.getElementById('mainFooter').style.display = 'none';
                if (e.target.id === 'rpModalOverlay') closeRPModal();
            });

            // Live search - triggers as you type
            document.getElementById('searchInput').addEventListener('input', function (e) {
                performSearch();
            });

            // Also support Enter key
            document.getElementById('searchInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // PWA Installation
            let deferredPrompt;
            const installButton = document.getElementById('installButton');

            // Service Worker Registration - DISABLED due to caching issues
            // if ('serviceWorker' in navigator) {
            //     navigator.serviceWorker.register('./service-worker.js')
            //         .then(registration => {
            //             console.log('‚úÖ Service Worker registered:', registration);
            //         })
            //         .catch(error => {
            //             console.log('‚ùå Service Worker registration failed:', error);
            //         });
            // }

            // Listen for beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent the mini-infobar from appearing on mobile
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                // Show install button
                installButton.classList.remove('hidden');
            });

            // Handle install button click
            installButton.addEventListener('click', async () => {
                if (!deferredPrompt) {
                    return;
                }
                // Show the install prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                // Clear the deferredPrompt
                deferredPrompt = null;
                // Hide install button
                installButton.classList.add('hidden');
            });

            // Handle app installed event
            window.addEventListener('appinstalled', () => {
                console.log('‚úÖ PWA installed successfully!');
                installButton.classList.add('hidden');
                deferredPrompt = null;
            });

            init();
        });
    </script>
    <!-- Stempelpass Cloud Sync -->
    <script src="stempelpass-sync.js"></script>

    <!-- Floating Back Button (At the very end of body to prevent layout jumps) -->
    <button id="floatingBackButton" class="floating-back-button" onclick="handleFloatingBack()" title="Nach oben">
        &uarr;
    </button>
</body>

</html>