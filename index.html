<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Koordinaten für Direktvermarkter -->
    <script src="company-coordinates.js"></script>

    <!-- QR Code Library (Scan & Generate) -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, public, proxy-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="ETag" content="">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Willkommen in Vorchdorf - Dein Neustart-Guide</title>

    <!-- PWA Meta Tags -->
    <meta name="description"
        content="Alle wichtigen Infos zu Vorchdorf: 247 Betriebe, 61 Vereine, Notfallnummern, Bildungseinrichtungen und mehr!">
    <meta name="theme-color" content="#4a90e2">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vorchdorf">

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json?v=5.7">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png?v=4.0">
    <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png?v=4.0">
    <link rel="apple-touch-icon" href="./icon-192.png?v=4.0">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        @keyframes glow-pulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(244, 185, 35, 0.3), 0 10px 30px rgba(0, 0, 0, 0.1);
            }

            50% {
                box-shadow: 0 0 40px rgba(244, 185, 35, 0.6), 0 10px 30px rgba(0, 0, 0, 0.15);
            }
        }

        @keyframes slide-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes gradient-flow {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes rotate-gradient {
            0% {
                background-position: 0deg;
            }

            360% {
                background-position: 360deg;
            }
        }

        :root {
            --primary: #1a472a;
            --primary-light: #2d7a47;
            --primary-lighter: #4a9b64;
            --secondary: #f4b923;
            --accent-secondary: #ff6b6b;
            --accent-tertiary: #4ecdc4;
            --bg: #f0f4f8;
            --card-bg: #ffffff;
            --text: #1a2332;
            --text-light: #5a6f86;
            --border: #d8e1eb;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-md: rgba(0, 0, 0, 0.12);
            --shadow-lg: rgba(0, 0, 0, 0.15);
            --accent: #e74c3c;
            --gradient-1: linear-gradient(135deg, #1a472a 0%, #2d7a47 100%);
            --gradient-2: linear-gradient(135deg, #f0f4f8 0%, #e8f0f5 100%);
            --gradient-wild: linear-gradient(-45deg, #1a472a, #f4b923, #2d7a47, #ff6b6b, #1a472a);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gradient-2);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--gradient-1);
            background-size: 200% 200%;
            animation: gradient-flow 6s ease infinite;
            color: white;
            padding: 15px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow:
                0 15px 40px var(--shadow-lg),
                0 0 1px rgba(0, 0, 0, 0.05),
                0 0 30px rgba(244, 185, 35, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: nowrap;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        header:hover {
            transform: translateY(-4px);
            box-shadow:
                0 20px 50px rgba(26, 71, 42, 0.3),
                0 0 60px rgba(244, 185, 35, 0.4);
        }

        header img {
            height: 60px;
            width: auto;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
        }

        header h1 {
            font-size: 1.8rem;
            margin: 0;
            font-weight: 700;
            white-space: nowrap;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
        }

        @media (max-width: 768px) {
            header {
                padding: 10px 15px;
            }

            header img {
                height: 40px;
            }

            header h1 {
                font-size: 1.2rem;
            }

            .rp-header {
                display: none;
            }
        }

        /* Search Bar */
        .search-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow:
                0 8px 25px var(--shadow-md),
                0 0 20px rgba(244, 185, 35, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(244, 185, 35, 0.2);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: slide-in 0.6s ease-out;
        }

        .search-container:hover {
            box-shadow:
                0 12px 35px var(--shadow-lg),
                0 0 30px rgba(244, 185, 35, 0.3);
            border-color: rgba(244, 185, 35, 0.4);
        }

        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 95, 45, 0.1);
        }

        .search-box button {
            padding: 15px 30px;
            background: var(--gradient-1);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(26, 71, 42, 0.2);
            position: relative;
            overflow: hidden;
        }

        .search-box button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .search-box button:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(26, 71, 42, 0.35), 0 0 30px rgba(244, 185, 35, 0.2);
        }

        .search-box button:hover::before {
            width: 300px;
            height: 300px;
        }

        .search-box button:active {
            transform: translateY(-1px);
        }

        .search-box button:active {
            transform: translateY(-1px);
        }

        /* Navigation Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .breadcrumb-item:hover {
            color: var(--primary);
        }

        .breadcrumb-separator {
            color: var(--text-light);
        }

        /* Back Button Container */
        .navigation-container {
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
        }

        .back-button {
            flex: 1;
            background: white;
            border: 3px solid var(--primary);
            color: var(--primary);
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 24px var(--shadow-lg), 0 0 20px rgba(244, 185, 35, 0.2);
            overflow: hidden;
            position: relative;
        }

        .back-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .back-button:hover {
            background: var(--gradient-1);
            color: white;
            transform: scale(1.12) translateY(-3px);
            box-shadow: 0 15px 40px rgba(26, 71, 42, 0.3), 0 0 40px rgba(244, 185, 35, 0.3);
            border-color: transparent;
        }

        .back-button:hover::before {
            left: 100%;
        }

        .back-button:active {
            transform: scale(1.06) translateY(0px);
        }

        /* Floating Back Button */
        .floating-back-button {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #2d5016;
            /* Dunkelgrün wie gewünscht */
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            border: 3px solid white;
            font-size: 2rem;
            line-height: normal;
        }

        .floating-back-button.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .floating-back-button:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 8px 25px rgba(26, 71, 42, 0.4);
        }

        /* Cards Grid for Main Categories */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 24px var(--shadow-md), 0 1px 3px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid transparent;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: slide-in 0.6s ease-out backwards;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(circle, rgba(244, 185, 35, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
            pointer-events: none;
            transform: scale(0.8);
        }

        .card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(-45deg,
                    rgba(26, 71, 42, 0) 0%,
                    rgba(244, 185, 35, 0.1) 50%,
                    rgba(26, 71, 42, 0) 100%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .card:hover {
            transform: translateY(-12px) scale(1.04) rotateX(8deg);
            box-shadow:
                0 25px 50px rgba(26, 71, 42, 0.25),
                0 0 30px rgba(244, 185, 35, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            border-color: var(--secondary);
        }

        .card:hover::before {
            opacity: 1;
            transform: scale(1.2);
        }

        .card:hover::after {
            opacity: 1;
        }

        .card-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
            display: block;
            animation: float 4s ease-in-out infinite;
            filter: drop-shadow(0 0 5px rgba(244, 185, 35, 0.3));
        }

        .card:hover .card-icon {
            animation: none;
            transform: scale(1.3) rotate(-5deg);
            filter: drop-shadow(0 0 15px rgba(244, 185, 35, 0.6));
        }

        .card h3 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 0.95rem;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            transition: color 0.3s;
            font-weight: 700;
            letter-spacing: 0.5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-count {
            display: inline-block;
            background: rgba(244, 185, 35, 0.1);
            color: var(--secondary);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(244, 185, 35, 0.2);
        }

        .card:hover h3 {
            color: var(--secondary);
            text-shadow: 0 0 10px rgba(244, 185, 35, 0.3);
        }

        .card p {
            color: var(--text-light);
            font-size: 1rem;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }

            .card {
                padding: 12px;
                min-height: 140px;
            }

            .card-icon {
                font-size: 2rem;
                margin-bottom: 6px;
            }

            .card h3 {
                font-size: 0.9rem;
            }

            .card p {
                font-size: 0.8rem;
                line-height: 1.3;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
        }

        @media (orientation: landscape) and (max-width: 1024px) {
            .cards-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }
        }

        /* Detail View */
        .detail-view {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px var(--shadow-md);
            backdrop-filter: blur(10px);
        }

        .detail-view h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .detail-view h3 {
            color: var(--primary);
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5rem;
            border-left: 5px solid var(--secondary);
            padding-left: 15px;
            transition: all 0.3s;
            position: relative;
        }

        .detail-view h3::before {
            content: '';
            position: absolute;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(180deg, var(--secondary), var(--primary-light));
            border-radius: 3px;
        }

        /* Platzoptimierung: Verstecke große Header-Boxen auf Handy/Tablet */
        @media (max-width: 1024px) {

            .detail-view h2,
            .rp-header h2,
            .rp-header p,
            .flohmarkt-header h2,
            .flohmarkt-header p,
            #rpCategoriesView .rp-section-title,
            #rpProductsSection .rp-section-title,
            #rpDirectMarketersSection .rp-section-title,
            .rp-container>.rp-section-title {
                display: none !important;
            }

            .rp-header,
            .flohmarkt-header {
                background: none !important;
                padding: 0 !important;
                box-shadow: none !important;
                margin-bottom: 20px !important;
                min-height: auto !important;
            }

            .flohmarkt-info-btn,
            .rp-info-btn {
                background: var(--primary) !important;
                color: white !important;
                border: 2px solid var(--primary) !important;
                margin: 0 auto !important;
                display: block !important;
                width: fit-content !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
            }

            .detail-view,
            .rp-container,
            .flohmarkt-container {
                padding-top: 5px !important;
            }

            .rp-section-divider {
                margin: 15px 0 !important;
            }

            /* Verstecke redundanten RP-Button wenn globaler Button da ist */
            .rp-container #rpBackBtn {
                display: none !important;
            }

            #rpCompaniesView~#rpBackBtn,
            #rpDirectMarketersSection~#rpBackBtn {
                display: block !important;
            }

            .mobile-hide-header {
                display: none !important;
            }
        }

        /* Business Cards Grid - NEW LAYOUT */
        .business-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .business-card {
            background: var(--bg);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid rgba(244, 185, 35, 0.3);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 4px 12px var(--shadow-md);
            position: relative;
            overflow: visible;
            animation: slide-in 0.6s ease-out backwards;
            min-height: 140px;
        }

        .business-card:hover {
            border-color: var(--secondary);
            background: white;
            box-shadow: 0 8px 20px rgba(26, 71, 42, 0.15);
        }

        .business-card-icon {
            display: none;
        }

        .business-name {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.05rem;
            line-height: 1.4;
            word-break: break-word;
            overflow-wrap: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .business-location {
            color: var(--text-light);
            font-size: 0.9rem;
            display: flex;
            align-items: flex-start;
            gap: 5px;
            flex-wrap: wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .business-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            transition: all 0.3s;
            position: relative;
        }

        .business-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .business-link:hover {
            color: var(--secondary);
        }

        .business-link:hover::after {
            width: 100%;
        }

        /* Item Cards Grid - for clubs, education, etc. */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 18px;
            margin-top: 20px;
        }

        .item-card {
            background: var(--card-bg);
            padding: 18px;
            border-radius: 12px;
            border: 2px solid rgba(244, 185, 35, 0.2);
            transition: all 0.45s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 6px 20px var(--shadow-md);
            position: relative;
            overflow: hidden;
            animation: slide-in 0.6s ease-out backwards;
        }

        .item-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background:
                conic-gradient(from 0deg, rgba(244, 185, 35, 0.2), transparent 25%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .item-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(26, 71, 42, 0.03) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .item-card-link {
            text-decoration: none;
            color: inherit;
            cursor: pointer;
        }

        .item-card-link:hover {
            transform: scale(1.02);
        }

        .item-card:hover {
            border-color: var(--secondary);
            transform: translateY(-10px) scale(1.03);
            box-shadow:
                0 18px 40px rgba(26, 71, 42, 0.2),
                0 0 30px rgba(244, 185, 35, 0.25);
        }

        .item-card:hover::before {
            opacity: 1;
        }

        .item-card:hover::after {
            opacity: 1;
        }

        .item-card-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.05rem;
            line-height: 1.3;
            transition: all 0.3s;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0);
        }

        .item-card:hover .item-card-title {
            color: var(--secondary);
            text-shadow: 0 0 10px rgba(244, 185, 35, 0.3);
        }

        .item-card-info {
            color: var(--text);
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .item-card-info p {
            margin: 0;
            line-height: 1.3;
        }

        /* Taxi Quick Call Grid */
        .taxi-quick-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .taxi-quick-box {
            background: var(--card-bg);
            border: 3px solid var(--primary);
            border-radius: 15px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 6px 20px var(--shadow-md);
            position: relative;
            overflow: hidden;
            animation: slide-in 0.6s ease-out backwards;
        }

        .taxi-quick-box::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--gradient-1);
            opacity: 0;
            transition: opacity 0.45s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: -1;
        }

        .taxi-quick-box::after {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(244, 185, 35, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 107, 107, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 0;
            pointer-events: none;
        }

        .taxi-quick-box:hover {
            background: white;
            color: white;
            transform: translateY(-12px) scale(1.05) rotateY(-8deg);
            box-shadow: 0 25px 50px rgba(26, 71, 42, 0.3), 0 0 40px rgba(244, 185, 35, 0.25);
            border-color: transparent;
        }

        .taxi-quick-box:hover::before {
            opacity: 1;
        }

        .taxi-quick-box:hover::after {
            opacity: 1;
        }

        .taxi-quick-icon {
            font-size: 3rem;
            display: block;
            animation: float 3s ease-in-out infinite;
            transition: all 0.3s;
            filter: drop-shadow(0 0 5px rgba(244, 185, 35, 0.2));
        }

        .taxi-quick-box:hover .taxi-quick-icon {
            animation: none;
            transform: scale(1.4) rotate(10deg) translateX(15px);
            filter: drop-shadow(0 0 20px rgba(244, 185, 35, 0.6));
        }

        .taxi-quick-text {
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .taxi-quick-text strong {
            display: block;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 5px;
            transition: all 0.3s;
            letter-spacing: 0.5px;
        }

        .taxi-quick-text p {
            font-size: 0.9rem;
            opacity: 0.8;
            margin: 0;
            transition: all 0.3s;
        }

        .taxi-quick-box:hover .taxi-quick-text strong {
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .taxi-quick-box:hover .taxi-quick-text p {
            opacity: 1;
            color: rgba(255, 255, 255, 0.95);
        }

        .info-item {
            background: var(--bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 4px 12px var(--shadow-md);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
            animation: slide-in 0.6s ease-out backwards;
        }

        .info-item::before {
            content: '';
            position: absolute;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(180deg, var(--secondary), var(--primary-light));
            border-radius: 3px;
        }

        .info-item::after {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(244, 185, 35, 0.1) 0%, transparent 70%);
            transition: all 0.5s;
            pointer-events: none;
        }

        .info-item:hover {
            transform: translateX(8px) translateY(-2px);
            box-shadow:
                0 12px 28px rgba(26, 71, 42, 0.15),
                0 0 25px rgba(244, 185, 35, 0.2);
        }

        .info-item:hover::after {
            top: 0;
            left: 0;
        }

        .info-item h4 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.2rem;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .info-item:hover h4 {
            color: var(--secondary);
            text-shadow: 0 0 8px rgba(244, 185, 35, 0.3);
        }

        .info-item p {
            margin: 5px 0;
            color: var(--text);
        }

        .info-item a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .info-item a::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .info-item a:hover {
            color: var(--secondary);
        }

        .info-item a:hover::after {
            width: 100%;
        }

        /* Weather Widget */
        .weather-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .weather-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .weather-day {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .weather-day h4 {
            margin: 0 0 10px 0;
            font-size: 0.95rem;
            opacity: 0.95;
        }

        .weather-icon {
            font-size: 2.5rem;
            margin: 10px 0;
        }

        .weather-temp {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .weather-description {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* Search Results */
        .search-results {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px var(--shadow);
        }

        .search-results h2 {
            color: var(--primary);
            margin-bottom: 20px;
        }

        .search-result-item {
            background: var(--bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-result-item:hover {
            background: #e8f5e9;
            transform: translateX(5px);
        }

        .search-result-path {
            color: var(--text-light);
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .search-result-title {
            color: var(--primary);
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* PWA Install Button */
        .install-container {
            margin-bottom: 20px;
        }

        .install-button {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
            max-width: 300px;
        }

        .install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
        }

        .install-button:active {
            transform: translateY(0);
        }

        .install-button.hidden {
            display: none;
        }

        /* Emergency Banner */
        .emergency-banner {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 5px 20px rgba(192, 57, 43, 0.3);
        }

        .emergency-banner .icon {
            font-size: 2.5rem;
        }

        .emergency-banner h3 {
            margin-bottom: 5px;
        }

        .emergency-numbers {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .emergency-number {
            background: rgba(255, 255, 255, 0.2);
            padding: 16px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            text-decoration: none;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            min-height: 80px;
            font-size: 1rem;
        }

        .emergency-number:hover {
            background: rgba(255, 255, 255, 0.35);
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .emergency-number:active {
            transform: scale(0.98);
        }

        /* Subcategories specific styling - Grid Layout */
        .subcategory-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .subcategory-item {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 5px 20px var(--shadow);
            text-align: center;
            align-items: center;
        }

        .subcategory-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }

        .subcategory-icon {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 5px;
        }

        .subcategory-item h4 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.15rem;
            font-weight: 600;
            line-height: 1.3;
        }

        .subcategory-item p {
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.4;
        }

        .sub-count {
            display: inline-block;
            background: rgba(244, 185, 35, 0.1);
            color: var(--secondary);
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: auto;
            border: 1px solid rgba(244, 185, 35, 0.2);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            color: var(--text-light);
            font-size: 0.9rem;
            border-top: 1px solid var(--border);
        }

        footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            header p {
                font-size: 1rem;
            }

            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .card {
                padding: 15px;
            }

            .card-icon {
                font-size: 2rem;
            }

            .card h3 {
                font-size: 0.95rem;
            }

            .card p {
                font-size: 0.75rem;
            }

            .business-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 15px;
            }

            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 12px;
            }

            .subcategory-list {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            }

            .search-box {
                flex-direction: column;
            }

            .search-box button {
                width: 100%;
            }

            .emergency-numbers {
                grid-template-columns: repeat(2, 1fr);
            }

            .emergency-number {
                min-height: 70px;
                padding: 12px;
                font-size: 0.9rem;
            }

            .back-button {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }

        /* Landscape orientation - wider layouts */
        @media (orientation: landscape) and (max-width: 1024px) {
            .cards-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }

            .business-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }

            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }

            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .subcategory-list {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            header h1 {
                font-size: 1.5rem;
            }

            header p {
                font-size: 0.9rem;
            }

            .emergency-banner {
                padding: 15px;
                gap: 12px;
            }

            .emergency-banner .icon {
                font-size: 2rem;
            }

            .emergency-banner h3 {
                font-size: 1rem;
            }

            .emergency-numbers {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .emergency-number {
                min-height: 50px;
                padding: 8px;
                font-size: 0.8rem;
            }
        }

        /* Hide class */
        .hidden {
            display: none !important;
        }

        /* Loading animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .business-card:nth-child(odd) {
            background: #fffef0;
            /* Light yellow */
        }

        .business-card:nth-child(even) {
            background: #f0f8ff;
            /* Light blue */
        }

        /* Flohmarkt Styles */
        .flohmarkt-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .flohmarkt-container.active {
            display: block;
        }

        .flohmarkt-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }

        .flohmarkt-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .flohmarkt-header p {
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .flohmarkt-info-btn,
        .rp-info-btn {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }

        .flohmarkt-info-btn:hover,
        .rp-info-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .flohmarkt-action-bar {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn-flohmarkt {
            background: var(--secondary);
            color: var(--text);
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(244, 185, 35, 0.3);
        }

        .btn-flohmarkt:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 185, 35, 0.4);
        }

        .flohmarkt-filter {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .flohmarkt-search {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 50px;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .flohmarkt-search:focus {
            outline: none;
            border-color: var(--primary);
        }

        .flohmarkt-filter-select {
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 50px;
            font-family: inherit;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .flohmarkt-filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .flohmarkt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .flohmarkt-product-card {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            cursor: pointer;
        }

        .flohmarkt-product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .flohmarkt-product-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: linear-gradient(135deg, #e8e8e8 0%, #f5f5f5 100%);
        }

        .flohmarkt-product-placeholder {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            opacity: 0.8;
        }

        .flohmarkt-product-info {
            padding: 15px;
        }

        .flohmarkt-product-category {
            display: inline-block;
            background: rgba(26, 71, 42, 0.1);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .flohmarkt-product-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: #333;
            line-height: 1.3;
        }

        .flohmarkt-product-price {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .flohmarkt-product-seller {
            font-size: 0.9rem;
            color: #666;
        }

        .flohmarkt-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .flohmarkt-empty-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Flohmarkt Modal */
        .flohmarkt-modal-overlay {
            display: none !important;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 1);
            z-index: 999999;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .flohmarkt-modal-overlay.active {
            display: flex !important;
        }

        .flohmarkt-modal {
            background: white;
            border-radius: 16px;
            max-width: 700px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
            box-shadow: 0 25px 100px rgba(0, 0, 0, 0.8);
            z-index: 1000000;
            padding: 0;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .flohmarkt-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .flohmarkt-modal-close:hover {
            background: white;
        }

        .flohmarkt-modal-images {
            position: relative;
            width: 100%;
            height: 350px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flohmarkt-modal-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .flohmarkt-modal-image-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .flohmarkt-modal-image-nav:hover {
            background: white;
        }

        .flohmarkt-modal-image-nav.prev {
            left: 15px;
        }

        .flohmarkt-modal-image-nav.next {
            right: 15px;
        }

        .flohmarkt-modal-image-dots {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }

        .flohmarkt-modal-image-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            border: none;
            cursor: pointer;
        }

        .flohmarkt-modal-image-dot.active {
            background: white;
        }

        .flohmarkt-modal-content {
            padding: 20px;
        }

        .flohmarkt-modal-category {
            display: inline-block;
            background: rgba(26, 71, 42, 0.15);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .flohmarkt-modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #000;
            line-height: 1.3;
        }

        .flohmarkt-modal-price {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .flohmarkt-modal-description {
            color: #333;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .flohmarkt-modal-seller {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .flohmarkt-modal-seller-avatar {
            width: 45px;
            height: 45px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .flohmarkt-modal-seller-info h4 {
            font-weight: 700;
            color: #333;
            margin-bottom: 2px;
        }

        .flohmarkt-modal-seller-info small {
            color: #666;
            font-size: 0.85rem;
        }

        .flohmarkt-modal-contact-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000001;
            position: relative;
            gap: 8px;
            font-size: 1rem;
            transition: background 0.3s;
        }

        .flohmarkt-modal-contact-btn:hover {
            background: var(--primary-light);
        }

        .flohmarkt-stats {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 15px;
            font-weight: 500;
        }

        /* Flohmarkt Mobile Styles */
        @media (max-width: 768px) {

            .flohmarkt-header h2,
            .flohmarkt-header p {
                display: none;
            }

            .flohmarkt-header {
                padding: 10px;
                text-align: right;
            }

            .flohmarkt-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .flohmarkt-filter {
                flex-direction: column;
            }

            .flohmarkt-search,
            .flohmarkt-filter-select {
                width: 100%;
            }

            .flohmarkt-modal-images {
                height: 250px;
            }

            .flohmarkt-product-image,
            .flohmarkt-product-placeholder {
                height: 150px;
            }
        }

        /* Extra Mobile Optimizations for Flohmarkt Modal */
        @media (max-width: 480px) {
            .flohmarkt-modal {
                width: 98%;
                max-height: 85vh;
                border-radius: 12px;
            }

            .flohmarkt-modal-images {
                height: 220px;
            }

            .flohmarkt-modal-content {
                padding: 14px;
                max-height: calc(85vh - 220px - 40px);
                overflow-y: auto;
            }

            .flohmarkt-modal-title {
                font-size: 1.1rem;
                margin-bottom: 8px;
            }

            .flohmarkt-modal-price {
                font-size: 1.4rem;
                margin-bottom: 12px;
            }

            .flohmarkt-modal-category {
                padding: 4px 10px;
                font-size: 0.75rem;
                margin-bottom: 10px;
            }

            .flohmarkt-modal-description {
                font-size: 0.9rem;
                line-height: 1.5;
                margin-bottom: 12px;
                padding-bottom: 12px;
            }

            .flohmarkt-modal-seller {
                margin-bottom: 12px;
                gap: 10px;
            }

            .flohmarkt-modal-seller-avatar {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .flohmarkt-modal-seller-info h4 {
                font-size: 0.95rem;
            }

            .flohmarkt-modal-seller-info small {
                font-size: 0.8rem;
            }

            .flohmarkt-modal-contact-btn {
                padding: 12px;
                font-size: 0.95rem;
            }
        }

        /* ============================================ */
        /* REGIONALE PRODUKTE STYLES */
        /* ============================================ */
        /* Info Tiles */
        .rp-info-tiles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .rp-info-tile {
            background: white;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid var(--border);
            box-shadow: 0 4px 12px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .rp-info-tile:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow-md);
            border-color: var(--primary);
        }

        .rp-info-tile:hover .rp-info-tile-arrow {
            transform: translateX(5px);
        }

        .rp-info-tile-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .rp-info-tile-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .rp-info-tile-text {
            color: var(--text-light);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .rp-info-tile-arrow {
            font-size: 1.5rem;
            color: var(--primary);
            position: absolute;
            bottom: 20px;
            right: 25px;
            transition: transform 0.3s;
        }

        /* Section Divider */
        .rp-section-divider {
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            margin: 40px 0;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .rp-info-tiles {
                grid-template-columns: 1fr;
            }
        }

        /* Container */
        .rp-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .rp-container.active {
            display: block;
        }

        /* Header */
        .rp-header {
            background: linear-gradient(135deg, #1a472a 0%, #2d7a47 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .rp-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .rp-header p {
            opacity: 0.9;
        }

        /* Back Button */
        .rp-back-btn {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .rp-back-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Section Title */
        .rp-section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--primary);
        }

        /* ============================================ */
        /* KATEGORIE GRID */
        /* ============================================ */
        .rp-category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .rp-category-card {
            background: white;
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid var(--border);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .rp-category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px var(--shadow-md);
            border-color: var(--primary);
        }

        .rp-category-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
        }

        .rp-category-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 5px;
        }

        .rp-category-count {
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .rp-category-count.zero {
            color: #ccc;
        }

        /* ============================================ */
        /* FIRMEN KACHELN */
        /* ============================================ */
        .rp-companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .rp-company-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid var(--border);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .rp-company-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow-md);
            border-color: var(--primary);
        }

        .rp-company-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rp-company-info-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text);
        }

        .rp-company-info-icon {
            font-size: 1rem;
            min-width: 20px;
        }

        .rp-company-info-text {
            flex: 1;
            line-height: 1.4;
        }

        .rp-company-website {
            display: inline-block;
            margin-top: 12px;
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .rp-company-website:hover {
            background: var(--primary-light);
        }

        /* ============================================ */
        /* FILTER & PRODUKTE */
        /* ============================================ */
        .rp-products-section {
            margin-top: 40px;
        }

        /* Direktvermarkter Sektion */
        .rp-direct-marketers-section {
            margin-top: 60px;
            padding-top: 40px;
            border-top: 2px solid var(--border);
        }

        .rp-direct-marketers-grid {
            display: grid;
            gap: 30px;
        }

        .rp-dm-location-group {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .rp-dm-location-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rp-dm-company-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .rp-dm-company-item {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            background: #f1f3f5;
            border-radius: 50px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            color: var(--text);
            font-size: 0.88rem;
            border: 1px solid #dee2e6;
            cursor: pointer;
            font-weight: 500;
        }

        .rp-dm-company-item:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .rp-dm-company-item:hover .rp-dm-company-number {
            background: white;
            color: var(--primary);
        }

        .rp-dm-company-number {
            background: var(--primary);
            color: white;
            font-weight: 700;
            font-size: 0.8rem;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            border: 1px solid white;
        }

        /* ============================================ */
        /* STEMPELPASS STYLES */
        /* ============================================ */
        .stempel-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeIn 0.5s ease-out;
        }

        .stempel-container.active {
            display: block;
        }

        .stempel-header {
            background: linear-gradient(135deg, #FF9800 0%, #F44336 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        @media (max-width: 768px) {
            .stempel-header {
                display: none;
            }
        }

        .stempel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .stempel-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px var(--shadow);
            border-top: 5px solid #FF9800;
            transition: transform 0.3s;
        }

        .stempel-card:hover {
            transform: translateY(-5px);
        }

        /* BACKUP SYSTEM STYLES */
        .stempel-backup-box {
            background: #fff8e1;
            border: 2px dashed #ffb300;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .stempel-backup-content h4 {
            margin: 0 0 5px 0;
            color: #f57c00;
        }

        .stempel-backup-content p {
            margin: 0;
            font-size: 0.9rem;
            color: #5d4037;
        }

        .stempel-backup-btn {
            background: #ffb300;
            color: #4e342e;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .backup-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .backup-modal-overlay.active {
            display: flex;
        }

        .backup-modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .backup-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        #backupQrCanvas {
            margin: 20px auto;
            padding: 15px;
            background: white;
            border: 1px solid #eee;
            display: inline-block;
        }

        .backup-user-id {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-weight: 700;
            margin: 15px 0;
            color: var(--primary);
            border: 1px solid #ddd;
        }

        .stempel-card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stempel-progress-container {
            margin: 20px 0;
            background: #f0f0f0;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .stempel-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #FF9800, #F44336);
            width: 0%;
            transition: width 0.5s ease-in-out;
        }

        .stempel-dots {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .stempel-dot {
            aspect-ratio: 1;
            background: #eee;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #ccc;
            border: 2px dashed #ddd;
        }

        .stempel-dot.active {
            background: #FFF3E0;
            color: #FF9800;
            border: 2px solid #FF9800;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .stempel-scan-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .stempel-scan-btn:hover {
            background: var(--primary-light);
            transform: scale(1.02);
        }

        .scanner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10002;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .scanner-overlay.active {
            display: flex;
        }

        #qr-reader {
            width: 100%;
            max-width: 500px;
            border-radius: 10px;
            overflow: hidden;
        }

        .scanner-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
        }

        @keyframes popIn {
            0% {
                transform: scale(0);
            }

            100% {
                transform: scale(1);
            }
        }


        .rp-dm-company-name {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .rp-dm-company-arrow {
            font-size: 1.2rem;
            opacity: 0.5;
            margin-left: auto;
        }

        .rp-dm-company-item:hover .rp-dm-company-arrow {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .rp-direct-marketers-section {
                margin-top: 40px;
                padding-top: 30px;
            }

            .rp-dm-location-group {
                padding: 20px;
            }

            .rp-dm-location-title {
                font-size: 1.2rem;
            }
        }

        .rp-filters {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px var(--shadow);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .rp-search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            border: 2px solid var(--border);
            border-radius: 50px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .rp-search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .rp-filter-select {
            padding: 12px 20px;
            border: 2px solid var(--border);
            border-radius: 50px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .rp-filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .rp-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .rp-product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .rp-product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow-md);
        }

        .rp-product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f5f5f5;
        }

        .rp-product-placeholder {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
        }

        .rp-product-info {
            padding: 15px;
        }

        .rp-product-category-tag {
            display: inline-block;
            background: rgba(26, 71, 42, 0.1);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .rp-product-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--text);
        }

        .rp-product-price {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .rp-product-company-name {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        /* ============================================ */
        /* RESPONSIVE */
        /* ============================================ */
        @media (max-width: 768px) {
            .rp-category-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .rp-companies-grid {
                grid-template-columns: 1fr;
            }

            .rp-products-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .rp-filters {
                flex-direction: column;
            }

            .rp-search-input,
            .rp-filter-select {
                width: 100%;
            }
        }

        /* Modal Styles for Regionale Produkte */
        .rp-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .rp-modal-overlay.active {
            display: flex;
        }

        .rp-modal {
            background: white;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 20px;
            overflow-y: auto;
            position: relative;
            animation: slide-in 0.3s ease-out;
        }

        .rp-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rp-modal-images {
            position: relative;
            height: 400px;
            background: #f5f5f5;
        }

        .rp-modal-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .rp-modal-image-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rp-modal-image-nav:hover {
            background: white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        .rp-modal-image-nav.prev {
            left: 15px;
        }

        .rp-modal-image-nav.next {
            right: 15px;
        }

        .rp-modal-image-dots {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }

        .rp-modal-image-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            cursor: pointer;
        }

        .rp-modal-image-dot.active {
            background: var(--primary);
            transform: scale(1.2);
        }

        .rp-modal-content {
            padding: 30px;
        }

        .rp-modal-category {
            display: inline-block;
            background: rgba(26, 71, 42, 0.1);
            color: var(--primary);
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .rp-modal-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #333;
        }

        .rp-modal-price {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .rp-modal-description {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #555;
            margin-bottom: 30px;
            white-space: pre-line;
        }

        .rp-modal-contact-btn {
            display: inline-block;
            margin-top: 15px;
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            text-align: center;
            transition: background 0.3s;
            width: 100%;
        }

        .rp-modal-contact-btn:hover {
            background: var(--primary-light);
        }

        .rp-modal-company-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .rp-modal-company-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: #333;
        }

        .rp-modal-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .rp-btn-primary {
            flex: 1;
            min-width: 200px;
            background: var(--primary);
            color: white;
            text-decoration: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 700;
            text-align: center;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .rp-btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 71, 42, 0.3);
        }

        .rp-btn-secondary {
            flex: 1;
            min-width: 200px;
            background: white;
            color: var(--primary);
            text-decoration: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 700;
            text-align: center;
            border: 2px solid var(--primary);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .rp-btn-secondary:hover {
            background: rgba(26, 71, 42, 0.05);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .rp-modal-images {
                height: 250px;
            }

            .rp-modal-title {
                font-size: 1.5rem;
            }

            .rp-modal-content {
                padding: 20px;
            }

            .rp-modal-actions {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header onclick="goHome()" style="cursor: pointer;">
            <img src="AUT_Vorchdorf_COA.svg.png" alt="Wappen Vorchdorf">
            <h1>Vorchdorf-APP</h1>
            <img src="AUT_Vorchdorf_COA.svg.png" alt="Wappen Vorchdorf">
        </header>

        <!-- PWA Install Button -->
        <div class="install-container">
            <button id="installButton" class="install-button hidden">
                📱 Als App installieren
            </button>
        </div>

        <!-- Search -->
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Suche nach Informationen, Vereinen, Betrieben...">
                <button onclick="performSearch()" class="search-button">🔍 Suchen</button>
            </div>
        </div>

        <!-- Back Button - Below Search -->
        <div class="navigation-container">
            <button id="backButton" class="back-button hidden" onclick="goBack()">
                ← Zurück
            </button>
        </div>



        <!-- Breadcrumb Navigation -->
        <div id="breadcrumb" class="breadcrumb hidden"></div>

        <!-- Main Content (Categories rendered here) -->
        <div id="mainContent"></div>

        <!-- Emergency Banner (always visible on home) -->
        <div id="emergencyBanner" class="emergency-banner hidden">
            <div class="icon">🚨</div>
            <div>
                <h3>Notrufnummern - Immer für dich da!</h3>
                <div class="emergency-numbers">
                    <a href="tel:141" class="emergency-number">🏥<br>Ärztefunkdienst<br>141</a>
                    <a href="tel:122" class="emergency-number">🚒<br>Feuerwehr<br>122</a>
                    <a href="tel:133" class="emergency-number">👮<br>Polizei<br>133</a>
                    <a href="tel:144" class="emergency-number">🚑<br>Rettung<br>144</a>
                </div>
            </div>
        </div>

        <!-- Weather Widget (shown on home below emergency) -->
        <div id="weatherWidget" class="weather-widget hidden"></div>



        <!-- Flohmarkt Container -->
        <div id="flohmarktContainer" class="flohmarkt-container">
            <div class="flohmarkt-header">
                <h2>🛒 Flohmarkt der Werberingmitglieder</h2>
                <p>Kaufen & Verkaufen in der Region</p>
                <button class="flohmarkt-info-btn" onclick="openFlohmarktInfo()">ℹ️ Info</button>
            </div>

            <section class="flohmarkt-filter">
                <input type="text" id="flohmarktSearch" class="flohmarkt-search" placeholder="Produkt suchen...">
                <select id="flohmarktCategory" class="flohmarkt-filter-select">
                    <option value="">Alle Kategorien</option>
                    <option value="Schulsachen">📚 Schulsachen</option>
                    <option value="Büromaterial">✏️ Büromaterial</option>
                    <option value="Spiele">🎮 Spiele</option>
                    <option value="Bücher">📖 Bücher</option>
                    <option value="Handarbeit">🧶 Handarbeit</option>
                    <option value="Deko">🏠 Deko</option>
                    <option value="Elektro">⚡ Elektro</option>
                    <option value="Kinderartikel">🧸 Kinderartikel</option>
                    <option value="Möbel">🪑 Möbel</option>
                    <option value="Kleidung">👕 Kleidung</option>
                    <option value="Lederwaren">👜 Lederwaren</option>
                    <option value="Rauchzubehör">🚬 Rauchzubehör</option>
                    <option value="Sonstiges">📦 Sonstiges</option>
                </select>
                <select id="flohmarktVerkaeifer" class="flohmarkt-filter-select">
                    <option value="">Alle Verkäufer</option>
                    <option value="Trafik Fischer">👤 Trafik Fischer</option>
                </select>
            </section>

            <div class="flohmarkt-stats" id="flohmarktStats"></div>

            <div class="flohmarkt-grid" id="flohmarktGrid"></div>

            <div class="flohmarkt-empty" id="flohmarktEmpty" style="display: none;">
                <div class="flohmarkt-empty-icon">🔍</div>
                <h3>Keine Produkte gefunden</h3>
                <p>Versuche eine andere Suche oder Kategorie</p>
            </div>

            <!-- Footer im Flohmarkt unten -->
            <footer style="margin-top: 40px;">
                Powered by <a href="https://fischervorchdorf.at" target="_blank">fischervorchdorf.at</a>
                <span id="flohmarktVersionInfo"></span>
            </footer>
        </div>

        <!-- Flohmarkt Modal -->
        <div class="flohmarkt-modal-overlay" id="flohmarktModalOverlay">
            <div class="flohmarkt-modal" id="flohmarktModal">
                <button class="flohmarkt-modal-close" id="flohmarktModalClose">✕</button>
                <div class="flohmarkt-modal-images" id="flohmarktModalImages">
                    <img src="" alt="" class="flohmarkt-modal-image" id="flohmarktModalImage">
                    <button class="flohmarkt-modal-image-nav prev" id="flohmarktPrevImage">‹</button>
                    <button class="flohmarkt-modal-image-nav next" id="flohmarktNextImage">›</button>
                    <div class="flohmarkt-modal-image-dots" id="flohmarktModalDots"></div>
                </div>
                <div class="flohmarkt-modal-content">
                    <span class="flohmarkt-modal-category" id="flohmarktModalCategory"></span>
                    <h2 class="flohmarkt-modal-title" id="flohmarktModalTitle"></h2>
                    <div class="flohmarkt-modal-price" id="flohmarktModalPrice"></div>
                    <p class="flohmarkt-modal-description" id="flohmarktModalDescription"></p>
                    <div class="flohmarkt-modal-seller">
                        <div class="flohmarkt-modal-seller-avatar" id="flohmarktModalAvatar"></div>
                        <div class="flohmarkt-modal-seller-info">
                            <h4 id="flohmarktModalSellerName"></h4>
                            <small>Verkäufer/in</small>
                        </div>
                    </div>
                    <a href="" class="flohmarkt-modal-contact-btn" id="flohmarktModalContactBtn">
                        ✉️ Verkäufer kontaktieren
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Regionale Produkte Container -->
    <div id="rpContainer" class="rp-container">
        <!-- Header -->
        <div class="rp-header">
            <h2>🍎 Regionale Produkte aus der Region Vorchdorf</h2>
            <button class="rp-info-btn" onclick="openRPInfo()">ℹ️ Info</button>
        </div>

        <!-- Back Button -->
        <button id="rpBackBtn" class="rp-back-btn hidden" onclick="rpGoBack()">← Zurück</button>

        <!-- MAIN VIEW: Categories -->
        <div id="rpCategoriesView">
            <!-- Info Box (Immer sichtbar in der Hauptansicht) -->
            <div id="rpMainInfoBox" class="info-item" style="margin-bottom: 20px;">
                <h4>🍎 Qualität aus unserer Region</h4>
                <p>In Vorchdorf produzieren viele engagierte Betriebe hochwertige Lebensmittel. Hier finden Sie eine
                    Übersicht aller Anbieter und Produkte direkt vom Erzeuger.</p>
            </div>
            <h3 class="rp-section-title">Kategorien</h3>
            <div id="rpCategoryGrid" class="rp-category-grid"></div>

            <!-- Trennlinie -->
            <div class="rp-section-divider"></div>

            <!-- Überschrift -->
            <h3 class="rp-section-title" style="margin-bottom: 25px;">🏡 Unsere Direktvermarkter</h3>

            <!-- Bauernmärkte & Direktvermarkter Kacheln -->
            <div class="rp-info-tiles">
                <div class="rp-info-tile" onclick="window.open('bauernmaerkte.html', '_self')">
                    <div class="rp-info-tile-icon">🥕</div>
                    <h3 class="rp-info-tile-title">Bauernmärkte</h3>
                    <p class="rp-info-tile-text">11 Märkte in der Region - jeden Tag frische Produkte!</p>
                    <div class="rp-info-tile-arrow">→</div>
                </div>

                <div class="rp-info-tile" onclick="rpShowDirectMarketersAZ()">
                    <div class="rp-info-tile-icon">📋</div>
                    <h3 class="rp-info-tile-title">Direktvermarkter A-Z</h3>
                    <p class="rp-info-tile-text">Alle regionalen Anbieter alphabetisch nach Orten sortiert</p>
                    <div class="rp-info-tile-arrow">→</div>
                </div>
            </div>
            <!-- COMPANIES VIEW (hidden by default) -->
            <div id="rpCompaniesView" class="hidden">
                <h3 id="rpCompaniesTitle" class="rp-section-title"></h3>
                <div id="rpCompaniesGrid" class="rp-companies-grid"></div>
            </div>

            <!-- PRODUCTS SECTION (ganz am Ende) -->
            <div id="rpProductsSection" class="rp-products-section">
                <h3 class="rp-section-title">🛒 Alle Produkte</h3>

                <!-- Filters -->
                <div class="rp-filters">
                    <input type="text" id="rpSearchInput" class="rp-search-input"
                        placeholder="🔍 Produkte durchsuchen...">
                    <select id="rpCategoryFilter" class="rp-filter-select">
                        <option value="">Alle Kategorien</option>
                    </select>
                    <select id="rpCompanyFilter" class="rp-filter-select">
                        <option value="">Alle Firmen</option>
                    </select>
                </div>

                <!-- Products Grid -->
                <div id="rpProductsGrid" class="rp-products-grid"></div>

                <!-- Empty State -->
                <div id="rpEmptyState" class="hidden"
                    style="text-align: center; padding: 40px; color: var(--text-light);">
                    <div style="font-size: 3rem; margin-bottom: 15px;">🔍</div>
                    <h3>Keine Produkte gefunden</h3>
                    <p>Versuche eine andere Suche oder Kategorie</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Stempelpass Container (Ausserhalb von rpContainer!) -->
    <div id="stempelContainer" class="stempel-container">
        <!-- Info Box (Neu) -->
        <div id="stempelMainInfoBox" class="info-item" style="margin-bottom: 20px;">
            <h4>🎟️ "DIGITAL & REGIONAL" - Sammeln & profitieren</h4>
        </div>

        <div id="stempelGrid" class="stempel-grid">
            <!-- Pässe werden dynamisch geladen -->
        </div>

        <div id="stempelEmpty" class="hidden" style="text-align: center; padding: 50px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">🎟️</div>
            <h3>Keine aktiven Pässe gefunden</h3>
            <p>Aktuell gibt es keine laufenden Stempel-Aktionen.</p>
        </div>

        <!-- Sicherungs-Information -->
        <div id="stempelBackupInfo" class="stempel-backup-box hidden">
            <div class="stempel-backup-content">
                <h4>🔒 Sicherung empfohlen</h4>
                <p>Speichern Sie Ihren Backup-QR-Code, um Ihre Stempel bei einem Handywechsel wiederherzustellen.</p>
            </div>
            <button class="stempel-backup-btn" onclick="openBackupModal()">Sicherungs-QR</button>
        </div>
    </div>

    <!-- Backup QR Modal -->
    <div id="backupModal" class="backup-modal-overlay">
        <div class="backup-modal">
            <button class="backup-modal-close" onclick="closeBackupModal()">✕</button>
            <h3 style="color: var(--primary);">Ihre Sicherung</h3>
            <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                Machen Sie einen Screenshot von diesem QR-Code. Mit diesem können Sie Ihre Stempel jederzeit
                wiederherstellen.
            </p>

            <div id="backupQrCanvas"></div>

            <div class="backup-user-id" id="backupUserIdDisplay">vch_...</div>

            <p style="font-size: 0.8rem; color: #888;">
                ⚠️ Geben Sie diesen Code niemals an andere weiter. Er ist Ihre anonyme Identität.
            </p>

            <button class="stempel-scan-btn" onclick="window.print()" style="background: #666;">
                🖨️ PDF / Drucken
            </button>
        </div>
    </div>

    <!-- QR Scanner Overlay -->
    <div id="scannerOverlay" class="scanner-overlay">
        <button class="scanner-close" onclick="closeScanner()">✕</button>
        <div style="color: white; margin-bottom: 20px; text-align: center; padding: 0 20px;">
            <h3>QR-Code scannen</h3>
            <p>Richte die Kamera auf den Stempel-Code im Betrieb.</p>
        </div>
        <div id="qr-reader"></div>
    </div>

    <footer id="mainFooter">
        Powered by <a href="https://fischervorchdorf.at" target="_blank">fischervorchdorf.at</a>
        <span id="versionInfo"></span>
    </footer>
    </div> <!-- Ende app-container -->

    <!-- Regionale Produkte Modal -->
    <div class="rp-modal-overlay" id="rpModalOverlay">
        <div class="rp-modal" id="rpModal">
            <button class="rp-modal-close" id="rpModalClose">✕</button>

            <div class="rp-modal-images" id="rpModalImages">
                <img id="rpModalImage" src="" alt="" class="rp-modal-image">
                <button id="rpPrevImage" class="rp-modal-nav prev">‹</button>
                <button id="rpNextImage" class="rp-modal-nav next">›</button>
            </div>

            <div class="rp-modal-content">
                <span id="rpModalCategory" class="rp-product-category-tag"></span>
                <h2 id="rpModalTitle" class="rp-modal-title"></h2>
                <div id="rpModalPrice" class="rp-modal-price"></div>
                <p id="rpModalDescription" class="rp-modal-description"></p>

                <div style="margin-top: 20px;">
                    <strong>Anbieter:</strong>
                    <div id="rpModalCompanyName" style="font-size: 1.1rem; color: var(--primary); margin-top: 5px;">
                    </div>
                    <a id="rpModalContactBtn" href="#" class="rp-modal-contact-btn"
                        style="margin-top: 15px; display: block;">
                        📧 Anbieter kontaktieren
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Flohmarkt Daten
        const FLOHMARKT_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1CrRpZwA19JcKfZsfbm9yZ3r_lEup-piI-QL4mY2kHnc/export?format=csv';

        let flohmarktAllProducts = [];
        let flohmarktCurrentProduct = null;
        let flohmarktCurrentImageIndex = 0;
        let showOnlyWerbering = true; // Standardmäßig nur Werbering zeigen

        const flohmarktCategoryIcons = {
            'Schulsachen': '📚',
            'Büromaterial': '✏️',
            'Spiele': '🎮',
            'Bücher': '📖',
            'Handarbeit': '🧶',
            'Deko': '🏠',
            'Elektro': '⚡',
            'Kinderartikel': '🧸',
            'Möbel': '🪑',
            'Kleidung': '👕',
            'Lederwaren': '👜',
            'Rauchzubehör': '🚬',
            'Sonstiges': '📦'
        };

        // Robuster CSV Parser mit Trennzeichen-Erkennung und Fallback
        function parseCSV(text) {
            // Detect delimiter based on first line
            const firstLine = text.split('\n')[0];
            const delimiter = firstLine.includes(';') ? ';' : ',';

            const arr = [];
            let quote = false;
            let col = 0, row = 0;

            // Normalize line endings
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

            for (let c = 0; c < text.length; c++) {
                let cc = text[c];
                let nc = text[c + 1];
                arr[row] = arr[row] || [];
                arr[row][col] = arr[row][col] || '';

                if (cc == '"') {
                    if (quote && nc == '"') {
                        arr[row][col] += cc; ++c;
                    } else {
                        quote = !quote;
                    }
                }
                else if (cc == delimiter && !quote) { ++col; }
                else if (cc == '\n' && !quote) { ++row; col = 0; }
                else { arr[row][col] += cc; }
            }

            // Clean headers
            const headers = arr[0].map(h => h.trim().replace(/^[\uFEFF\u200B]/, ''));
            const result = [];

            for (let i = 1; i < arr.length; i++) {
                const rowData = arr[i];
                if (rowData.length < 2) continue;

                const obj = {};

                // Strategy 1: Standard Map
                headers.forEach((h, idx) => {
                    obj[h] = rowData[idx] ? rowData[idx].trim() : '';
                });

                // Strategy 2: Fallback for critical fields if empty (using fixed indices based on Google Sheet structure)
                // 0:Timestamp, 1:Status, 2:Name, 3:Category, 4:Price, 5:Desc, 6:Firm, 7:Email, 8:Img1
                if (!obj['Produktname'] && rowData[2]) obj['Produktname'] = rowData[2];
                if (!obj['Kategorie'] && rowData[3]) obj['Kategorie'] = rowData[3];
                if (!obj['Preis in Euro'] && rowData[4]) obj['Preis in Euro'] = rowData[4];
                if (!obj['Firmenname'] && rowData[6]) obj['Firmenname'] = rowData[6];

                // Fallback for Address (Adresse)
                if (!obj['adresse']) {
                    const addressCandidates = ['Adresse', 'Anschrift', 'Strasse', 'Straße', 'Standort'];
                    for (const key of addressCandidates) {
                        if (obj[key]) {
                            obj['adresse'] = obj[key];
                            break;
                        }
                    }
                    // If still empty, try to find a column that looks like an address (contains digit and zip)
                    if (!obj['adresse']) {
                        // Look through all fields
                        for (const k in obj) {
                            if (obj[k] && typeof obj[k] === 'string' && obj[k].match(/\d{4}\s+/)) {
                                obj['adresse'] = obj[k];
                                break;
                            }
                        }
                    }
                }

                // Flexible Image Search
                if (!obj['Bild 1 Url von Imgur']) {
                    // Try column 8 or find any http link
                    if (rowData[8] && rowData[8].startsWith('http')) obj['Bild 1 Url von Imgur'] = rowData[8];
                }

                result.push(obj);
            }
            return result;
        }

        async function loadFlohmarktProducts() {
            try {
                // Footer nicht mehr verstecken!

                // const proxyUrl = 'https://api.allorigins.win/raw?url=';
                // let response;

                try {
                    response = await fetch(FLOHMARKT_SHEET_URL);
                } catch (e) {
                    console.error('Fetch error:', e);
                }

                if (!response || !response.ok) {
                    throw new Error('Network response was not ok');
                }

                const csv = await response.text();
                const products = parseCSV(csv);

                // Neueste zuerst
                products.reverse();

                flohmarktAllProducts = products;

                renderFlohmarktProducts(flohmarktAllProducts);

                renderFlohmarktProducts(flohmarktAllProducts);
            } catch (error) {
                console.error('Fehler beim Laden des Flohmarkts:', error);
                document.getElementById('flohmarktGrid').innerHTML = `
                    <div class="flohmarkt-empty" style="display: block; grid-column: 1/-1;">
                        <div class="flohmarkt-empty-icon">⚠️</div>
                        <h3>Fehler beim Laden</h3>
                        <p>Bitte später erneut versuchen</p>
                    </div>
                `;
            }
        }

        // Flohmarkt Produkte rendern
        function cleanImageUrl(url) {
            if (!url || typeof url !== 'string') return '';

            let cleaned = url.trim();

            // Entferne HTML-Tags und Whitespace
            cleaned = cleaned.replace(/<[^>]*>/g, '').trim();

            // Wenn es ein href-Link ist, extrahiere die URL
            if (cleaned.includes('href=')) {
                const match = cleaned.match(/href=["']([^"']+)["']/i);
                if (match && match[1]) {
                    cleaned = match[1].trim();
                }
            }

            // Entferne führende/nachfolgende Quotes
            cleaned = cleaned.replace(/^["']|["']$/g, '').trim();

            // Prüfe ob es eine echte URL ist (muss mit http anfangen)
            if (cleaned && (cleaned.startsWith('http://') || cleaned.startsWith('https://'))) {
                return cleaned;
            }

            return '';
        }

        function renderFlohmarktProducts(products) {
            const grid = document.getElementById('flohmarktGrid');
            const emptyState = document.getElementById('flohmarktEmpty');
            const stats = document.getElementById('flohmarktStats');

            if (products.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                stats.textContent = '';
                return;
            }

            emptyState.style.display = 'none';
            stats.textContent = `${products.length} Produkt${products.length !== 1 ? 'e' : ''} gefunden`;

            grid.innerHTML = products.map((product, index) => {
                // EXTREM ROBUSTE BILD-EXTRAKTION
                let imageUrl = '';

                // 1. Suche in bekannten Spalten
                const knownFields = ['Bild 1 Url von Imgur', 'Bild 1', 'Bild', 'Bild 2', 'Bild 3', 'Bild 4'];
                for (const field of knownFields) {
                    if (product[field] && String(product[field]).trim().startsWith('http')) {
                        imageUrl = String(product[field]).trim();
                        break;
                    }
                }

                // 2. Fallback: Suche in ALLEN Feldern nach einer URL (falls Spalten verschoben)
                if (!imageUrl) {
                    for (let key in product) {
                        const val = String(product[key]).trim();
                        if (val.startsWith('http') && (val.includes('imgur.com') || val.match(/\.(jpg|jpeg|png|gif|webp)$/i))) {
                            imageUrl = val;
                            break;
                        }
                    }
                }

                if (imageUrl) {
                    // Falls es HTML enthält, extrahiere reine URL
                    if (imageUrl.includes('href=')) {
                        const m = imageUrl.match(/href=["']([^"']+)["']/);
                        if (m) imageUrl = m[1];
                    }

                    // Imgur-Optimierung
                    if (imageUrl.includes('imgur.com/')) {
                        // Bereinige Album/Gallery-Links
                        imageUrl = imageUrl.replace(/\/(a|gallery)\//, '/');

                        // Stelle sicher dass es i.imgur.com ist und eine Endung hat
                        if (!imageUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                            // Extrahiere ID (letzter Teil der URL)
                            const parts = imageUrl.trim().split('/');
                            let lastPart = parts[parts.length - 1];
                            if (lastPart === '') lastPart = parts[parts.length - 2];
                            let id = lastPart.split(/[?#.]/)[0];
                            if (id) {
                                imageUrl = `https://i.imgur.com/${id}.jpg`;
                            }
                        } else {
                            // Nur Domain anpassen falls Endung schon da
                            imageUrl = imageUrl.replace('//imgur.com', '//i.imgur.com');
                        }
                    }
                }

                const category = product.Kategorie || 'Sonstiges';
                const icon = flohmarktCategoryIcons[category] || '📦';
                const price = flohmarktFormatPrice(product['Preis in Euro']);
                const seller = product.Firmenname || 'Anonym';

                return `
                    <article class="flohmarkt-product-card" onclick="openFlohmarktModal(${index})">
                        ${imageUrl ?
                        `<img src="${imageUrl}" alt="${product.Produktname}" class="flohmarkt-product-image" onerror="this.outerHTML='<div class=\\'flohmarkt-product-placeholder\\'>${icon}</div>'">` :
                        `<div class="flohmarkt-product-placeholder">${icon}</div>`
                    }
                        <div class="flohmarkt-product-info">
                            <span class="flohmarkt-product-category">${icon} ${category}</span>
                            <h3 class="flohmarkt-product-title">${product.Produktname || 'Ohne Titel'}</h3>
                            <div class="flohmarkt-product-price">${price}</div>
                            <div class="flohmarkt-product-seller">👤 ${seller}</div>
                        </div>
                    </article>
                `;
            }).join('');
        }

        // Preis formatieren
        function flohmarktFormatPrice(price) {
            if (!price) return 'Preis auf Anfrage';
            const num = parseFloat(price.replace(',', '.').replace(/[^0-9.]/g, ''));
            if (isNaN(num)) return price;
            return `€ ${num.toFixed(2).replace('.', ',')}`;
        }

        // Filter
        function filterFlohmarktProducts() {
            const search = document.getElementById('flohmarktSearch').value.toLowerCase();
            const category = document.getElementById('flohmarktCategory').value;
            const verkaeufer = document.getElementById('flohmarktVerkaeifer').value;

            const filtered = flohmarktAllProducts.filter(product => {
                const matchesSearch = !search ||
                    (product.Produktname && product.Produktname.toLowerCase().includes(search)) ||
                    (product.Beschreibung && product.Beschreibung.toLowerCase().includes(search));

                const matchesCategory = !category || product.Kategorie === category;
                const matchesVerkaeufer = !verkaeufer || product.Firmenname === verkaeufer;

                return matchesSearch && matchesCategory && matchesVerkaeufer;
            });

            renderFlohmarktProducts(filtered);
        }

        // Flohmarkt Modal öffnen
        function openFlohmarktModal(index) {
            const search = document.getElementById('flohmarktSearch').value.toLowerCase();
            const category = document.getElementById('flohmarktCategory').value;
            const verkaeufer = document.getElementById('flohmarktVerkaeifer').value;
            // Gefilterte Liste verwenden
            const filtered = flohmarktAllProducts.filter(product => {
                const matchesSearch = !search ||
                    (product.Produktname && product.Produktname.toLowerCase().includes(search)) ||
                    (product.Beschreibung && product.Beschreibung.toLowerCase().includes(search));
                const matchesCategory = !category || product.Kategorie === category;
                const matchesVerkaeufer = !verkaeufer || product.Firmenname === verkaeufer;
                return matchesSearch && matchesCategory && matchesVerkaeufer;
            });

            flohmarktCurrentProduct = filtered[index];
            flohmarktCurrentImageIndex = 0;

            if (!flohmarktCurrentProduct) return;

            // Bilder sammeln und direkt cleanieren
            const images = [
                flohmarktCurrentProduct['Bild 1 Url von Imgur'],
                flohmarktCurrentProduct['Bild 2'],
                flohmarktCurrentProduct['Bild 3'],
                flohmarktCurrentProduct['Bild 4']
            ].map(url => {
                if (!url) return '';
                let cleaned = url.trim();
                if (cleaned.includes('href=')) {
                    const m = cleaned.match(/href=["']([^"']+)["']/);
                    cleaned = m ? m[1] : '';
                }
                if (!cleaned.startsWith('http')) {
                    return '';
                }
                // Repariere unvollständige imgur.com URLs
                if (cleaned.includes('imgur.com/') && !cleaned.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                    const match = cleaned.match(/imgur\.com\/([a-zA-Z0-9]+)$/);
                    if (match) {
                        cleaned = `https://i.imgur.com/${match[1]}.jpg`;
                    }
                }
                return cleaned;
            }).filter(url => url);

            flohmarktCurrentProduct.images = images;

            // Modal befüllen
            const cat = flohmarktCurrentProduct.Kategorie || 'Sonstiges';
            const icon = flohmarktCategoryIcons[cat] || '📦';

            document.getElementById('flohmarktModalCategory').textContent = `${icon} ${cat}`;
            document.getElementById('flohmarktModalTitle').textContent = flohmarktCurrentProduct.Produktname || 'Ohne Titel';
            document.getElementById('flohmarktModalPrice').textContent = flohmarktFormatPrice(flohmarktCurrentProduct['Preis in Euro']);
            document.getElementById('flohmarktModalDescription').textContent = flohmarktCurrentProduct.Beschreibung || 'Keine Beschreibung vorhanden.';

            const sellerName = flohmarktCurrentProduct.Firmenname || 'Anonym';
            document.getElementById('flohmarktModalSellerName').textContent = sellerName;
            document.getElementById('flohmarktModalAvatar').textContent = sellerName.charAt(0).toUpperCase();

            const email = flohmarktCurrentProduct['Deine E-mail'] || 'kontakt@vorchdorf.at';
            // Cleaniere Image-URL direkt
            let imageUrl = flohmarktCurrentProduct['Bild 1 Url von Imgur'] || '';
            if (imageUrl) {
                imageUrl = imageUrl.trim();
                if (imageUrl.includes('href=')) {
                    const m = imageUrl.match(/href=["']([^"']+)["']/);
                    imageUrl = m ? m[1] : '';
                }
                if (!imageUrl.startsWith('http')) {
                    imageUrl = '';
                }
            }

            const subject = encodeURIComponent(`Anfrage zu: ${flohmarktCurrentProduct.Produktname}`);

            // Baue Email-Body mit allen Infos + Base64-Bild
            let emailBody = `Hallo ${sellerName},

ich interessiere mich für Ihr Produkt "${flohmarktCurrentProduct.Produktname}" auf dem Vorchdorf Flohmarkt.

Produktbeschreibung: ${flohmarktCurrentProduct.Beschreibung || 'Keine Angabe'}

Mit freundlichen Grüßen`;

            // Wenn Bild vorhanden, versuche es zu laden und als Base64 einzubinden
            if (imageUrl) {
                // Starte asynchrones Laden des Bildes - wird in openEmailPreviewModal verwendet
                loadImageAsBase64(imageUrl).then(base64Image => {
                    if (base64Image) {
                        window.flohmarktEmailImageBase64 = base64Image;
                    }
                });
            }

            // Click-Handler für Contact-Button - öffne Email-Modal
            document.getElementById('flohmarktModalContactBtn').onclick = function (e) {
                e.preventDefault();
                closeFlohmarktModal();
                openEmailPreviewModal(email, subject, emailBody, imageUrl, sellerName);
            };
            document.getElementById('flohmarktModalContactBtn').href = 'javascript:void(0)'; // Verhindere default-Link

            // Bilder
            updateFlohmarktModalImage();
            updateFlohmarktImageDots();

            // Navigation anzeigen/verstecken
            const hasMultipleImages = images.length > 1;
            document.getElementById('flohmarktPrevImage').style.display = hasMultipleImages ? 'block' : 'none';
            document.getElementById('flohmarktNextImage').style.display = hasMultipleImages ? 'block' : 'none';

            document.getElementById('flohmarktModalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function updateFlohmarktModalImage() {
            const images = flohmarktCurrentProduct.images || [];
            const container = document.getElementById('flohmarktModalImages');
            const img = document.getElementById('flohmarktModalImage');

            if (images.length > 0 && images[flohmarktCurrentImageIndex]) {
                img.src = images[flohmarktCurrentImageIndex];
                img.style.display = 'block';
            } else {
                const cat = flohmarktCurrentProduct.Kategorie || 'Sonstiges';
                const icon = flohmarktCategoryIcons[cat] || '📦';
                container.innerHTML = `
                    <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:4rem;background:linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);">${icon}</div>
                `;
            }
        }

        function updateFlohmarktImageDots() {
            const images = flohmarktCurrentProduct.images || [];
            const dotsContainer = document.getElementById('flohmarktModalDots');

            if (images.length <= 1) {
                dotsContainer.innerHTML = '';
                return;
            }

            dotsContainer.innerHTML = images.map((_, i) => `
                <button class="flohmarkt-modal-image-dot ${i === flohmarktCurrentImageIndex ? 'active' : ''}" onclick="goToFlohmarktImage(${i})"></button>
            `).join('');
        }

        function goToFlohmarktImage(index) {
            flohmarktCurrentImageIndex = index;
            updateFlohmarktModalImage();
            updateFlohmarktImageDots();
        }

        // ============================================
        // REGIONALE PRODUKTE LOGIC
        // ============================================
        const RP_PRODUCTS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1a-aYkGryPJiXjhp-6hPOrjRYHz199x8cy1t1mg6RVIE/export?format=csv&gid=0';
        const RP_COMPANIES_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1a-aYkGryPJiXjhp-6hPOrjRYHz199x8cy1t1mg6RVIE/export?format=csv&gid=760538274';

        const rpCategories = {
            'Obst & Beeren': '🍎',
            'Gemüse & Kartoffeln': '🥕',
            'Fleisch & Wurst': '🥩',
            'Milch & Käse': '🧀',
            'Eier & Geflügel': '🥚',
            'Brot & Süßwaren': '🥖',
            'Honig & Imkereiprodukte': '🍯',
            'Öle & Essig': '🫒',
            'Mehl & Getreide': '🌾',
            'Kräuter & Gewürze': '🌿',
            'Säfte & Getränke': '🧃',
            'Eingelegtes & Konserven': '🥫',
            'Fisch': '🐟'
        };

        let rpAllProducts = [];
        let rpAllCompanies = [];
        let rpCurrentView = 'categories';
        let rpCurrentCategory = null;
        let rpCurrentProduct = null;
        let rpCurrentImageIndex = 0;

        // Laden der Produkte
        async function loadRPProducts() {
            try {
                const response = await fetch(RP_PRODUCTS_SHEET_URL);
                const csv = await response.text();
                rpAllProducts = parseCSV(csv);

                console.log('✓ Regionale Produkte geladen:', rpAllProducts.length);
                return rpAllProducts;
            } catch (error) {
                console.error('Fehler beim Laden der Produkte:', error);
                return [];
            }
        }

        // Laden der Firmen
        async function loadRPCompanies() {
            try {
                const response = await fetch(RP_COMPANIES_SHEET_URL);
                const csv = await response.text();
                rpAllCompanies = parseCSV(csv);

                console.log('✓ Regionale Produkte Firmen geladen:', rpAllCompanies.length);
                return rpAllCompanies;
            } catch (error) {
                console.error('Fehler beim Laden der Firmen:', error);
                return [];
            }
        }

        // Initialisierung
        async function initializeRP() {
            await Promise.all([
                loadRPProducts(),
                loadRPCompanies()
            ]);

            renderRPCategories();
            populateRPFilters();
            renderRPProducts();
            renderDirectMarketers(); // NEU!
        }

        // Kategorien anzeigen
        function renderRPCategories() {
            const grid = document.getElementById('rpCategoryGrid');

            // Zähle Firmen pro Kategorie
            const categoryCounts = {};
            Object.keys(rpCategories).forEach(cat => {
                categoryCounts[cat] = rpAllCompanies.filter(company => company[cat] === 'x').length;
            });

            // Sortiere Kategorien alphabetisch
            const sortedCategories = Object.keys(rpCategories).sort();

            grid.innerHTML = sortedCategories.map(category => {
                const icon = rpCategories[category];
                const count = categoryCounts[category] || 0;
                const countClass = count === 0 ? 'zero' : '';

                return `
            <div class="rp-category-card" onclick="rpShowCompanies('${category}')">
                <span class="rp-category-icon">${icon}</span>
                <div class="rp-category-name">${category}</div>
                <div class="rp-category-count ${countClass}">${count} ${count === 1 ? 'Anbieter' : 'Anbieter'}</div>
            </div>
        `;
            }).join('');
        }

        // Firmen anzeigen
        function rpShowCompanies(category) {
            rpCurrentCategory = category;
            rpCurrentView = 'companies';

            // Views umschalten
            document.getElementById('rpCategoriesView').classList.add('hidden');
            document.getElementById('rpCompaniesView').classList.remove('hidden');
            document.getElementById('rpProductsSection').classList.add('hidden');
            document.getElementById('rpBackBtn').classList.remove('hidden');
            document.getElementById('backButton').classList.remove('hidden');
            document.getElementById('rpMainInfoBox').classList.add('hidden'); // Verstecke Info in Unterkategorien

            // Firmen für diese Kategorie filtern
            const companies = rpAllCompanies
                .filter(company => company[category] === 'x')
                .sort((a, b) => a.Firma.localeCompare(b.Firma, 'de'));

            // Titel setzen
            const icon = rpCategories[category];
            document.getElementById('rpCompaniesTitle').innerHTML = `${icon} ${category} - ${companies.length} Anbieter`;

            // Grid rendern
            const grid = document.getElementById('rpCompaniesGrid');
            grid.innerHTML = companies.map(company => {

                return `
            <div class="rp-company-card">
                <div class="rp-company-name">
                    🏢 ${company.Firma} ${company.homepage ? ' <span style="font-size: 0.8em; margin-left: 5px;">🌐</span>' : ''}
                </div>
                
                ${company.adresse ? `
                    <div class="rp-company-info-row">
                        <span class="rp-company-info-icon">📍</span>
                        <span class="rp-company-info-text">${company.adresse}</span>
                    </div>
                ` : ''}
                
                ${company.telefonnummer ? `
                    <div class="rp-company-info-row">
                        <span class="rp-company-info-icon">📞</span>
                        <span class="rp-company-info-text">
                            <a href="tel:${company.telefonnummer.replace(/\s/g, '')}" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                                ${company.telefonnummer}
                            </a>
                        </span>
                    </div>
                ` : ''}
                
                ${company.email ? `
                    <div class="rp-company-info-row">
                        <span class="rp-company-info-icon">📧</span>
                        <span class="rp-company-info-text">
                            <a href="mailto:${company.email}" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                                ${company.email}
                            </a>
                      </span>
    </div>
` : ''}
                
                ${company.öffnungszeiten ? `
                    <div class="rp-company-info-row">
                        <span class="rp-company-info-icon">🕐</span>
                        <span class="rp-company-info-text"><strong>Öffnungszeiten:</strong> ${company.öffnungszeiten}</span>
                    </div>
                ` : ''}
                
                ${company.verkaufsdaten ? `
                    <div class="rp-company-info-row">
                        <span class="rp-company-info-icon">🏪</span>
                        <span class="rp-company-info-text">
                            <strong>Verkauf auch bei:</strong><br>
                            ${company.verkaufsdaten.split(/(?=Bauernmarkt|Almtaler)/g)
                            .filter(s => s.trim())
                            .map(s => '• ' + s.trim())
                            .join('<br>')}
                        </span>
                    </div>
                ` : ''}
                
                ${company.zusatzinfos ? `
                    <div class="rp-company-info-row">
                        <span class="rp-company-info-icon">ℹ️</span>
                        <span class="rp-company-info-text">${company.zusatzinfos}</span>
                    </div>
                ` : ''}
                
                ${company.homepage && company.homepage.trim() ? `
                    <a href="${company.homepage.startsWith('http') ? company.homepage : 'https://' + company.homepage}" 
                       target="_blank" 
                       class="rp-company-website">
                        🌐 Website besuchen
                    </a>
                ` : ''}
            </div>
        `;
            }).join('');

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Filter befüllen
        function populateRPFilters() {
            // Kategorie-Filter
            const categoryFilter = document.getElementById('rpCategoryFilter');
            const sortedCategories = Object.keys(rpCategories).sort();
            categoryFilter.innerHTML = '<option value="">Alle Kategorien</option>' +
                sortedCategories.map(cat => `<option value="${cat}">${rpCategories[cat]} ${cat}</option>`).join('');

            // Firmen-Filter
            const companyFilter = document.getElementById('rpCompanyFilter');
            const uniqueCompanies = [...new Set(rpAllProducts.map(p => p.Firmenname).filter(f => f))].sort();
            companyFilter.innerHTML = '<option value="">Alle Firmen</option>' +
                uniqueCompanies.map(company => `<option value="${company}">${company}</option>`).join('');
        }

        // Produkte anzeigen & filtern
        function renderRPProducts() {
            const search = document.getElementById('rpSearchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('rpCategoryFilter').value;
            const companyFilter = document.getElementById('rpCompanyFilter').value;

            const filtered = rpAllProducts.filter(product => {
                const matchesSearch = !search ||
                    (product.Produktname && product.Produktname.toLowerCase().includes(search)) ||
                    (product.Beschreibung && product.Beschreibung.toLowerCase().includes(search)) ||
                    (product.Firmenname && product.Firmenname.toLowerCase().includes(search));

                const matchesCategory = !categoryFilter || product.Kategorie === categoryFilter;
                const matchesCompany = !companyFilter || product.Firmenname === companyFilter;

                return matchesSearch && matchesCategory && matchesCompany;
            });

            const grid = document.getElementById('rpProductsGrid');
            const emptyState = document.getElementById('rpEmptyState');

            if (filtered.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            grid.innerHTML = filtered.map((product, index) => {
                const images = extractRPImages(product);
                const icon = rpCategories[product.Kategorie] || '🍎';

                return `
            <div class="rp-product-card" onclick="rpShowProduct(${rpAllProducts.indexOf(product)})">
                ${images.length > 0 ?
                        `<img src="${images[0]}" alt="${product.Produktname}" class="rp-product-image" onerror="this.outerHTML='<div class=\\'rp-product-placeholder\\'>${icon}</div>'">` :
                        `<div class="rp-product-placeholder">${icon}</div>`
                    }
                <div class="rp-product-info">
                    <span class="rp-product-category-tag">${icon} ${product.Kategorie}</span>
                    <h3 class="rp-product-title">${product.Produktname || 'Unbenannt'}</h3>
                    <div class="rp-product-price">${product['Preis in Euro'] ? product['Preis in Euro'] + ' €' : 'Preis auf Anfrage'}</div>
                    <div class="rp-product-company-name">🏢 ${product.Firmenname || 'Privat'}</div>
                </div>
            </div>
        `;
            }).join('');
        }
        function renderDirectMarketers() {
            const grid = document.getElementById('rpDirectMarketersGrid');

            // Extrahiere Ort aus Adresse
            const companiesByLocation = {};

            rpAllCompanies.forEach(company => {
                let location = 'Sonstige';
                if (company.adresse) {
                    // Handle multiple separators: dash or comma
                    const parts = company.adresse.split(/[-,]/);
                    if (parts.length > 0) {
                        const zipCity = parts[0].trim();
                        const match = zipCity.match(/(\d{4})\s+(.+)/);
                        if (match && match[2]) {
                            location = match[2].trim();
                        } else {
                            location = zipCity;
                        }
                    }
                }

                // Korrektur Meindlhof Spezialfall
                if (company.Firma && company.Firma.includes('Meindlhof')) {
                    location = 'Schlatt'; // Korrigierter Standort
                }

                if (!companiesByLocation[location]) {
                    companiesByLocation[location] = [];
                }

                companiesByLocation[location].push(company);
            });

            // Sortiere Orte: Vorchdorf zuerst, dann alphabetisch
            const sortedLocations = Object.keys(companiesByLocation).sort((a, b) => {
                if (a.includes('Vorchdorf')) return -1;
                if (b.includes('Vorchdorf')) return 1;
                return a.localeCompare(b, 'de');
            });

            // Rendere HTML
            grid.innerHTML = sortedLocations.map((location, locIndex) => {
                // Reset numbering for each location
                let companyNumber = 1;

                const companies = companiesByLocation[location].sort((a, b) =>
                    a.Firma.localeCompare(b.Firma, 'de')
                );

                // Assign display numbers for this location group
                companies.forEach(c => c._displayNumber = companyNumber++);

                return `
                        <div class="rp-dm-location-group">
                            <h4 class="rp-dm-location-title">
                                📍 ${location} (${companies.length} ${companies.length === 1 ? 'Anbieter' : 'Anbieter'})
                            </h4>
                            <div class="rp-dm-company-list">
                                ${companies.map(company => {
                    const hasWebsite = company.homepage && company.homepage.trim().length > 3;
                    const url = hasWebsite ? (company.homepage.startsWith('http') ? company.homepage : 'https://' + company.homepage) : null;

                    return `
                                        <${url ? `a href="${url}" target="_blank"` : 'div'} class="rp-dm-company-item">
                                            <span class="rp-dm-company-number">${company._displayNumber}</span>
                                            <span class="rp-dm-company-name">${company.Firma} ${url ? ' 🌐' : ''}</span>
                                        </${url ? 'a' : 'div'}>
                                    `;
                }).join('')}
                            </div>
                        </div>
                    `;
            }).join('');
        }

        // Direktvermarkter A-Z anzeigen
        function rpShowDirectMarketersAZ() {
            // Verstecke alles andere
            document.getElementById('rpCategoriesView').classList.add('hidden');
            document.getElementById('rpProductsSection').classList.add('hidden');
            document.querySelector('.rp-info-tiles').style.display = 'none';
            document.querySelector('.rp-section-divider').style.display = 'none';

            // Zeige Direktvermarkter
            document.getElementById('rpDirectMarketersSection').classList.remove('hidden');
            document.getElementById('rpBackBtn').classList.remove('hidden');

            rpCurrentView = 'az';
            document.getElementById('floatingBackButton').classList.add('visible');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function extractRPImages(product) {

            const images = [];

            // Sammle alle Bild-URLs
            const potentialImages = [
                product['Bild 1 Url von Imgur'],
                product['Bild 2'],
                product['Bild 3'],
                product['Bild 4']
            ];

            potentialImages.forEach(url => {
                if (!url) return;

                let cleaned = url.trim();

                // Entferne HTML-Tags
                if (cleaned.includes('href=')) {
                    const match = cleaned.match(/href=["']([^"']+)["']/);
                    if (match) cleaned = match[1];
                }

                // Prüfe ob es eine gültige URL ist
                if (cleaned.startsWith('http')) {
                    // Imgur-URLs reparieren
                    if (cleaned.includes('imgur.com') && !cleaned.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                        const parts = cleaned.split('/');
                        const id = parts[parts.length - 1].split(/[?#]/)[0];
                        if (id) cleaned = `https://i.imgur.com/${id}.jpg`;
                    }
                    images.push(cleaned);
                }
            });

            return images;
        }

        // Produkt Detail Modal
        function rpShowProduct(index) {
            rpCurrentProduct = rpAllProducts[index];
            rpCurrentImageIndex = 0;

            const images = extractRPImages(rpCurrentProduct);
            const icon = rpCategories[rpCurrentProduct.Kategorie] || '🍎';

            document.getElementById('rpModalCategory').textContent = `${icon} ${rpCurrentProduct.Kategorie}`;
            document.getElementById('rpModalTitle').textContent = rpCurrentProduct.Produktname || 'Unbenannt';
            document.getElementById('rpModalPrice').textContent = rpCurrentProduct['Preis in Euro'] ? rpCurrentProduct['Preis in Euro'] + ' €' : 'Preis auf Anfrage';
            document.getElementById('rpModalDescription').textContent = rpCurrentProduct.Beschreibung || 'Keine Beschreibung vorhanden.';
            document.getElementById('rpModalCompanyName').textContent = rpCurrentProduct.Firmenname || 'Privat';

            // Email-Kontakt Setup
            const company = rpAllCompanies.find(c => c.Firma === rpCurrentProduct.Firmenname);
            const email = company?.email || 'kontakt@vorchdorf.at';
            const subject = encodeURIComponent(`Anfrage zu: ${rpCurrentProduct.Produktname}`);
            const imageUrl = images.length > 0 ? images[0] : '';
            const emailBody = `Hallo,

ich interessiere mich für Ihr Produkt "${rpCurrentProduct.Produktname}".

${rpCurrentProduct.Beschreibung ? 'Produktbeschreibung: ' + rpCurrentProduct.Beschreibung : ''}

Preis: ${rpCurrentProduct['Preis in Euro'] ? rpCurrentProduct['Preis in Euro'] + ' €' : 'Auf Anfrage'}

${imageUrl ? 'Produktbild: ' + imageUrl : ''}

Mit freundlichen Grüßen`;

            document.getElementById('rpModalContactBtn').onclick = function (e) {
                e.preventDefault();
                const mailtoLink = `mailto:${email}?subject=${subject}&body=${encodeURIComponent(emailBody)}`;
                window.location.href = mailtoLink;
            };

            // Bild anzeigen
            const modalImage = document.getElementById('rpModalImage');
            if (images.length > 0) {
                modalImage.src = images[rpCurrentImageIndex];
                modalImage.style.display = 'block';
                document.getElementById('rpPrevImage').style.display = images.length > 1 ? 'block' : 'none';
                document.getElementById('rpNextImage').style.display = images.length > 1 ? 'block' : 'none';
            } else {
                modalImage.style.display = 'none';
            }

            document.getElementById('rpModalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeRPModal() {
            document.getElementById('rpModalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        function rpPrevImage() {
            const images = extractRPImages(rpCurrentProduct);
            rpCurrentImageIndex = (rpCurrentImageIndex - 1 + images.length) % images.length;
            document.getElementById('rpModalImage').src = images[rpCurrentImageIndex];
        }

        function rpNextImage() {
            const images = extractRPImages(rpCurrentProduct);
            rpCurrentImageIndex = (rpCurrentImageIndex + 1) % images.length;
            document.getElementById('rpModalImage').src = images[rpCurrentImageIndex];
        }

        // Navigation
        function rpGoBack() {
            if (rpCurrentView === 'companies' || rpCurrentView === 'az') {
                // Von Firmen oder A-Z zurück zu Kategorien
                rpCurrentView = 'categories';
                document.getElementById('rpCategoriesView').classList.remove('hidden');
                document.getElementById('rpCompaniesView').classList.add('hidden');
                document.getElementById('rpProductsSection').classList.remove('hidden');
                document.getElementById('rpDirectMarketersSection').classList.add('hidden');
                document.querySelector('.rp-info-tiles').style.display = 'grid';
                document.querySelector('.rp-section-divider').style.display = 'block';
                document.getElementById('rpBackBtn').classList.add('hidden');
                document.getElementById('backButton').classList.remove('hidden');
                document.getElementById('floatingBackButton').classList.add('visible');
                document.getElementById('rpMainInfoBox').classList.remove('hidden'); // Zeige Info wieder auf Start
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Filter Event Listeners
        function filterRPProducts() {
            renderRPProducts();
        }

        // Lade Bild als Base64 (für Email-Einbettung)
        function loadImageAsBase64(imageUrl) {
            return fetch(imageUrl)
                .then(response => response.blob())
                .then(blob => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(blob);
                    });
                })
                .catch(() => null);
        }

        function closeFlohmarktModal() {
            document.getElementById('flohmarktModalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Flohmarkt Info Modal
        function openFlohmarktInfo() {
            console.log('openFlohmarktInfo called');
            const infoHtml = `
                <div class="flohmarkt-info-modal" style="background: white; border-radius: 16px; max-width: 800px; width: 95%; max-height: 90vh; padding: 50px 40px; position: relative; z-index: 10001; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <button class="flohmarkt-info-close" onclick="closeFlohmarktInfo()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 2rem; cursor: pointer; color: #666;">✕</button>
                    <h2 style="font-size: 2rem; color: #000000; margin: 0 0 20px 0;">ℹ️ Willkommen beim Vorchdorfer-Flohmarkt!</h2>
                    
                    <p style="font-size: 1.1rem; color: #000000; line-height: 1.6; margin: 10px 0;">Hier bieten unsere Werberingmitglieder ausgewählte Artikel an – Schnäppchen, Einzelstücke oder Waren, für die im Geschäft einfach der Platz fehlt.</p>
                    
                    <h3 style="font-size: 1.3rem; color: #000000; margin: 20px 0 10px 0;">So funktioniert's:</h3>
                    <p style="font-size: 1.1rem; color: #000000; line-height: 1.6; margin: 10px 0;">Stöbern Sie in den Angeboten. Wenn Ihnen etwas gefällt, drücken Sie einfach auf E-Mail senden. Der Verkäufer meldet sich bei Ihnen, um einen Abholtermin zu vereinbaren. Bezahlt wird erst bei der Abholung – direkt und unkompliziert, ganz ohne Online-Zahlung.</p>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button class="flohmarkt-info-btn-close" onclick="closeFlohmarktInfo()" style="background: #4CAF50; color: white; border: none; padding: 12px 30px; font-size: 1.1rem; border-radius: 8px; cursor: pointer;">✓ Schließen</button>
                    </div>
                </div>
            `;

            // Entferne alte Modal wenn existiert
            let oldModal = document.getElementById('flohmarktInfoModal');
            if (oldModal) {
                oldModal.remove();
            }

            // Erstelle neuen Modal mit INLINE STYLES
            const modal = document.createElement('div');
            modal.id = 'flohmarktInfoModal';
            modal.innerHTML = infoHtml;
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.5) !important;
                z-index: 999999 !important;
                padding: 20px !important;
                overflow-y: auto !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            document.body.appendChild(modal);

            // Click-handler zum schließen
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    closeFlohmarktInfo();
                }
            });

            document.body.style.overflow = 'hidden';
            console.log('Modal created and shown with inline styles');
        }

        function closeFlohmarktInfo() {
            console.log('closeFlohmarktInfo called');
            const modal = document.getElementById('flohmarktInfoModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
            console.log('Modal closed');
        }

        // Regionale Produkte Info Modal
        function openRPInfo() {
            const infoHtml = `
                <div class="rp-info-modal" style="background: white; border-radius: 16px; max-width: 800px; width: 95%; max-height: 90vh; padding: 50px 40px; position: relative; z-index: 10001; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <button class="rp-info-close" onclick="closeRPInfo()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 2rem; cursor: pointer; color: #666;">✕</button>
                    <h2 style="font-size: 2rem; color: #1a472a; margin: 0 0 20px 0;">ℹ️ Regionale Produkte aus Vorchdorf</h2>
                    
                    <h3 style="font-size: 1.3rem; color: #1a472a; margin: 20px 0 10px 0;">Qualität, die man kennt – aus der Region, für die Region</h3>
                    <p style="font-size: 1.1rem; color: #1a1a1a; line-height: 1.6; margin: 10px 0;">Wissen Sie, woher Ihr Brot kommt? Wer Ihre Eier produziert? Oder wo das Gemüse auf Ihrem Teller gewachsen ist?<br><br>
                    In Vorchdorf haben wir das Glück, von einer Vielzahl engagierter Produzenten umgeben zu sein, die mit Leidenschaft und Fachwissen hochwertige Lebensmittel und Produkte erzeugen. Menschen, die wir oft persönlich kennen. Nachbarn, die mit Sorgfalt und nach bestem Wissen und Gewissen arbeiten.</p>
                    
                    <h3 style="font-size: 1.3rem; color: #1a472a; margin: 25px 0 10px 0;">Regionalität ist mehr als ein Trend</h3>
                    <p style="font-size: 1.1rem; color: #1a1a1a; line-height: 1.6; margin: 10px 0;">Wenn wir regional kaufen, wählen wir Qualität. Wir wählen Frische. Wir wählen kurze Wege und damit auch Nachhaltigkeit. Vor allem aber wählen wir Vertrauen – denn wir wissen, wer hinter den Produkten steht.<br><br>
                    Diese Übersicht soll Ihnen zeigen, welche Vielfalt unsere Region zu bieten hat: von frischem Obst und Gemüse über handwerklich hergestellte Spezialitäten bis hin zu traditionellen Produkten. Entdecken Sie, wer was produziert und wo Sie diese Schätze direkt beziehen können.</p>

                    <h3 style="font-size: 1.3rem; color: #1a472a; margin: 25px 0 10px 0;">Gemeinsam stärken wir unsere Region</h3>
                    <p style="font-size: 1.1rem; color: #1a1a1a; line-height: 1.6; margin: 10px 0;">Jeder Einkauf bei unseren regionalen Erzeugern ist ein Beitrag zur Stärkung der lokalen Wirtschaft, zur Erhaltung unserer Kulturlandschaft und zur Sicherung von Arbeitsplätzen in Vorchdorf und Umgebung.<br><br>
                    Lernen Sie unsere Produzenten kennen – ihre Geschichten, ihre Produkte, ihre Leidenschaft für das, was sie tun.</p>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button class="rp-info-btn-close" onclick="closeRPInfo()" style="background: var(--primary); color: white; border: none; padding: 12px 30px; font-size: 1.1rem; border-radius: 8px; cursor: pointer; transition: all 0.3s;">✓ Schließen</button>
                    </div>
                </div>
            `;

            // Entferne alte Modal wenn existiert
            let oldModal = document.getElementById('rpInfoModal');
            if (oldModal) {
                oldModal.remove();
            }

            // Erstelle neuen Modal mit INLINE STYLES
            const modal = document.createElement('div');
            modal.id = 'rpInfoModal';
            modal.innerHTML = infoHtml;
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.5) !important;
                z-index: 999999 !important;
                padding: 20px !important;
                overflow-y: auto !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            document.body.appendChild(modal);

            // Click-handler zum schließen
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    closeRPInfo();
                }
            });

            document.body.style.overflow = 'hidden';
        }

        function closeRPInfo() {
            const modal = document.getElementById('rpInfoModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }

        // Email Preview Modal - mit Bild und HTML-Vorschau
        function openEmailPreviewModal(toEmail, subject, body, imageUrl, sellerName) {
            window.flohmarktEmailImageURL = imageUrl; // URL für sendEmailFromPreview speichern
            // Erstelle Modal-HTML
            let previewHtml = `
                <div class="email-preview-modal">
                    <div class="email-preview-content">
                        <h3>📧 Email-Vorschau</h3>
                        
                        <div class="email-header">
                            <p><strong>An:</strong> ${toEmail}</p>
                            <p><strong>Betreff:</strong> ${decodeURIComponent(subject)}</p>
                        </div>
                        
                        <div class="email-body">
                            <div style="white-space: pre-wrap; color: #333; line-height: 1.6;">${body.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                            ${imageUrl ? `<div class="email-image" style="margin-top: 20px; text-align: center;">
                                <img src="${imageUrl}" alt="Produktbild" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid #ddd;">
                            </div>` : ''}
                        </div>
                        
                        <div class="email-actions">
                            <button class="btn-primary" onclick="sendEmailFromPreview('${toEmail}', '${subject}', '${btoa(body)}')">📤 Email senden</button>
                            <button class="btn-secondary" onclick="closeEmailPreviewModal()">Abbrechen</button>
                        </div>
                    </div>
                </div>
            `;

            // Erstelle Modal-Container falls nicht vorhanden
            let modal = document.getElementById('emailPreviewModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'emailPreviewModal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                    z-index: 10000; padding: 20px;
                `;
                document.body.appendChild(modal);
            }

            modal.innerHTML = previewHtml;
            modal.style.display = 'flex';

            // Style Modal
            const styleTag = document.createElement('style');
            styleTag.textContent = `
                .email-preview-modal {
                    background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                    max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;
                    padding: 30px;
                }
                .flohmarkt-info-modal {
                    background: #ffffff; border-radius: 16px; box-shadow: 0 20px 80px rgba(0,0,0,0.5);
                    max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto;
                    padding: 50px 40px; position: relative; z-index: 10001;
                }
                .flohmarkt-info-close {
                    position: absolute; top: 20px; right: 20px;
                    width: 40px; height: 40px; border: none; background: #f0f0f0; border-radius: 50%;
                    font-size: 1.5rem; cursor: pointer; transition: all 0.3s;
                }
                .flohmarkt-info-close:hover {
                    background: #e0e0e0;
                }
                .flohmarkt-info-modal h2 {
                    margin-top: 0; color: #1a1a1a; margin-bottom: 25px; font-size: 2rem; font-weight: 700;
                }
                .flohmarkt-info-modal h3 {
                    color: #1a472a; margin-top: 30px; margin-bottom: 15px; font-size: 1.3rem; font-weight: 700;
                }
                .flohmarkt-info-modal p {
                    color: #1a1a1a; line-height: 1.8; margin-bottom: 20px; font-size: 1.1rem;
                }
                .flohmarkt-info-btn-close {
                    background: var(--primary); color: white; border: none;
                    padding: 15px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: 700;
                    cursor: pointer; transition: all 0.3s;
                }
                .flohmarkt-info-btn-close:hover {
                    background: var(--primary-lighter); transform: translateY(-2px);
                    box-shadow: 0 8px 20px rgba(26, 71, 42, 0.3);
                }
                .flohmarkt-info-overlay {
                    display: none;
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0, 0, 0, 1); align-items: center; justify-content: center;
                    z-index: 999999; padding: 20px; overflow-y: auto;
                }
                .flohmarkt-info-overlay.active {
                    display: flex !important;
                }
                .email-preview-content h3 {
                    margin-top: 0; color: #1a472a; margin-bottom: 20px; font-size: 1.3rem;
                }
                .email-header {
                    background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;
                    border-left: 4px solid #1a472a;
                }
                .email-header p {
                    margin: 5px 0; font-size: 0.95rem;
                }
                .email-body {
                    padding: 20px; background: #fafafa; border-radius: 8px; margin-bottom: 20px;
                    border: 1px solid #e0e0e0;
                }
                .email-actions {
                    display: flex; gap: 10px; justify-content: flex-end;
                }
                .btn-primary, .btn-secondary {
                    padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;
                    font-size: 0.95rem; font-weight: 500; transition: all 0.3s;
                }
                .btn-primary {
                    background: #1a472a; color: white;
                }
                .btn-primary:hover {
                    background: #2d7a47; transform: translateY(-2px);
                }
                .btn-secondary {
                    background: #ddd; color: #333;
                }
                .btn-secondary:hover {
                    background: #ccc;
                }
                .email-image {
                    text-align: center;
                }
            `;
            document.head.appendChild(styleTag);
        }

        function closeEmailPreviewModal() {
            const modal = document.getElementById('emailPreviewModal');
            if (modal) modal.style.display = 'none';
        }

        function sendEmailFromPreview(toEmail, subject, encodedBody) {
            let body = atob(encodedBody); // Decode from base64

            // Wenn Bild-URL verfügbar, füge sie dem Text hinzu
            if (window.flohmarktEmailImageURL) {
                body += `\n\nProdukt-Bild: ${window.flohmarktEmailImageURL}`;
            }

            const mailtoLink = `mailto:${toEmail}?subject=${subject}&body=${encodeURIComponent(body)}`;
            // Schließe zuerst das Modal, dann öffne Email
            closeEmailPreviewModal();
            // Kurze Verzögerung damit das Modal geschlossen ist bevor Email öffnet
            setTimeout(() => {
                window.open(mailtoLink, '_blank');
            }, 300);
        }

        // Event Listeners für Flohmarkt
        document.getElementById('flohmarktSearch').addEventListener('input', filterFlohmarktProducts);
        document.getElementById('flohmarktCategory').addEventListener('change', filterFlohmarktProducts);
        document.getElementById('flohmarktVerkaeifer').addEventListener('change', filterFlohmarktProducts);
        document.getElementById('flohmarktModalClose').addEventListener('click', closeFlohmarktModal);
        document.getElementById('flohmarktModalOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('flohmarktModalOverlay')) closeFlohmarktModal();
        });
        document.getElementById('flohmarktPrevImage').addEventListener('click', flohmarktPrevImage);
        document.getElementById('flohmarktNextImage').addEventListener('click', flohmarktNextImage);
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('flohmarktModalOverlay').classList.contains('active')) {
                if (e.key === 'Escape') closeFlohmarktModal();
                if (e.key === 'ArrowLeft') flohmarktPrevImage();
                if (e.key === 'ArrowRight') flohmarktNextImage();
            }
        });

        // ===== IMMEDIATE CACHE & SERVICE WORKER CLEANUP =====
        // MUST run FIRST before anything else
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(regs => {
                regs.forEach(reg => {
                    reg.unregister();
                    console.log('❌ SW unregistered');
                });
            });
        }
        if ('caches' in window) {
            caches.keys().then(names => names.forEach(name => caches.delete(name)));
        }

        // App Version - Update this with each release
        // App Version - Update this with each release
        const APP_VERSION = '9.6'; // Fix: Corrected HTML Nesting & Empty Screen on Start
        const CACHE_BUSTER = Date.now();
        // AGGRESSIVE CACHE BUSTING - Prüfe online ob neue Version existiert
        (async function checkForUpdates() {
            try {
                const response = await fetch('./index.html?t=' + Date.now(), {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                const html = await response.text();
                const match = html.match(/const APP_VERSION = '([^']+)'/);
                if (match && match[1] !== APP_VERSION) {
                    console.log('Neue Version verfügbar: ' + match[1]);
                    // Aktualisiere alle Caches und lade neu
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.getRegistrations().then(registrations => {
                            registrations.forEach(reg => reg.unregister());
                        });
                    }
                    if ('caches' in window) {
                        caches.keys().then(names => names.forEach(name => caches.delete(name)));
                    }
                    // Hard reload nach 2 Sekunden
                    setTimeout(() => {
                        window.location.href = './?t=' + Date.now();
                    }, 2000);
                }
            } catch (e) {
                console.log('Update-Check fehlgeschlagen:', e);
            }
        })();

        // AGGRESSIVE CACHE CLEARING
        // 1. Unregister all service workers
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(reg => reg.unregister());
            });
        }

        // 2. Clear all caches
        if ('caches' in window) {
            caches.keys().then(cacheNames => {
                cacheNames.forEach(cacheName => caches.delete(cacheName));
            });
        }

        // 3. Clear storage if version mismatch
        if (localStorage.getItem('appVersion') !== APP_VERSION) {
            localStorage.clear();
            sessionStorage.clear();
            localStorage.setItem('appVersion', APP_VERSION);
            localStorage.setItem('cacheBuster', CACHE_BUSTER);
            // Force hard refresh
            setTimeout(() => location.reload(true), 200);
        }

        // App State
        let currentView = 'home';
        let navigationHistory = [];
        let currentCategory = null;
        let currentSubcategory = null;
        let categoryCounts = {};

        // Stempelpass State
        let activePasses = [];
        let userStamps = JSON.parse(localStorage.getItem('vorchdorf_stamps') || '{}');
        let html5QrCode = null;

        // Anonyme User-ID generieren/laden (vch_ + 12 hex chars)
        function getUserId() {
            let userId = localStorage.getItem('vorchdorf_user_id');
            if (!userId) {
                // Generiere anonymen 12-stelligen Hex-Token
                const hex = Array.from({ length: 12 }, () => Math.floor(Math.random() * 16).toString(16)).join('');
                userId = 'vch_' + hex;
                localStorage.setItem('vorchdorf_user_id', userId);
            }
            return userId;
        }

        // Vormals device_id, jetzt vereinheitlicht auf user_id
        function getDeviceId() { return getUserId(); }

        // Stempelpass Initialisierung
        async function initializeStempelpässe() {
            const grid = document.getElementById('stempelGrid');
            const empty = document.getElementById('stempelEmpty');

            try {
                const response = await fetch('./stempel_data.json?v=' + Date.now());
                const data = await response.json();
                activePasses = data.passes;

                if (activePasses.length === 0) {
                    grid.innerHTML = '';
                    empty.classList.remove('hidden');
                    document.getElementById('stempelBackupInfo').classList.add('hidden');
                } else {
                    empty.classList.add('hidden');
                    // Backup Info nur zeigen wenn mindestens ein Stempel vorhanden ist
                    const totalStamps = Object.values(userStamps).reduce((acc, curr) => acc + curr.length, 0);
                    if (totalStamps > 0) {
                        document.getElementById('stempelBackupInfo').classList.remove('hidden');
                    }
                    renderStempelCards();
                }
            } catch (error) {
                console.error('Fehler beim Laden der Stempelpässe:', error);
                showDataError('Stempelpässe');
            }
        }

        function renderStempelCards() {
            const grid = document.getElementById('stempelGrid');
            grid.innerHTML = activePasses.map(pass => {
                const stamps = userStamps[pass.id] || [];
                const count = stamps.length;
                const progress = Math.min((count / pass.target_stamps) * 100, 100);

                return `
                            <div class="stempel-card">
                                <div class="stempel-card-title">
                                    <span>🎟️</span>
                                    <span>${pass.name}</span>
                                </div>
                                <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 15px;">${pass.description}</p>
                                
                                <div class="stempel-progress-container">
                                    <div class="stempel-progress-bar" style="width: ${progress}%"></div>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 700; color: var(--primary);">
                                    <span>Fortschritt</span>
                                    <span>${count} / ${pass.target_stamps}</span>
                                </div>

                                <div class="stempel-dots">
                                    ${Array.from({ length: pass.target_stamps }).map((_, i) => `
                                        <div class="stempel-dot ${i < count ? 'active' : ''}">
                                            ${i < count ? '✅' : i + 1}
                                        </div>
                                    `).join('')}
                                </div>

                                <button class="stempel-scan-btn" onclick="openScanner('${pass.id}')">
                                    📸 QR-Code scannen
                                </button>
                                
                                ${count >= pass.target_stamps ? `
                                    <button class="stempel-scan-btn" style="background: #4CAF50; margin-top: 10px;" onclick="redeemReward('${pass.id}')">
                                        🎁 Belohnung einlösen
                                    </button>
                                ` : ''}
                            </div>
                        `;
            }).join('');
        }

        function openScanner(passId) {
            const overlay = document.getElementById('scannerOverlay');
            if (!overlay) {
                alert("Fehler: Scanner-UI nicht gefunden.");
                return;
            }

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';

            try {
                html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    (decodedText) => {
                        handleQrResult(decodedText, passId);
                    }
                ).catch(err => {
                    console.error("Kamera-Fehler:", err);
                    let msg = "Kamera konnte nicht gestartet werden.\n\n";
                    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                        msg += "HINWEIS: Browser erlauben Kamera-Zugriff oft nur über HTTPS (verschlüsselt).\nBeim Testen per IP-Adresse kann dies blockiert werden.";
                    } else {
                        msg += "Bitte prüfe, ob du der App den Zugriff auf die Kamera erlaubt hast.";
                    }
                    alert(msg);
                    closeScanner();
                });
            } catch (e) {
                alert("Scanner-Initialisierungsfehler: " + e.message);
                closeScanner();
            }
        }

        function closeScanner() {
            const overlay = document.getElementById('scannerOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';

            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode = null;
                }).catch(err => console.error("Scanner Error:", err));
            }
        }

        function handleQrResult(text, passId) {
            closeScanner();

            try {
                const data = JSON.parse(text);

                // FALL 1: Stempel-QR gescannt
                // Unterstützt altes Format (vorchdorf_stamp) und neues Format (type: VORCHDORF_STAMP)
                if ((data.vorchdorf_stamp || data.type === 'VORCHDORF_STAMP') && data.pass_id === passId) {
                    validateAndAddStamp(passId, data.company_id);
                }
                // FALL 2: Backup-QR gescannt
                else if (data.type === 'VORCHDORF_USER_BACKUP' && data.user_id) {
                    restoreFromBackup(data.user_id);
                }
                else {
                    alert("❌ Ungültiger QR-Code für diesen Stempelpass.");
                }
            } catch (e) {
                alert("❌ Dieser QR-Code gehört nicht zum Vorchdorfer Stempel-System.");
            }
        }

        async function restoreFromBackup(newUserId) {
            if (confirm("Möchten Sie Ihren Stempelpass von der ID " + newUserId + " wiederherstellen?\n\nIhre aktuellen lokalen Stempel werden dabei überschrieben.")) {
                localStorage.setItem('vorchdorf_user_id', newUserId);

                // Hier in Zukunft: API Call um Stände vom Server zu laden
                // await loadStampsFromServer(newUserId);

                alert("✅ Stempelpass erfolgreich wiederhergestellt!");
                location.reload();
            }
        }

        function validateAndAddStamp(passId, companyId) {
            if (!userStamps[passId]) userStamps[passId] = [];

            // Regel: Nur 1 Stempel pro Tag pro Firma
            const today = new Date().toISOString().split('T')[0];
            const existing = userStamps[passId].find(s => s.companyId === companyId && s.date === today);

            if (existing) {
                alert("⚠️ Du hast heute bereits einen Stempel für diesen Betrieb erhalten!");
                return;
            }

            // Stempel hinzufügen
            userStamps[passId].push({
                companyId: companyId,
                date: today,
                timestamp: Date.now()
            });

            localStorage.setItem('vorchdorf_stamps', JSON.stringify(userStamps));
            renderStempelCards();

            // Backup Info einblenden
            document.getElementById('stempelBackupInfo').classList.remove('hidden');

            // Erfolgssound/Vibration simulieren & Info
            if ("vibrate" in navigator) navigator.vibrate(200);

            // API SYNC STUB
            syncStampWithServer(passId, companyId);

            alert("✅ Stempel erfolgreich hinzugefügt!");
        }

        // ============================================
        // BACKUP LOGIC
        // ============================================
        let backupQrInstance = null;

        function openBackupModal() {
            const overlay = document.getElementById('backupModal');
            const userId = getUserId();
            document.getElementById('backupUserIdDisplay').innerText = userId;
            overlay.classList.add('active');

            const qrContainer = document.getElementById('backupQrCanvas');
            qrContainer.innerHTML = ''; // Clear

            const backupData = {
                type: 'VORCHDORF_USER_BACKUP',
                user_id: userId
            };

            backupQrInstance = new QRCode(qrContainer, {
                text: JSON.stringify(backupData),
                width: 250,
                height: 250,
                colorDark: "#1a472a",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function closeBackupModal() {
            document.getElementById('backupModal').classList.remove('active');
        }

        // ============================================
        // SERVER SYNC STUBS
        // ============================================
        async function syncStampWithServer(passId, companyId) {
            const userId = getUserId();
            console.log("Syncing stamp to server:", { userId, passId, companyId });
            /* 
            fetch('/api/stamp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, pass_id: passId, company_id: companyId })
            }).catch(e => console.warn("Offline sync later..."));
            */
        }

        async function loadStampsFromServer(userId) {
            console.log("Loading stamps for user:", userId);
            // userStamps = await fetch('/api/user/' + userId).then(r => r.json());
            // localStorage.setItem('vorchdorf_stamps', JSON.stringify(userStamps));
        }

        function redeemReward(passId) {
            const pass = activePasses.find(p => p.id === passId);
            if (confirm(`Möchtest du deine Belohnung für "${pass.name}" jetzt beim Wirt/Händler einlösen?\n\nACHTUNG: Dies darf nur im Beisein des Personals geschehen!`)) {
                // In echt würde hier ein Server-Call passieren
                userStamps[passId] = []; // Zurücksetzen nach Einlösung
                localStorage.setItem('vorchdorf_stamps', JSON.stringify(userStamps));
                renderStempelCards();
                alert("🎉 Belohnung eingelöst! Herzlichen Glückwunsch.");
            }
        }

        // Hilfsfunktion: Zählt Einträge pro Kategorie
        function getCategoryItemCount(catId) {
            if (catId === 'shopping') {
                return allBusinesses.filter(b => b.werbering === true).length;
            }
            if (catId === 'clubs') {
                return Object.values(allClubs).reduce((acc, list) => acc + list.length, 0);
            }
            const cat = categories[catId];
            if (!cat) return 0;

            let count = 0;
            if (cat.items) count += cat.items.length;
            if (cat.subcategories) {
                Object.values(cat.subcategories).forEach(sub => {
                    if (sub.items) count += sub.items.length;
                });
            }
            if (cat.content && cat.content.items) count += cat.content.items.length;
            if (cat.content && cat.content.sections) {
                cat.content.sections.forEach(s => count += s.items.length);
            }
            return count;
        }

        // Global Business Data - Loaded from businesses.json
        let allBusinesses = [];
        let allClubs = {};

        // Gemeinde-Verwaltung Daten - Loaded from JSON
        let allFormulare = [];
        let allMitarbeiter = [];
        let allAbteilungen = [];
        let allGemeindebetriebe = [];

        // Data Structure
        // Kategorien werden aus categories.json geladen
        let categories = {};

        // Lade Kategorien aus JSON Datei
        async function loadCategories() {
            try {
                const response = await fetch('./categories.json?v=' + Date.now());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                categories = await response.json();
                console.log(`✓ ${Object.keys(categories).length} Kategorien geladen`);
            } catch (error) {
                console.error('Fehler beim Laden von categories.json:', error);
                showDataError('Kategorien');
            }
        }

        // Lade Businesses aus JSON Datei
        async function loadBusinesses() {
            try {
                // AGGRESSIVE CACHE BUSTING
                const response = await fetch('./businesses.json?v=' + Date.now());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const businesses = await response.json();

                // Speichere in allBusinesses Variable
                allBusinesses = businesses;

                console.log(`✓ ${businesses.length} Betriebe geladen`);

                if (businesses.length === 0) {
                    console.warn('Warnung: businesses.json ist leer');
                }
            } catch (error) {
                console.error('Fehler beim Laden von businesses.json:', error);
                allBusinesses = []; // Fallback zu leerem Array
                showDataError('Betriebe');
            }
        }

        async function loadClubs() {
            try {
                const response = await fetch('./clubs.json?v=' + Date.now());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const clubs = await response.json();
                allClubs = clubs;

                // Populate categories from the loaded data
                if (categories.clubs && categories.clubs.subcategories) {
                    Object.keys(clubs).forEach(key => {
                        if (categories.clubs.subcategories[key]) {
                            categories.clubs.subcategories[key].items = clubs[key];
                        }
                    });
                }

                // Sync Sport & Fitness subcategory
                if (categories.sport_fitness && categories.sport_fitness.subcategories && categories.sport_fitness.subcategories.sports_clubs) {
                    categories.sport_fitness.subcategories.sports_clubs.items = clubs.sport || [];
                }

                console.log(`✓ Vereine geladen`);
            } catch (error) {
                console.error('Fehler beim Laden von clubs.json:', error);
                allClubs = {};
                showDataError('Vereine');
            }
        }

        // Lade Gemeinde-Verwaltung Daten
        async function loadGemeindeData() {
            const ts = Date.now();
            try {
                // Lade Formulare
                const formResponse = await fetch(`./gemeinde-verwaltung/data/formulare.json?v=${ts}`);
                if (!formResponse.ok) throw new Error(`HTTP error! status: ${formResponse.status}`);
                const formData = await formResponse.json();
                allFormulare = formData.formulare || [];
                console.log(`✓ ${allFormulare.length} Formulare geladen`);
            } catch (error) {
                console.error('Fehler beim Laden von formulare.json:', error);
                allFormulare = [];
            }

            try {
                // Lade Mitarbeiter
                const mitResponse = await fetch(`./gemeinde-verwaltung/data/mitarbeiter.json?v=${ts}`);
                if (!mitResponse.ok) throw new Error(`HTTP error! status: ${mitResponse.status}`);
                const mitData = await mitResponse.json();
                allMitarbeiter = mitData.mitarbeiter || [];
                console.log(`✓ ${allMitarbeiter.length} Mitarbeiter geladen`);
            } catch (error) {
                console.error('Fehler beim Laden von mitarbeiter.json:', error);
                allMitarbeiter = [];
            }

            try {
                // Lade Abteilungen
                const abtResponse = await fetch(`./gemeinde-verwaltung/data/abteilungen.json?v=${ts}`);
                if (!abtResponse.ok) throw new Error(`HTTP error! status: ${abtResponse.status}`);
                const abtData = await abtResponse.json();
                allAbteilungen = abtData.abteilungen || [];
                console.log(`✓ ${allAbteilungen.length} Abteilungen geladen`);
            } catch (error) {
                console.error('Fehler beim Laden von abteilungen.json:', error);
                allAbteilungen = [];
            }

            try {
                // Lade Gemeindebetriebe
                const betResponse = await fetch(`./gemeinde-verwaltung/data/gemeindebetriebe.json?v=${ts}`);
                if (!betResponse.ok) throw new Error(`HTTP error! status: ${betResponse.status}`);
                const betData = await betResponse.json();
                allGemeindebetriebe = betData.betriebe || [];
                console.log(`✓ ${allGemeindebetriebe.length} Gemeindebetriebe geladen`);
            } catch (error) {
                console.error('Fehler beim Laden von gemeindebetriebe.json:', error);
                allGemeindebetriebe = [];
            }
        }

        function showDataError(type) {
            // Zeige eine kleine Warnung in der UI wenn Daten nicht geladen werden können
            const banner = document.createElement('div');
            banner.style.cssText = 'background: #ff4d4d; color: white; padding: 10px; text-align: center; font-size: 0.9em; position: sticky; top: 0; z-index: 9999;';
            banner.innerHTML = `⚠️ <b>Fehler:</b> ${type} konnten nicht geladen werden. Bitte Seite neu laden oder Cache leeren.`;
            document.body.prepend(banner);
            setTimeout(() => banner.remove(), 10000);
        }

        // Initialize App
        function init() {
            getDeviceId(); // Sicherstellen, dass Device ID existiert
            renderHome();
        }

        // Fetch Weather Data
        async function fetchWeather() {
            try {
                const lat = 48.0039;
                const lon = 13.9485;
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=Europe/Vienna`
                );
                const data = await response.json();
                return data.daily;
            } catch (error) {
                console.error('Wetter konnte nicht geladen werden:', error);
                return null;
            }
        }

        function getWeatherIcon(weatherCode) {
            const wmoToIcon = {
                0: '☀️', 1: '🌤️', 2: '⛅', 3: '☁️', 45: '🌫️', 48: '🌫️',
                51: '🌦️', 53: '🌦️', 55: '🌧️', 61: '🌧️', 63: '⛈️', 65: '⛈️',
                71: '❄️', 73: '❄️', 75: '❄️', 77: '❄️', 80: '🌧️', 81: '⛈️', 82: '⛈️',
                85: '❄️', 86: '❄️', 95: '⛈️', 96: '⛈️', 99: '⛈️'
            };
            return wmoToIcon[weatherCode] || '🌤️';
        }

        function getWeatherDescription(weatherCode) {
            const descriptions = {
                0: 'Klar', 1: 'Heiter', 2: 'Bewölkt', 3: 'Bedeckt', 45: 'Nebel', 48: 'Nebel',
                51: 'Leicht Regen', 53: 'Mäßig Regen', 55: 'Starker Regen', 61: 'Regen',
                63: 'Regen', 65: 'Starker Regen', 71: 'Schnee', 73: 'Schnee', 75: 'Schnee',
                77: 'Schnee', 80: 'Regen', 81: 'Starker Regen', 82: 'Extremer Regen',
                85: 'Schnee', 86: 'Schnee', 95: 'Gewitter', 96: 'Gewitter', 99: 'Gewitter'
            };
            return descriptions[weatherCode] || 'Unbekannt';
        }

        // Render Home View
        function renderHome() {
            currentView = 'home';
            navigationHistory = [];
            currentCategory = null;
            currentSubcategory = null;

            document.getElementById('emergencyBanner').classList.remove('hidden');
            document.getElementById('breadcrumb').classList.add('hidden');
            document.getElementById('backButton').classList.add('hidden');
            document.getElementById('floatingBackButton').classList.remove('visible');
            window.scrollTo({ top: 0, behavior: 'instant' });
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('flohmarktContainer').classList.remove('active');
            document.getElementById('rpContainer').classList.remove('active');
            document.getElementById('stempelContainer').classList.remove('active'); // Neu
            document.querySelector('.search-container').classList.remove('hidden');

            const mainContent = document.getElementById('mainContent');
            const weatherWidget = document.getElementById('weatherWidget');

            // Render categories in custom order
            const categoryOrder = ['welcome', 'municipality', 'health', 'emergency', 'administration', 'mobility', 'education', 'shopping', 'leisure', 'sport_fitness', 'clubs', 'events', 'gallery', 'mittagstisch', 'waste_calendar', 'stempelpass', 'flohmarkt', 'regionale_produkte', 'sags_uns'];
            const sortedCategories = categoryOrder.map(id => categories[id]).filter(cat => cat);

            mainContent.innerHTML = `
                <div class="cards-grid fade-in">
                    ${sortedCategories.map(cat => `
                        <div class="card" onclick="navigateToCategory('${cat.id}')">
                            <span class="card-icon">${cat.icon}</span>
                            <h3>${cat.title}</h3>
                            <p>${cat.description}</p>
                        </div>
                    `).join('')}
                </div>
            `;

            // Fetch and display weather in dedicated widget below emergency
            fetchWeather().then(weatherData => {
                if (weatherData && weatherData.time) {
                    weatherWidget.innerHTML = `
                        <div class="weather-container">
                            <h3>🌡️ Wetter in Vorchdorf</h3>
                            <div class="weather-content">
                                ${weatherData.time.slice(0, 3).map((date, idx) => {
                        const dateObj = new Date(date);
                        const dayName = dateObj.toLocaleDateString('de-DE', { weekday: 'short' });
                        const icon = getWeatherIcon(weatherData.weather_code[idx]);
                        const desc = getWeatherDescription(weatherData.weather_code[idx]);
                        const tempMax = Math.round(weatherData.temperature_2m_max[idx]);
                        const tempMin = Math.round(weatherData.temperature_2m_min[idx]);
                        return `
                                        <div class="weather-day">
                                            <h4>${dayName}</h4>
                                            <div class="weather-icon">${icon}</div>
                                            <div class="weather-temp">${tempMax}° / ${tempMin}°</div>
                                            <div class="weather-description">${desc}</div>
                                        </div>
                                    `;
                    }).join('')}
                            </div>
                        </div>
                    `;
                    weatherWidget.classList.remove('hidden');
                } else {
                    weatherWidget.classList.add('hidden');
                }
            }).catch(error => {
                console.error('Wetter-Fehler, verstecke Widget:', error);
                weatherWidget.classList.add('hidden');
            });
        }

        // Toggle Werbering Filter
        function toggleWerberingFilter() {
            showOnlyWerbering = !showOnlyWerbering;
            navigateToCategory('shopping');
        }

        // Navigate to Category
        function navigateToCategory(categoryId) {
            const category = categories[categoryId];
            if (!category) return;
            // Verstecke Search-Container standardmäßig bei allen Kategorien
            document.querySelector('.search-container').classList.add('hidden');
            // ZEIGE BACK BUTTON IMMER WENN NICHT HOME
            document.getElementById('backButton').classList.remove('hidden');

            // Handle Flohmarkt
            if (category.isFlohmarkt) {
                currentView = 'flohmarkt';
                currentCategory = categoryId;
                navigationHistory.push({ type: 'home' });

                document.getElementById('emergencyBanner').classList.add('hidden');
                document.getElementById('weatherWidget').classList.add('hidden');
                document.getElementById('backButton').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'instant' });
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('mainFooter').style.display = 'none';
                document.getElementById('flohmarktContainer').classList.add('active');
                updateBreadcrumb([{ text: category.title }]);

                loadFlohmarktProducts();
                return;
            }

            // Handle Regionale Produkte
            if (category.isRegionaleProdukte) {
                currentView = 'regionale_produkte';
                currentCategory = categoryId;
                navigationHistory.push({ type: 'home' });

                document.getElementById('emergencyBanner').classList.add('hidden');
                document.getElementById('weatherWidget').classList.add('hidden');
                document.getElementById('backButton').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'instant' });
                document.getElementById('mainContent').style.display = 'none';
                document.querySelector('.search-container').classList.add('hidden');
                document.getElementById('mainFooter').style.display = 'block';
                document.getElementById('rpContainer').classList.add('active');
                updateBreadcrumb([{ text: category.title }]);

                initializeRP();
                rpCurrentView = 'categories';
                document.getElementById('rpCategoriesView').classList.remove('hidden');
                document.getElementById('rpCompaniesView').classList.add('hidden');
                document.getElementById('rpProductsSection').classList.remove('hidden');
                document.getElementById('rpBackBtn').classList.add('hidden'); // Verstecke lokalen Button auf Startseite
                document.getElementById('backButton').classList.remove('hidden'); // Zeige globalen Button
                return;
            }

            // Handle Stempelpass
            if (category.isStempelpass) {
                currentView = 'stempelpass';
                currentCategory = categoryId;
                navigationHistory.push({ type: 'home' });

                document.getElementById('emergencyBanner').classList.add('hidden');
                document.getElementById('weatherWidget').classList.add('hidden');
                document.getElementById('backButton').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'instant' });
                document.getElementById('mainContent').style.display = 'none';
                document.querySelector('.search-container').classList.add('hidden'); // Neu
                document.getElementById('mainFooter').style.display = 'block';
                document.getElementById('stempelContainer').classList.add('active');
                updateBreadcrumb([{ text: category.title }]);

                initializeStempelpässe();
                return;
            }

            // Handle Waste Calendar
            if (category.wasteCalendar) {
                openWasteCalendar();
                return;
            }

            // Handle external links
            if (category.externalLink) {
                if (category.externalLink.startsWith('http')) {
                    window.open(category.externalLink, '_blank');
                } else {
                    window.location.href = category.externalLink;
                }
                return;
            }

            currentView = 'category';
            currentCategory = categoryId;
            currentSubcategory = null;
            navigationHistory.push({ type: 'home' });

            document.getElementById('emergencyBanner').classList.add('hidden');
            document.getElementById('weatherWidget').classList.add('hidden');
            document.getElementById('backButton').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'instant' });
            document.getElementById('flohmarktContainer').classList.remove('active');
            document.getElementById('rpContainer').classList.remove('active');
            document.getElementById('mainContent').style.display = 'block';
            updateBreadcrumb([{ text: category.title }]);

            const mainContent = document.getElementById('mainContent');

            if (category.subcategories) {
                // Show subcategories in defined order (already alphabetically sorted)
                const subcategoryList = Object.values(category.subcategories);
                // Zeige Search bei Shopping und Clubs
                if (categoryId === 'shopping' || categoryId === 'clubs') {
                    document.querySelector('.search-container').classList.remove('hidden');
                }
                else {
                    document.querySelector('.search-container').classList.add('hidden');
                }

                mainContent.innerHTML = `
                    <div class="detail-view fade-in">
                        <h2>${category.icon} ${category.title}</h2>
                        ${categoryId === 'shopping' ? `
                            <div class="info-item">
                                <h4>ℹ️ Über den Werbering</h4>
                                <p>👥 179 Werbering-Mitgliedsbetriebe in Vorchdorf, Laakirchen und Umgebung. Zusätzlich ca. 100 weitere Nicht-Mitglieder.</p>
                                <p>🎁 Werbering-Gutscheine bei allen Mitgliedern einlösbar</p>
                                <p>☎️ 0699 15 05 88 57 • ✉️ tipp@werbering-vorchdorf.at</p>
                                <p><a href="https://www.vorchdorfonline.at" target="_blank">🌐 www.vorchdorfonline.at</a></p>
                            </div>

                            <div onclick="toggleWerberingFilter()" style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 20px; padding: 15px; border-radius: 12px; background: ${showOnlyWerbering ? 'var(--secondary)' : 'white'}; border: 2px solid ${showOnlyWerbering ? 'var(--secondary)' : 'var(--border)'}; box-shadow: var(--shadow-md); transition: all 0.3s;">
                                <span style="font-size: 1.5rem;">🎖️</span>
                                <span style="font-weight: 700; color: ${showOnlyWerbering ? 'white' : 'var(--primary)'}; font-size: 1rem;">${showOnlyWerbering ? 'Alle Betriebe anzeigen' : 'Nur Werberingmitglieder anzeigen'}</span>
                                <div style="margin-left: auto; width: 24px; height: 24px; border-radius: 50%; border: 2px solid ${showOnlyWerbering ? 'white' : 'var(--border)'}; background: ${showOnlyWerbering ? 'white' : 'transparent'}; position: relative;">
                                    ${showOnlyWerbering ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 12px; height: 12px; background: var(--secondary); border-radius: 50%;"></div>' : ''}
                                </div>
                            </div>
                        ` : ''}
                        <div class="subcategory-list">
                            ${subcategoryList.map(sub => {
                    let subCount = 0;
                    if (categoryId === 'shopping') {
                        if (sub.id === 'all_businesses_az') {
                            subCount = allBusinesses.filter(b => b.werbering === true).length;
                        } else {
                            subCount = allBusinesses.filter(b => {
                                const isCategory = b.category === sub.id;
                                const matchesFilter = showOnlyWerbering ? b.werbering === true : true;
                                return isCategory && matchesFilter;
                            }).length;
                        }
                    } else if (categoryId === 'clubs') {
                        subCount = (allClubs[sub.id] || []).length;
                    } else {
                        subCount = (sub.items || []).length;
                    }

                    return `
                                    <div class="subcategory-item" onclick="navigateToSubcategory('${categoryId}', '${sub.id}')">
                                        <h4>${sub.title}</h4>
                                        <p>${sub.description || 'Klicken für Details'}</p>
                                        ${subCount > 0 ? `<div class="sub-count">${subCount} Einträge</div>` : ''}
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            } else if (category.content) {
                // Show direct content
                mainContent.innerHTML = renderContent(category);
            }
        }

        // Render Business Directory
        function renderBusinessDirectory() {
            return `
                <div class="detail-view fade-in">
                    <h2>🛍️ Werbering Vorchdorf - Alle Mitgliedsbetriebe</h2>
                    <div class="info-item">
                        <h4>ℹ️ Über den Werbering</h4>
                        <p>👥 179 Werbering-Mitgliedsbetriebe in Vorchdorf, Laakirchen und Umgebung. Zusätzlich ca. 100 weitere Nicht-Mitglieder.</p>
                        <p>🎁 Werbering-Gutscheine bei allen Mitgliedern einlösbar</p>
                        <p>📍 Vorchdorf, Laakirchen und Umgebung</p>
                        <p>☎️ 0699 15 05 88 57 • ✉️ tipp@werbering-vorchdorf.at</p>
                        <p><a href="https://www.vorchdorfonline.at" target="_blank">🌐 www.vorchdorfonline.at</a></p>
                    </div>
                    <div class="business-grid">
                        ${allBusinesses.map(business => {
                // Hole das Icon aus der entsprechenden Subcategory
                let categoryIcon = '📁';
                for (let catId in categories) {
                    const cat = categories[catId];
                    if (cat.subcategories && cat.subcategories[business.category]) {
                        const sub = cat.subcategories[business.category];
                        categoryIcon = sub.icon || sub.title.charAt(0);
                        break;
                    }
                }
                return `
                            <div class="business-card" ${business.link ? `onclick="window.open('${business.link}', '_blank')" style="cursor: pointer;"` : ''}>
                                <div class="business-name">${business.name}</div>
                                <div class="business-location">${business.location}</div>
                                ${business.link ? `<div class="business-link">🌐 Website →</div>` : ''}
                            </div>
                            `;
            }).join('')}
                    </div>
                </div>
            `;
        }

        // Navigate to Subcategory
        function navigateToSubcategory(categoryId, subcategoryId) {
            const category = categories[categoryId];
            const subcategory = category.subcategories[subcategoryId];
            if (!subcategory) return;

            // Check for direct link - if exists, open directly
            if (subcategory.directLink) {
                window.open(subcategory.directLink, '_blank');
                return;
            }

            // Check for external link - if exists, open in new tab if absolute
            if (subcategory.externalLink) {
                if (subcategory.externalLink.startsWith('http')) {
                    window.open(subcategory.externalLink, '_blank');
                } else {
                    window.location.href = subcategory.externalLink;
                }
                return;
            }

            currentView = 'subcategory';
            currentSubcategory = subcategoryId;
            navigationHistory.push({ type: 'category', categoryId });

            document.getElementById('backButton').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'instant' });
            document.getElementById('weatherWidget').classList.add('hidden');
            updateBreadcrumb([
                { text: category.title, action: `navigateToCategory('${categoryId}')` },
                { text: subcategory.title }
            ]);

            const mainContent = document.getElementById('mainContent');

            // Special handling for taxi quick call page
            if (categoryId === 'mobility' && subcategoryId === 'taxi_quick') {
                mainContent.innerHTML = `
                    <div class="detail-view fade-in">
                        <h2>☎️ ${subcategory.title}</h2>
                        <p style="color: var(--text-light); margin-bottom: 25px;">${subcategory.description}</p>
                        <div class="taxi-quick-grid">
                            <a href="tel:+436991824621" class="taxi-quick-box">
                                <div class="taxi-quick-icon">📞</div>
                                <div class="taxi-quick-text">
                                    <strong>Taxi Wiedl</strong>
                                    <p>0699 18246216</p>
                                </div>
                            </a>
                            <a href="tel:+436643366333" class="taxi-quick-box">
                                <div class="taxi-quick-icon">📞</div>
                                <div class="taxi-quick-text">
                                    <strong>Attwenger Taxi</strong>
                                    <p>0664 3366333</p>
                                </div>
                            </a>
                            <a href="https://www.gollinger.net" target="_blank" class="taxi-quick-box">
                                <div class="taxi-quick-icon">🚌</div>
                                <div class="taxi-quick-text">
                                    <strong>Gollinger</strong>
                                    <p>Website</p>
                                </div>
                            </a>
                            <a href="https://www.mietwagen-aigner.at" target="_blank" class="taxi-quick-box">
                                <div class="taxi-quick-icon">🚕</div>
                                <div class="taxi-quick-text">
                                    <strong>Aigner Taxi</strong>
                                    <p>Website</p>
                                </div>
                            </a>
                        </div>
                    </div>
                `;
            }
            // Special handling for shopping subcategories - show businesses
            else if (categoryId === 'shopping') {
                // Special handling for A-Z directory
                if (subcategoryId === 'all_businesses_az') {
                    // Group businesses by category and sort A-Z - NUR WERBERINGMITGLIEDER
                    const categoryMap = {};

                    // Group by category - nur Werberingmitglieder
                    allBusinesses.filter(b => b.werbering === true).forEach(business => {
                        if (!categoryMap[business.category]) {
                            categoryMap[business.category] = [];
                        }
                        categoryMap[business.category].push(business);
                    });

                    // Sort each category alphabetically by business name
                    Object.keys(categoryMap).forEach(cat => {
                        categoryMap[cat].sort((a, b) => a.name.localeCompare(b.name, 'de'));
                    });

                    // Get category titles from categories object and sort them alphabetically by title (without emoji)
                    const sortedCategories = Object.keys(categoryMap)
                        .map(catId => ({
                            id: catId,
                            title: categories.shopping.subcategories[catId].title,
                            businesses: categoryMap[catId]
                        }))
                        .sort((a, b) => {
                            // Remove emoji for sorting (emoji is usually at start with space after)
                            const titleA = a.title.replace(/^[^\w]*/, '').trim();
                            const titleB = b.title.replace(/^[^\w]*/, '').trim();
                            return titleA.localeCompare(titleB, 'de');
                        });

                    mainContent.innerHTML = `
                        <div class="detail-view fade-in">
                            <h2>🎖️ ${subcategory.title}</h2>
                            <p style="color: var(--text-light); margin-bottom: 30px;">${subcategory.description}</p>
                            <div style="max-width: 100%;">
                                ${sortedCategories.map(cat => `
                                    <div style="margin-bottom: 40px;">
                                        <h3 style="font-size: 1.3em; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--accent-color);">
                                            ${cat.title}
                                        </h3>
                                        <div class="business-grid">
                                            ${cat.businesses.map(business => `
                                                <div class="business-card" ${business.link ? `onclick="window.open('${business.link}', '_blank')" style="cursor: pointer;"` : ''}>
                                                    <div class="business-header" style="display: flex; justify-content: space-between; align-items: start;">
                                                        <div class="business-name" style="flex: 1;">${business.name}</div>
                                                        <span style="font-size: 1rem; margin-left: 8px;">🎖️</span>
                                                    </div>
                                                    <div class="business-location">📍 ${business.location}</div>
                                                    ${business.search ? `<div class="business-services" style="font-size: 0.85rem; color: var(--text-light); margin-top: 6px;">🔧 ${business.search}</div>` : ''}
                                                    ${business.link ? `<div class="business-link" style="margin-top: 8px; font-weight: 500;">🌐 Website →</div>` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    const categoryBusinesses = allBusinesses.filter(b =>
                        b.category === subcategoryId &&
                        (!showOnlyWerbering || b.werbering === true)
                    );
                    mainContent.innerHTML = `
                        <div class="detail-view fade-in">
                            <h2>${subcategory.title}</h2>
                            <p style="color: var(--text-light); margin-bottom: 20px;">${subcategory.description}</p>
                            <div class="business-grid">
                                ${categoryBusinesses.map(business => `
                                    <div class="business-card" ${business.link ? `onclick="window.open('${business.link}', '_blank')" style="cursor: pointer;"` : ''}>
                                        <div class="business-header" style="display: flex; justify-content: space-between; align-items: start;">
                                            <div class="business-name">${business.name}</div>
                                            ${business.werbering ? `<span style="font-size: 1.2rem;" title="Werberingmitglied">🎖️</span>` : ''}
                                        </div>
                                        <div class="business-location">📍 ${business.location}</div>
                                        ${business.search ? `<div class="business-services" style="font-size: 0.85rem; color: var(--text-light); margin-top: 6px;">🔧 ${business.search}</div>` : ''}
                                        ${business.link ? `<div class="business-link" style="margin-top: 8px; font-weight: 500;">🌐 Website →</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            } else {
                // Special handling for clubs - show both website and vorchdorfonline link
                if (categoryId === 'clubs') {
                    mainContent.innerHTML = `
                        <div class="detail-view fade-in">
                            <h2>${subcategory.title}</h2>
                            <p style="color: var(--text-light); margin-bottom: 20px;">${subcategory.description}</p>
                            <div class="items-grid">
                                ${subcategory.items.map(item => `
                                    <a href="${item.website || item.link}" target="_blank" class="item-card item-card-link">
                                        <div class="item-card-title">${item.title}</div>
                                        <div class="item-card-info">
                                            ${item.info.map(info => `<p>${info}</p>`).join('')}
                                        </div>
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    // Normal subcategory display for other categories
                    mainContent.innerHTML = `
                        <div class="detail-view fade-in">
                            <h2>${category.icon} ${subcategory.title}</h2>
                            <div class="items-grid">
                                ${subcategory.items.map(item => `
                                    <a href="${item.link || '#'}" target="_blank" class="item-card item-card-link">
                                        <div class="item-card-title">${item.title}</div>
                                        <div class="item-card-info">
                                            ${item.info.map(info => `<p>${info}</p>`).join('')}
                                        </div>
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Render Content
        function renderContent(category) {
            // Handle mixed type (like administration with intro + subcategories)
            if (category.content.type === 'mixed') {
                return `
                    <div class="detail-view fade-in">
                        <h2>${category.icon} ${category.title}</h2>
                        ${category.content.intro ? category.content.intro.map(item => `
                            <div class="info-item">
                                <h4>${item.title}</h4>
                                ${item.info.map(info => `<p>${info}</p>`).join('')}
                                ${item.link ? `<p><a href="${item.link}" target="_blank">→ Mehr Informationen</a></p>` : ''}
                            </div>
                        `).join('') : ''}
                        ${category.subcategories ? `
                            <h3 style="margin-top: 30px;">Bereiche & Services</h3>
                            <div class="subcategory-list">
                                ${Object.values(category.subcategories).map(sub => `
                                    <div class="subcategory-item" onclick="navigateToSubcategory('${category.id}', '${sub.id}')">
                                        <h4>${sub.title}</h4>
                                        <p>${sub.description || ''}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Handle list type (like education)
            if (category.content.type === 'list') {
                return `
                    <div class="detail-view fade-in">
                        <h2>${category.icon} ${category.title}</h2>
                        <div class="info-item">
                            <p style="color: var(--text-light); margin-bottom: 20px;">Alle Bildungseinrichtungen in Vorchdorf - Details auf der Gemeinde-Website:</p>
                        </div>
                        <div class="items-grid">
                            ${category.content.items.map(item => `
                                <a href="${item.link || '#'}" target="_blank" class="item-card item-card-link">
                                    <div class="item-card-title">${item.title}</div>
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Handle section type (like emergency)
            return `
                <div class="detail-view fade-in">
                    <h2>${category.icon} ${category.title}</h2>
                    ${category.content.sections.map(section => {
                // Verstecke spezifische Header auf Mobile/Tablet
                const hideClass = (section.title.includes('Herzlich willkommen') || section.title.includes('Notfall-Standorte')) ? 'mobile-hide-header' : '';
                return `
                        <div class="${hideClass}">
                            <h3>${section.title}</h3>
                            ${section.items.map(item => `
                                <div class="info-item">
                                    <h4>${item.title}</h4>
                                    ${item.info.map(info => `<p>${info}</p>`).join('')}
                                    ${item.wasteCalendar ? `<p><a href="#" onclick="event.preventDefault(); openWasteCalendar();">→ Müllkalender öffnen</a></p>` : item.link ? `<p><a href="${item.link}" target="_blank">→ Mehr Informationen</a></p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        // Go Back
        function handleFloatingBack() {
            if (currentView === 'regionale_produkte' && (rpCurrentView === 'companies' || rpCurrentView === 'az')) {
                rpGoBack();
            } else {
                goBack();
            }
        }
        function goBack() {
            window.scrollTo({ top: 0, behavior: 'instant' });
            if (navigationHistory.length === 0) {
                renderHome();
                return;
            }

            const last = navigationHistory.pop();
            if (last.type === 'home') {
                renderHome();
            } else if (last.type === 'category') {
                navigateToCategory(last.categoryId);
            }
        }

        // Go back to home
        function goHome() {
            navigationHistory = [];
            // Zeige Footer wieder wenn zur Home zurück
            const mainFooter = document.getElementById('mainFooter');
            if (mainFooter) {
                mainFooter.style.display = 'block';
            }
            document.querySelector('.search-container').classList.remove('hidden');
            document.getElementById('floatingBackButton').classList.remove('visible');
            renderHome();

        }

        // Open Waste Calendar
        function openWasteCalendar() {
            window.location.href = './muellkalender-vorchdorf-final.html';
        }

        // Update Breadcrumb
        function updateBreadcrumb(items) {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.classList.remove('hidden');

            let html = '<span class="breadcrumb-item" style="cursor: pointer;" onclick="renderHome()">🏠 Start</span>';

            items.forEach((item, index) => {
                html += '<span class="breadcrumb-separator">›</span>';
                if (item.action) {
                    html += `<span class="breadcrumb-item" style="cursor: pointer;" onclick="${item.action}">${item.text}</span>`;
                } else {
                    html += `<span class="breadcrumb-item">${item.text}</span>`;
                }
            });

            breadcrumb.innerHTML = html;
        }

        // Intelligent Search Mappings
        const searchMappings = {
            // Kategorie-Synonyme
            'bauen': ['construction', 'Bauen', 'Wohnen', 'Einrichten', 'Bau'],
            'bau': ['construction', 'Bauen', 'Wohnen', 'Einrichten'],
            'wohnen': ['construction', 'Bauen', 'Wohnen', 'Einrichten'],
            'einrichten': ['construction', 'Bauen', 'Wohnen', 'Einrichten'],
            'handwerker': ['construction', 'Bauen', 'Wohnen'],

            'hotel': ['gastro', 'Hotelerie', 'Gastronomie', 'Hotel', 'Pension', 'Bed & Breakfast'],
            'restaurant': ['gastro', 'Gastronomie', 'Restaurant', 'Gasthaus', 'Wirtshaus'],
            'gasthaus': ['gastro', 'Gastronomie', 'Gasthaus', 'Restaurant', 'Wirtshaus'],
            'cafe': ['gastro', 'Café', 'Kaffee', 'Bäckerei'],
            'kaffee': ['gastro', 'Café', 'Kaffee'],

            'frisör': ['beauty', 'Friseur', 'Haar', 'SCHNITT', 'HAARGENAU', 'HAARSTUDIO', 'BARBERSHOP'],
            'friseur': ['beauty', 'Friseur', 'Haar', 'SCHNITT', 'HAARGENAU', 'HAARSTUDIO', 'BARBERSHOP'],
            'haar': ['beauty', 'Haar', 'Friseur', 'SCHNITT', 'HAARGENAU', 'HAARSTUDIO'],
            'barbier': ['beauty', 'BARBERSHOP', 'Friseur', 'Haar'],

            'bäcker': ['food', 'gastro', 'Bäckerei', 'CAFÉ', 'Probst', 'Gwölb', 'Resch'],
            'bäckerei': ['food', 'gastro', 'Bäckerei', 'CAFÉ', 'Probst', 'Gwölb', 'Resch'],
            'brot': ['food', 'Bäckerei', 'CAFÉ'],

            'arzt': ['healthcare', 'Arzt', 'Apotheke', 'Gesundheit', 'Medizin', 'Allgemeinmedizin'],
            'apotheke': ['healthcare', 'Apotheke', 'Medizin', 'Gesundheit'],
            'zahnarzt': ['dentists', 'Zahnarzt', 'Zahnärzte', 'Klinkert', 'Krenmayr', 'Zahn'],
            'zahn': ['dentists', 'Zahnarzt', 'Zahnärzte', 'Klinkert', 'Krenmayr'],
            'kinderarzt': ['specialists', 'Kinderarzt', 'Kinderärzte', 'Kinder- und Fachärzte', 'Pädiatrie'],
            'facharzt': ['specialists', 'Facharzt', 'Fachärzte', 'Kinder- und Fachärzte', 'Spezialist'],
            'gesundheit': ['healthcare', 'Gesundheit', 'Arzt', 'Apotheke'],
            'sozial': ['social', 'Sozial', 'Hilfe', 'Sozialfonds', 'WIR helfen', 'Beratung'],
            'hilfe': ['social', 'Hilfe', 'Sozialfonds', 'WIR helfen', 'Unterstützung'],

            'schule': ['education', 'Schule', 'Volksschule', 'Mittelschule', 'Bildung'],
            'bildung': ['education', 'Bildung', 'Schule', 'Kindergarten', 'Lernen', 'Otelo'],
            'kindergarten': ['education', 'Kindergarten', 'Kinder', 'Bildung'],
            'bibliothek': ['education', 'Bibliothek', 'Bücherei', 'Bildung'],
            'otelo': ['education', 'Otelo', 'Offenes Technologielabor', 'Bildung'],
            'fitness': ['beauty', 'FITNESS', 'Sport', 'Training', 'Gym'],
            'sport': ['beauty', 'FITNESS', 'Sport', 'Training'],

            'auto': ['cars', 'KFZ', 'Auto', 'Werkstatt', 'Autohaus'],
            'kfz': ['cars', 'KFZ', 'Auto', 'Werkstatt'],
            'werkstatt': ['cars', 'KFZ', 'Werkstatt', 'Auto'],
            'fahrrad': ['cars', 'Fahrrad', 'Rad', 'Bike'],

            'bank': ['banks', 'Bank', 'Sparkasse', 'Raiffeisen', 'Geld'],
            'geld': ['banks', 'Bank', 'Sparkasse', 'Versicherung'],
            'versicherung': ['banks', 'Versicherung', 'Bank'],

            'anwalt': ['legal', 'Anwalt', 'Rechtsanwalt', 'Notar', 'Recht'],
            'rechtsanwalt': ['legal', 'Rechtsanwalt', 'Anwalt', 'Recht'],
            'notar': ['legal', 'Notar', 'Notariat'],

            'steuer': ['accounting', 'Steuer', 'Buchhaltung', 'Steuerberater'],
            'buchhaltung': ['accounting', 'Buchhaltung', 'Steuer'],

            'blumen': ['flowers', 'Blumen', 'Florist', 'Gärtnerei'],
            'garten': ['flowers', 'Gärtnerei', 'Garten', 'Blumen'],

            'essen': ['food', 'gastro', 'Lebensmittel', 'Essen', 'Restaurant'],
            'lebensmittel': ['food', 'Lebensmittel', 'Essen', 'Supermarkt', 'SPAR'],
            'supermarkt': ['food', 'SPAR', 'Lebensmittel'],

            'mode': ['fashion', 'Mode', 'Kleidung', 'Schuhe'],
            'kleidung': ['fashion', 'Mode', 'Kleidung', 'Bekleidung'],
            'schuhe': ['fashion', 'Schuhe', 'Mode'],

            'taxi': ['transport', 'Taxi', 'Transport', 'Fahrdienst'],
            'transport': ['transport', 'Transport', 'Taxi', 'Spedition'],

            'schmuck': ['jewelry', 'Schmuck', 'Juwelier', 'Uhren'],
            'uhren': ['jewelry', 'Uhren', 'Schmuck', 'Juwelier'],

            'tankstelle': ['gas', 'Tankstelle', 'Tanken', 'Benzin'],
            'tanken': ['gas', 'Tankstelle'],

            'foto': ['photo', 'Fotografie', 'Foto', 'Fotograf'],
            'fotograf': ['photo', 'Fotografie', 'Fotograf'],

            // Vereine
            'verein': ['clubs', 'Verein', 'Sport', 'Kultur', 'Musik'],
            'vereine': ['clubs', 'Vereine', 'Sport', 'Kultur', 'Musik'],

            // Sportvereine
            'union': ['clubs', 'sport', 'Union', 'Badminton', 'Laufgruppe', 'Schiclub', 'Tennis', 'Vikings', 'Tischtennis'],
            'askö': ['clubs', 'sport', 'ASKÖ', 'Fußball', 'Stocksport'],
            'askoe': ['clubs', 'sport', 'ASKÖ', 'Fußball', 'Stocksport'],
            'fussball': ['clubs', 'sport', 'Fußball', 'ASKÖ'],
            'fußball': ['clubs', 'sport', 'Fußball', 'ASKÖ'],
            'tennis': ['clubs', 'sport', 'Tennis', 'Tennisclub', 'BAM.wohnen'],
            'badminton': ['clubs', 'sport', 'Badminton', 'Union'],
            'tischtennis': ['clubs', 'sport', 'Tischtennis', 'Union'],
            'basketball': ['clubs', 'sport', 'Basketball', 'Vikings', 'Union'],
            'vikings': ['clubs', 'sport', 'Vikings', 'Basketball'],
            'schi': ['clubs', 'sport', 'Schi', 'Schiclub', 'Seyr Dach'],
            'ski': ['clubs', 'sport', 'Schi', 'Schiclub', 'Seyr Dach'],
            'laufen': ['clubs', 'sport', 'Laufen', 'Laufgruppe', 'Union'],
            'stocksport': ['clubs', 'sport', 'Stocksport', 'ASKÖ'],
            'fischen': ['clubs', 'sport', 'Fischen', 'Fischerclub', 'Almtal'],
            'angeln': ['clubs', 'sport', 'Angeln', 'Fischerclub', 'Almtal'],
            'schützen': ['clubs', 'sport', 'Schützen', 'Schützenverein', 'Schießen', 'Theuerwang'],
            'schiessen': ['clubs', 'sport', 'Schießen', 'Schützen'],
            'fitness': ['clubs', 'sport', 'Fitness', 'Body Strength', 'Training'],
            'workout': ['clubs', 'sport', 'Workout', 'Body Strength'],

            // Musikvereine
            'musik': ['clubs', 'musik', 'Musik', 'Marktmusik', 'Musikverein', 'Chor'],
            'blasmusik': ['clubs', 'musik', 'Blasmusik', 'Marktmusik', 'Siebenbürger'],
            'chor': ['clubs', 'musik', 'Chor', 'Sängerbund', 'Gesang', 'Sunshine', 'Trinitatis'],
            'singen': ['clubs', 'musik', 'Singen', 'Chor', 'Sängerbund'],
            'marktmusik': ['clubs', 'musik', 'Marktmusik', 'MMV'],

            // Kulturvereine
            'kultur': ['clubs', 'kultur', 'Kultur', 'Theater', 'Heimatverein', 'Museum'],
            'theater': ['clubs', 'kultur', 'Theater', 'Theatergruppe'],
            'museum': ['clubs', 'kultur', 'Museum', 'Heimatverein'],
            'heimatverein': ['clubs', 'kultur', 'Heimatverein', 'Museum'],
            'fasching': ['clubs', 'kultur', 'Fasching', 'Vori Dori', 'Faschingsgilde'],
            'foto': ['clubs', 'kultur', 'Foto', 'Fotoklub', 'Naturfreunde'],
            'fotografie': ['clubs', 'kultur', 'Fotografie', 'Fotoklub'],
            'kitzmantelfabrik': ['clubs', 'kultur', 'Kitzmantelfabrik', 'Kulturvilla'],

            // Sport & Fitness (neue Kategorie)
            'fitnessstudio': ['sport_fitness', 'fitness', 'Fitnessstudio', 'Training', 'Gym'],
            'gym': ['sport_fitness', 'fitness', 'Fitnessstudio', 'Training'],
            'anytime': ['sport_fitness', 'fitness', 'ANYTIME FITNESS', 'Fitnessstudio'],
            'training': ['sport_fitness', 'fitness', 'Training', 'Fitnessstudio'],
            'spielplatz': ['leisure', 'playgrounds', 'Spielplatz', 'Kinder', 'Spielgeräte', 'Kindertraum'],
            'spielplätze': ['leisure', 'playgrounds', 'Spielplatz', 'Kinder', 'Spielgeräte'],
            'kinder': ['leisure', 'playgrounds', 'Kinder', 'Spielplatz', 'Kinderfreundlich'],
            'schulstraße': ['leisure', 'playgrounds', 'Schulstraße', 'Spielplatz'],
            'krumphuberweg': ['leisure', 'playgrounds', 'Krumphuberweg', 'Spielplatz'],
            'kirchham': ['leisure', 'playgrounds', 'Kirchham', 'Spielplatz'],

            // Notfall & Sicherheit
            'polizei': ['emergency', 'Polizei', 'Sicherheit', 'Notfall', 'Vorchdorf'],
            'rettung': ['emergency', 'Rettung', 'Notfall', 'Rettungsdienst', 'Ambulanz'],
            'feuerwehr': ['emergency', 'Feuerwehr', 'Notfall', 'Brand', 'Hilfe'],
            'notruf': ['emergency', 'Notruf', 'Notfall', '144', '133', '122'],
            'notfall': ['emergency', 'Notfall', 'Notfallkontakte', 'Standorte', 'Rettung'],
            'defibrillator': ['emergency', 'Defibrillator', 'AED', 'Pfarrhof', 'Rettung'],
            'aed': ['emergency', 'AED', 'Defibrillator'],
            'notfallstandorte': ['emergency', 'Notfall', 'Standorte', 'Polizei', 'Feuerwehr'],

            // Sozial & Jugend
            'jugend': ['clubs', 'soziales', 'Jugend', 'Jugendzentrum', 'Pfadfinder', 'Landjugend'],
            'juz': ['clubs', 'soziales', 'JUZ', 'Jugendzentrum'],
            'pfadfinder': ['clubs', 'soziales', 'Pfadfinder', 'Jugend'],
            'landjugend': ['clubs', 'soziales', 'Landjugend', 'Jugend'],
            'otelo': ['clubs', 'soziales', 'OTELO', 'Technologielabor', 'Offenes Labor'],
            'eltern': ['clubs', 'soziales', 'Eltern', 'Elternverein', 'Schule'],

            // Rettungsorganisationen
            'wasserrettung': ['clubs', 'sport', 'Wasserrettung', 'ÖWR', 'Rettung'],
            'öwr': ['clubs', 'sport', 'ÖWR', 'Wasserrettung'],
            'rotes kreuz': ['clubs', 'soziales', 'Rotes Kreuz', 'Rettung'],
            'roteskreuz': ['clubs', 'soziales', 'Rotes Kreuz', 'Rettung'],
            'rettung': ['clubs', 'Rettung', 'Wasserrettung', 'Rotes Kreuz'],

            // Religion
            'kirche': ['clubs', 'religion', 'Kirche', 'Katholisch', 'Evangelisch'],
            'katholisch': ['clubs', 'religion', 'Katholisch', 'Pfarre', 'Jungschar', 'Jugend'],
            'evangelisch': ['clubs', 'religion', 'Evangelisch', 'Kirche'],
            'jungschar': ['clubs', 'religion', 'Jungschar', 'Katholisch', 'Kinder'],

            // Sonstige
            'bibliothek': ['clubs', 'sonstiges', 'Bibliothek', 'Bücherei'],
            'werbering': ['clubs', 'sonstiges', 'Werbering', 'Wirtschaft'],
            'naturfreunde': ['clubs', 'sport', 'kultur', 'Naturfreunde', 'Fotoklub', 'Wandern'],
            'weltladen': ['clubs', 'soziales', 'Weltladen', 'Fair Trade']
        };

        // Normalisiere deutsche Umlaute und Sonderzeichen für besseres Matching
        function normalizeString(str) {
            if (!str) return '';
            return str.toLowerCase()
                .replace(/ä/g, 'ae')
                .replace(/ö/g, 'oe')
                .replace(/ü/g, 'ue')
                .replace(/ß/g, 'ss')
                .trim();
        }

        // Intelligente Synonym-Suche mit Fuzzy Matching
        function getSearchSynonyms(term) {
            const normalized = normalizeString(term);
            const synonymMap = {
                // Friseur/Friseuse Variationen
                'frisoe': ['friseur', 'friseurin', 'friseuse', 'haarschnitt', 'frisur', 'barber', 'barbershop', 'haargenau', 'haarstudio', 'schnitt'],
                'friseur': ['friseuse', 'friseurin', 'haarschnitt', 'barber', 'barbershop', 'haarschneid', 'haargenau', 'haarstudio', 'schnitt'],

                // Tabak/Zigaretten Variationen
                'zigaretten': ['tabak', 'trafik', 'rauchen', 'rauchwaren', 'smoker'],
                'tabak': ['zigaretten', 'trafik', 'rauchen', 'rauchwaren'],
                'trafik': ['tabak', 'zigaretten', 'rauchen', 'rauchwaren'],
                'rauchen': ['tabak', 'trafik', 'zigaretten', 'rauchwaren'],
                'rauchwaren': ['tabak', 'trafik', 'zigaretten', 'rauchen'],

                // Handwerker Variationen
                'handwerker': ['installateur', 'elektro', 'klempner', 'maler'],
                'installateur': ['installation', 'gas', 'heizung', 'sanitaer'],
                'klempner': ['installateur', 'sanitaer', 'heizung'],
                'wasser': ['installateur', 'klempner', 'rohre', 'sanitaer', 'heizung', 'installation'],
                'rohre': ['rohrverlegung', 'rohrleitungen', 'installation', 'klempner', 'sanitaer'],
                'maler': ['anstreicher', 'malermeister', 'malerarbeiten'],
                'anstreicher': ['maler', 'malermeister', 'malerarbeiten', 'anstrich'],

                // Arzt Variationen
                'arzt': ['doktor', 'zahnarzt', 'zahndoktor', 'facharzt', 'allgemeinarzt'],
                'zahnarzt': ['zahndoktor', 'dental', 'zahn', 'zaehnchen'],
                'zahndoktor': ['zahnarzt', 'dental', 'zahn'],

                // Auto Variationen
                'auto': ['auto', 'kfz', 'fahrzeug', 'wagen', 'pkw', 'automobile', 'autohaus', 'werkstatt'],
                'werkstatt': ['auto', 'kfz', 'service', 'reparatur'],
                'tankstelle': ['benzin', 'diesel', 'zapfsaeule', 'tanken'],

                // Restaurant/Gastro Variationen
                'restaurant': ['gaststaette', 'gasthof'],
                'gaststaette': ['gasthof', 'restaurant'],
                'pizzeria': ['pizza', 'italiener'],
                'cafe': ['kaffee', 'kaffe', 'baecker', 'baeckerei', 'bakery'],
                'baecker': ['baeckerei', 'cafe', 'kaffee', 'broetchen'],

                // Apotheke
                'apotheke': ['pharmazie', 'pharmazeut', 'medikament', 'arznei'],

                // Bank Variationen
                'bank': ['sparkasse', 'kasse', 'geldautomat', 'geldwechsel'],
                'sparkasse': ['bank', 'geldautomat', 'kasse'],

                // Fitness/Sport
                'fitness': ['gym', 'fitnessstudio', 'training', 'krafttraining', 'sport'],
                'gym': ['fitness', 'fitnessstudio', 'training'],

                // Frisur/Haarpflege
                'haarschnitt': ['friseur', 'friseurin', 'friseuse', 'schneid'],
                'haarschneid': ['friseur', 'friseuse', 'haarschnitt'],

                // Kleidung/Mode
                'mode': ['kleidung', 'kleidungsgschaft', 'boutique', 'fashion'],
                'kleidung': ['mode', 'boutique', 'fashion', 'garderobe'],

                // Spielzeug/Kinderartikel
                'spielzeug': ['spielwaren', 'kinderspielzeug', 'babyartikel'],
                'spielwaren': ['spielzeug', 'kinderspielzeug'],

                // Moebel
                'moebel': ['einrichtung', 'einrichtungshaus', 'mobilistaer', 'moebelladen'],
                'einrichtung': ['moebel', 'einrichtungshaus', 'mobilistaer'],

                // Blumen/Florist
                'blumen': ['florist', 'blumenladen', 'bluemchen', 'straus'],
                'florist': ['blumen', 'blumenladen', 'straus'],

                // Buecher/Buchhandlung
                'buecher': ['buchhandlung', 'buchhandel', 'buch', 'buecher', 'lesen'],
                'buchhandlung': ['buecher', 'buchhandel', 'buch'],

                // Elektro
                'elektro': ['elektrotechnik', 'elektrogeraete', 'strom'],
                'elektrotechnik': ['elektro', 'elektrogeraete'],

                // Schluessel/Schlosser
                'schluessel': ['schlosser', 'schloss', 'schluesseldienst'],
                'schlosser': ['schluessel', 'schloss', 'schluesseldienst'],

                // Photographie/Fotograf
                'foto': ['fotograf', 'fotografie', 'fotostudio', 'bilder'],
                'fotograf': ['foto', 'fotografie', 'fotostudio'],
                'fotografie': ['fotograf', 'foto', 'fotostudio'],

                // Versicherung
                'versicherung': ['versicherer', 'versicherungsagent', 'versicherungsmakler'],
                'versicherungsmakler': ['versicherung', 'versicherer'],

                // Rechtsanwalt
                'anwalt': ['rechtsanwalt', 'anwaeltin', 'jura', 'legal'],
                'rechtsanwalt': ['anwalt', 'anwaeltin', 'jura', 'legal'],

                // Zahnarzt Alternative
                'zaehne': ['zahnarzt', 'zahndoktor', 'dental', 'zahn'],
                'zahn': ['zahnarzt', 'zahndoktor', 'zaehne', 'dental'],

                // Verein/Club
                'verein': ['club'],
                'club': ['verein'],

                // Schule
                'schule': ['schulen', 'gymnasium', 'gymnasium', 'volksschule', 'unterstufe', 'oberstufe'],
                'kindergarten': ['vorschule', 'kinderbetreuung', 'vorschulisch'],

                // Kirche/Religion
                'kirche': ['religion', 'kirchen', 'evangelisch', 'katholisch'],
                'religion': ['kirche'],
                'pfarr': ['pfarre', 'pfarrkirche', 'pfarrer'],
            };

            // Sammle ALLE möglichen Matches
            const allSynonyms = new Set(); // NICHT mit term starten - nur echte Matches

            // Suche in der Map nach Matches
            Object.entries(synonymMap).forEach(([key, synonyms]) => {
                // NUR wenn der Suchbegriff mit dem Key ANFÄNGT oder der Key ANFÄNGT mit dem Suchbegriff
                // (nicht bidirektional bei Synonymen, nur bei Keys)
                if (key.startsWith(normalized) || normalized.startsWith(key)) {
                    // Füge den Key und all seine Synonyme hinzu
                    allSynonyms.add(key);
                    synonyms.forEach(syn => allSynonyms.add(syn));
                }
                // ODER wenn ein Synonym mit dem Suchbegriff ANFÄNGT
                else if (synonyms.some(syn => syn.startsWith(normalized))) {
                    // Füge den Key und all seine Synonyme hinzu
                    allSynonyms.add(key);
                    synonyms.forEach(syn => allSynonyms.add(syn));
                }
            });

            // IMMER den Original-Suchbegriff hinzufügen (für direkte Firmennamen-Matches)
            allSynonyms.add(term);

            return Array.from(allSynonyms);
        }

        // Intelligente Such-Funktion mit Fuzzy Matching
        function performSmartSearch(text, searchVariations, normalizedSearchTerm) {
            // text = zu durchsuchender Text
            // searchVariations = Array von Such-Begriffen mit Synonymen
            // normalizedSearchTerm = normalisierte Version (Umlaute ersetzt)

            const textLower = text.toLowerCase();
            const textNormalized = normalizeString(text);

            // Überprüfe alle Variationen
            return searchVariations.some(variant => {
                const normalizedVariant = normalizeString(variant);
                return textLower.includes(variant) || textNormalized.includes(normalizedVariant);
            });
        }

        // Live Search Function with Intelligence
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            if (searchTerm.length === 0) {
                renderHome();
                return;
            }

            const results = [];

            // Hole alle Synonyme und Variationen
            const searchVariations = getSearchSynonyms(searchTerm);
            const normalizedSearchTerm = normalizeString(searchTerm);

            // VOLLTEXTSUCHE - Durchsuche ALLES mit Smart-Search!

            // 1. Suche in KATEGORIEN (höchste Priorität)
            Object.values(categories).forEach(category => {
                const categoryText = `${category.title} ${category.description} ${category.id}`;

                if (performSmartSearch(categoryText, searchVariations, normalizedSearchTerm)) {
                    results.push({
                        type: 'category',
                        priority: 1,
                        category: category,
                        matchText: category.title
                    });
                }
            });

            // 2. Suche in UNTERKATEGORIEN (Vereine, Werbering-Kategorien, etc.)
            Object.values(categories).forEach(category => {
                if (category.subcategories) {
                    Object.values(category.subcategories).forEach(sub => {
                        const subText = `${sub.title} ${sub.description || ''} ${sub.id}`;

                        if (performSmartSearch(subText, searchVariations, normalizedSearchTerm)) {
                            results.push({
                                type: 'subcategory',
                                priority: 2,
                                category: category,
                                subcategory: sub,
                                matchText: sub.title
                            });
                        }

                        // Suche auch in den ITEMS der Unterkategorie (z.B. einzelne Vereine)
                        if (sub.items) {
                            sub.items.forEach(item => {
                                // Durchsuche ALLES: Titel, Info, Link, Website
                                const itemText = [
                                    item.title || '',
                                    ...(item.info || []),
                                    item.link || '',
                                    item.website || '',
                                    item.email || '',
                                    item.adresse || ''
                                ].join(' ');

                                if (performSmartSearch(itemText, searchVariations, normalizedSearchTerm)) {
                                    results.push({
                                        type: 'item',
                                        priority: 3,
                                        category: category,
                                        subcategory: sub,
                                        item: item,
                                        matchText: item.title
                                    });
                                }
                            });
                        }
                    });
                }

                // Suche auch in CONTENT (z.B. Bildung, Notfälle)
                if (category.content) {
                    if (category.content.type === 'list') {
                        category.content.items.forEach(item => {
                            const itemText = `${item.title} ${item.link || ''}`;
                            if (performSmartSearch(itemText, searchVariations, normalizedSearchTerm)) {
                                results.push({
                                    type: 'content-item',
                                    priority: 3,
                                    category: category,
                                    item: item,
                                    matchText: item.title
                                });
                            }
                        });
                    } else if (category.content.sections) {
                        category.content.sections.forEach(section => {
                            section.items.forEach(item => {
                                const itemText = [
                                    item.title || '',
                                    ...(item.info || []),
                                    item.link || ''
                                ].join(' ');

                                if (performSmartSearch(itemText, searchVariations, normalizedSearchTerm)) {
                                    results.push({
                                        type: 'content-item',
                                        priority: 3,
                                        category: category,
                                        item: item,
                                        matchText: item.title
                                    });
                                }
                            });
                        });
                    }
                }
            });

            // 3. Suche in BUSINESSES (Werbering) - mit verbesserter Priorisierung
            allBusinesses.forEach(business => {
                const name = business.name || '';
                const search = business.search || '';
                const location = business.location || '';
                const cat = business.category || '';

                const coreText = `${name} ${search} ${cat}`.toLowerCase();
                const coreTextNormalized = normalizeString(coreText);
                const fullText = `${coreText} ${location}`.toLowerCase();
                const fullTextNormalized = normalizeString(fullText);

                let priority = 4;
                let match = false;

                // Check variations
                for (const variant of searchVariations) {
                    const normalizedVariant = normalizeString(variant);

                    // Höchste Priorität: Wort-Treffer im Namen oder Suchbegriffen
                    const wordRegex = new RegExp('\\b' + variant.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                    const normalizedWordRegex = new RegExp('\\b' + normalizedVariant.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');

                    if (wordRegex.test(name) || normalizedWordRegex.test(normalizeString(name))) {
                        priority = 4; // Eigentlich 4.0, aber innerhalb der Businesses
                        match = true;
                        break;
                    }

                    if (wordRegex.test(search) || normalizedWordRegex.test(normalizeString(search))) {
                        priority = 4.1;
                        match = true;
                        break;
                    }

                    // Mittlere Priorität: Teil-Treffer im Namen oder Suchbegriffen
                    if (coreText.includes(variant) || coreTextNormalized.includes(normalizedVariant)) {
                        priority = 4.2;
                        match = true;
                        break;
                    }

                    // Niedrige Priorität: Treffer irgendwo (z.B. Adresse)
                    if (fullText.includes(variant) || fullTextNormalized.includes(normalizedVariant)) {
                        priority = 4.5;
                        match = true;
                        break;
                    }
                }

                if (match) {
                    results.push({
                        type: 'business',
                        priority: priority,
                        business: business,
                        matchText: business.name
                    });
                }
            });

            // 4. Suche in FORMULAREN (Gemeinde-Verwaltung)
            allFormulare.forEach(formular => {
                const text = (formular.title || '').toLowerCase();
                const normalizedText = normalizeString(text);

                for (const variant of searchVariations) {
                    const normalizedVariant = normalizeString(variant);
                    if (text.includes(variant) || normalizedText.includes(normalizedVariant)) {
                        results.push({
                            type: 'formular',
                            priority: 5,
                            formular: formular,
                            matchText: formular.title
                        });
                        break;
                    }
                }
            });

            // 5. Suche in MITARBEITERN (Gemeinde-Verwaltung)
            allMitarbeiter.forEach(person => {
                const text = `${person.name || ''} ${person.email || ''}`.toLowerCase();
                const normalizedText = normalizeString(text);

                for (const variant of searchVariations) {
                    const normalizedVariant = normalizeString(variant);
                    if (text.includes(variant) || normalizedText.includes(normalizedVariant)) {
                        results.push({
                            type: 'mitarbeiter',
                            priority: 5.1,
                            person: person,
                            matchText: person.name
                        });
                        break;
                    }
                }
            });

            // 6. Suche in ABTEILUNGEN (Gemeinde-Verwaltung)
            allAbteilungen.forEach(abteilung => {
                const abtText = `${abteilung.name || ''}`.toLowerCase();
                const normalizedAbtText = normalizeString(abtText);
                let abtMatch = false;

                for (const variant of searchVariations) {
                    const normalizedVariant = normalizeString(variant);
                    if (abtText.includes(variant) || normalizedAbtText.includes(normalizedVariant)) {
                        abtMatch = true;
                        results.push({
                            type: 'abteilung',
                            priority: 5.2,
                            abteilung: abteilung,
                            matchText: abteilung.name
                        });
                        break;
                    }
                }

                // Auch in Mitarbeitern der Abteilung suchen
                if (!abtMatch && abteilung.mitarbeiter) {
                    abteilung.mitarbeiter.forEach(person => {
                        const personText = `${person.name || ''} ${person.funktion || ''} ${person.email || ''}`.toLowerCase();
                        const normalizedPersonText = normalizeString(personText);

                        for (const variant of searchVariations) {
                            const normalizedVariant = normalizeString(variant);
                            if (personText.includes(variant) || normalizedPersonText.includes(normalizedVariant)) {
                                results.push({
                                    type: 'abteilung-person',
                                    priority: 5.3,
                                    abteilung: abteilung,
                                    person: person,
                                    matchText: person.name
                                });
                                break;
                            }
                        }
                    });
                }
            });

            // 7. Suche in GEMEINDEBETRIEBEN
            allGemeindebetriebe.forEach(betrieb => {
                const betText = `${betrieb.name || ''} ${betrieb.beschreibung || ''}`.toLowerCase();
                const normalizedBetText = normalizeString(betText);
                let betMatch = false;

                for (const variant of searchVariations) {
                    const normalizedVariant = normalizeString(variant);
                    if (betText.includes(variant) || normalizedBetText.includes(normalizedVariant)) {
                        betMatch = true;
                        results.push({
                            type: 'gemeindebetrieb',
                            priority: 5.4,
                            betrieb: betrieb,
                            matchText: betrieb.name
                        });
                        break;
                    }
                }

                // Auch in Mitarbeitern des Betriebs suchen
                if (!betMatch && betrieb.mitarbeiter) {
                    betrieb.mitarbeiter.forEach(person => {
                        const personText = `${person.name || ''} ${person.funktion || ''} ${person.email || ''}`.toLowerCase();
                        const normalizedPersonText = normalizeString(personText);

                        for (const variant of searchVariations) {
                            const normalizedVariant = normalizeString(variant);
                            if (personText.includes(variant) || normalizedPersonText.includes(normalizedVariant)) {
                                results.push({
                                    type: 'gemeindebetrieb-person',
                                    priority: 5.5,
                                    betrieb: betrieb,
                                    person: person,
                                    matchText: person.name
                                });
                                break;
                            }
                        }
                    });
                }
            });

            // Sortiere nach Priorität (Kategorien zuerst, dann Unterkategorien, dann Items, dann Businesses)
            results.sort((a, b) => a.priority - b.priority);

            // Entferne Duplikate
            const uniqueResults = [];
            const seen = new Set();

            results.forEach(result => {
                let key;
                if (result.type === 'business') {
                    key = `business-${result.business.name}`;
                } else if (result.type === 'category') {
                    key = `category-${result.category.id}`;
                } else if (result.type === 'subcategory') {
                    key = `subcategory-${result.category.id}-${result.subcategory.id}`;
                } else if (result.type === 'item') {
                    key = `item-${result.category.id}-${result.subcategory.id}-${result.item.title}`;
                } else if (result.type === 'content-item') {
                    key = `content-${result.category.id}-${result.item.title}`;
                } else if (result.type === 'formular') {
                    key = `formular-${result.formular.title}`;
                } else if (result.type === 'mitarbeiter') {
                    key = `mitarbeiter-${result.person.name}`;
                } else if (result.type === 'abteilung') {
                    key = `abteilung-${result.abteilung.name}`;
                } else if (result.type === 'abteilung-person') {
                    key = `abteilung-person-${result.abteilung.name}-${result.person.name}`;
                } else if (result.type === 'gemeindebetrieb') {
                    key = `gemeindebetrieb-${result.betrieb.name}`;
                } else if (result.type === 'gemeindebetrieb-person') {
                    key = `gemeindebetrieb-person-${result.betrieb.name}-${result.person.name}`;
                }

                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueResults.push(result);
                }
            });

            // Reset navigation history
            navigationHistory = [];

            // Display results
            displaySearchResults(searchTerm, uniqueResults);
        }

        function displaySearchResults(searchTerm, results) {
            const content = document.getElementById('mainContent');
            document.getElementById('backButton').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'instant' });
            document.getElementById('emergencyBanner').classList.add('hidden');
            document.getElementById('weatherWidget').classList.add('hidden');
            updateBreadcrumb([{ text: `Suchergebnisse für "${searchTerm}"` }]);

            if (results.length === 0) {
                content.innerHTML = `
                    <div class="info-section fade-in">
                        <h2>Keine Ergebnisse gefunden</h2>
                        <p>Für "${searchTerm}" wurden keine Ergebnisse gefunden.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="info-section fade-in">
                    <h2>Suchergebnisse: ${results.length} ${results.length === 1 ? 'Treffer' : 'Treffer'}</h2>
                </div>
                <div class="businesses-grid">
            `;

            results.forEach(result => {
                if (result.type === 'category') {
                    // Hauptkategorie
                    html += `
                        <div class="business-card" onclick="navigateToCategory('${result.category.id}')" style="cursor: pointer;">
                            <div class="business-name">${result.category.icon} ${result.category.title}</div>
                            <div class="business-location">${result.category.description}</div>
                        </div>
                    `;
                } else if (result.type === 'subcategory') {
                    // Unterkategorie (z.B. Sport, Kultur bei Vereinen)
                    html += `
                        <div class="business-card" onclick="navigateToSubcategory('${result.category.id}', '${result.subcategory.id}')" style="cursor: pointer;">
                            <div class="business-name">${result.subcategory.title}</div>
                            <div class="business-location">📂 ${result.category.title} → ${result.subcategory.description || ''}</div>
                        </div>
                    `;
                } else if (result.type === 'item') {
                    // Einzelne Items in Unterkategorien (z.B. einzelne Vereine)
                    const item = result.item;
                    html += `
                        <div class="business-card" onclick="navigateToSubcategory('${result.category.id}', '${result.subcategory.id}')" style="cursor: pointer;">
                            <div class="business-name">${item.title}</div>
                            <div class="business-location">📂 ${result.category.title} → ${result.subcategory.title}</div>
                            ${item.info && item.info[0] ? `<p style="font-size: 0.9em; color: var(--text-light); margin-top: 5px;">${item.info[0]}</p>` : ''}
                        </div>
                    `;
                } else if (result.type === 'content-item') {
                    // Content items (z.B. Bildungseinrichtungen)
                    html += `
                        <div class="business-card" onclick="navigateToCategory('${result.category.id}')" style="cursor: pointer;">
                            <div class="business-name">${result.item.title}</div>
                            <div class="business-location">📂 ${result.category.title}</div>
                        </div>
                    `;
                } else if (result.type === 'business') {
                    // Werbering-Betriebe
                    const b = result.business;
                    html += `
                        <div class="business-card">
                            <div class="business-name">${b.name}</div>
                            <div class="business-location">📍 ${b.location}</div>
                            ${b.link ? `<a href="${b.link}" class="business-link" target="_blank">🌐 Website besuchen</a>` : ''}
                        </div>
                    `;
                } else if (result.type === 'formular') {
                    // Formulare
                    const f = result.formular;
                    html += `
                        <div class="business-card">
                            <div class="business-name">📄 ${f.title}</div>
                            <div class="business-location">🏛️ Gemeinde & Verwaltung → Formulare</div>
                            <a href="${f.url}" class="business-link" target="_blank">→ Formular öffnen</a>
                        </div>
                    `;
                } else if (result.type === 'mitarbeiter') {
                    // Mitarbeiter
                    const p = result.person;
                    html += `
                        <div class="business-card" onclick="window.open('./gemeinde-verwaltung/mitarbeiter.html', '_self')" style="cursor: pointer;">
                            <div class="business-name">👤 ${p.name}</div>
                            <div class="business-location">🏛️ Gemeindemitarbeiter</div>
                            ${p.telefon ? `<p style="font-size: 0.9em; color: var(--text-light); margin-top: 5px;">☎️ ${p.telefon}</p>` : ''}
                            ${p.email ? `<p style="font-size: 0.9em; color: var(--text-light);">📧 ${p.email}</p>` : ''}
                        </div>
                    `;
                } else if (result.type === 'abteilung') {
                    // Abteilungen
                    const a = result.abteilung;
                    html += `
                        <div class="business-card" onclick="window.open('./gemeinde-verwaltung/abteilungen.html', '_self')" style="cursor: pointer;">
                            <div class="business-name">🏛️ ${a.name}</div>
                            <div class="business-location">Gemeindeamt Vorchdorf</div>
                            ${a.url ? `<a href="${a.url}" class="business-link" target="_blank" onclick="event.stopPropagation()">→ Mehr Infos</a>` : ''}
                        </div>
                    `;
                } else if (result.type === 'abteilung-person') {
                    // Person in Abteilung
                    const p = result.person;
                    const a = result.abteilung;
                    html += `
                        <div class="business-card" onclick="window.open('./gemeinde-verwaltung/abteilungen.html', '_self')" style="cursor: pointer;">
                            <div class="business-name">👤 ${p.name}</div>
                            <div class="business-location">🏛️ ${a.name}</div>
                            ${p.funktion ? `<p style="font-size: 0.9em; color: var(--text-light); margin-top: 5px;">${p.funktion}</p>` : ''}
                            ${p.telefon ? `<p style="font-size: 0.9em; color: var(--text-light);">☎️ ${p.telefon}</p>` : ''}
                        </div>
                    `;
                } else if (result.type === 'gemeindebetrieb') {
                    // Gemeindebetriebe
                    const b = result.betrieb;
                    html += `
                        <div class="business-card" onclick="window.open('./gemeinde-verwaltung/gemeindebetriebe.html', '_self')" style="cursor: pointer;">
                            <div class="business-name">🏗️ ${b.name}</div>
                            <div class="business-location">🏛️ Gemeinde & Verwaltung → Gemeindebetriebe</div>
                            ${b.url ? `<a href="${b.url}" class="business-link" target="_blank" onclick="event.stopPropagation()">→ Mehr Infos</a>` : ''}
                        </div>
                    `;
                } else if (result.type === 'gemeindebetrieb-person') {
                    // Person in Gemeindebetrieb
                    const p = result.person;
                    const b = result.betrieb;
                    html += `
                        <div class="business-card" onclick="window.open('./gemeinde-verwaltung/gemeindebetriebe.html', '_self')" style="cursor: pointer;">
                            <div class="business-name">👤 ${p.name}</div>
                            <div class="business-location">🏗️ ${b.name}</div>
                            ${p.funktion ? `<p style="font-size: 0.9em; color: var(--text-light); margin-top: 5px;">${p.funktion}</p>` : ''}
                            ${p.telefon ? `<p style="font-size: 0.9em; color: var(--text-light);">☎️ ${p.telefon}</p>` : ''}
                        </div>
                    `;
                }
            });

            html += '</div>';
            content.innerHTML = html;
        }

        // Enter key for search
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // Essenzielle Daten laden
                await Promise.all([
                    loadCategories(),
                    loadBusinesses(),
                    loadClubs()
                ]);

                // Optionale Daten laden (nicht blockierend für den ersten Render)
                loadGemeindeData();
                initializeRP();
                initializeStempelpässe();
            } catch (error) {
                console.error('Initialisierungsfehler:', error);
            }

            // Sicherstellen, dass die App gerendert wird
            init();

            // Ensure COMPANY_COORDINATES is loaded
            if (typeof COMPANY_COORDINATES === 'undefined') {
                const script = document.createElement('script');
                script.src = 'company-coordinates.js';
                script.onload = () => console.log('Coordinates loaded dynamically');
                document.head.appendChild(script);
            }

            // Scroll-Check für Floating Back Button
            window.addEventListener('scroll', function () {
                const floatBtn = document.getElementById('floatingBackButton');
                if (window.scrollY > 300) {
                    floatBtn.classList.add('visible');
                } else {
                    floatBtn.classList.remove('visible');
                }
            });

            // Browser History Handler für Android Zurück-Taste
            // Füge initial State hinzu
            if (!window.history.state) {
                window.history.replaceState({ page: 'home' }, '', '');
            }

            // Handle Browser Back Button (Android Zurück-Taste)
            window.addEventListener('popstate', function (event) {
                // Wenn wir auf der Home-Seite sind, lassen wir den Browser die Navigation durchführen
                if (currentView === 'home') {
                    // Lasse den Browser navigieren (aus der App raus)
                    return;
                }

                // Ansonsten navigieren wir intern zurück
                event.preventDefault();
                goBack();

                // Stelle sicher, dass es immer einen History-Eintrag gibt
                if (currentView !== 'home') {
                    window.history.pushState({ page: currentView }, '', '');
                }
            });

            // Bei Navigation neuen History-Eintrag erstellen
            const originalNavigateToCategory = window.navigateToCategory;
            window.navigateToCategory = function (categoryId) {
                originalNavigateToCategory(categoryId);
                window.history.pushState({ page: 'category', categoryId: categoryId }, '', '');
            };

            const originalNavigateToSubcategory = window.navigateToSubcategory;
            window.navigateToSubcategory = function (categoryId, subcategoryId) {
                originalNavigateToSubcategory(categoryId, subcategoryId);
                window.history.pushState({ page: 'subcategory', categoryId: categoryId, subcategoryId: subcategoryId }, '', '');
            };


            // Display version in footer (with safety checks)
            if (document.getElementById('versionInfo'))
                document.getElementById('versionInfo').textContent = ' | Version ' + APP_VERSION;
            if (document.getElementById('flohmarktVersionInfo'))
                document.getElementById('flohmarktVersionInfo').textContent = ' | Version ' + APP_VERSION;
            if (document.getElementById('rpVersionInfo'))
                document.getElementById('rpVersionInfo').textContent = ' | Version ' + APP_VERSION;

            // Event Listeners for Regionale Produkte
            document.getElementById('rpSearchInput').addEventListener('input', filterRPProducts);
            document.getElementById('rpCategoryFilter').addEventListener('change', filterRPProducts);
            document.getElementById('rpCompanyFilter').addEventListener('change', filterRPProducts);
            document.getElementById('rpModalClose').addEventListener('click', closeRPModal);
            document.getElementById('rpPrevImage').addEventListener('click', (e) => { e.stopPropagation(); rpPrevImage(); });
            document.getElementById('rpNextImage').addEventListener('click', (e) => { e.stopPropagation(); rpNextImage(); });
            document.getElementById('rpModalOverlay').addEventListener('click', (e) => {
                document.getElementById('mainFooter').style.display = 'none';
                if (e.target.id === 'rpModalOverlay') closeRPModal();
            });

            // Live search - triggers as you type
            document.getElementById('searchInput').addEventListener('input', function (e) {
                performSearch();
            });

            // Also support Enter key
            document.getElementById('searchInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // PWA Installation
            let deferredPrompt;
            const installButton = document.getElementById('installButton');

            // Service Worker Registration - DISABLED due to caching issues
            // if ('serviceWorker' in navigator) {
            //     navigator.serviceWorker.register('./service-worker.js')
            //         .then(registration => {
            //             console.log('✅ Service Worker registered:', registration);
            //         })
            //         .catch(error => {
            //             console.log('❌ Service Worker registration failed:', error);
            //         });
            // }

            // Listen for beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent the mini-infobar from appearing on mobile
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                // Show install button
                installButton.classList.remove('hidden');
            });

            // Handle install button click
            installButton.addEventListener('click', async () => {
                if (!deferredPrompt) {
                    return;
                }
                // Show the install prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                // Clear the deferredPrompt
                deferredPrompt = null;
                // Hide install button
                installButton.classList.add('hidden');
            });

            // Handle app installed event
            window.addEventListener('appinstalled', () => {
                console.log('✅ PWA installed successfully!');
                installButton.classList.add('hidden');
                deferredPrompt = null;
            });

            init();
        });
    </script>

    <!-- Floating Back Button (At the very end of body to prevent layout jumps) -->
    <button id="floatingBackButton" class="floating-back-button" onclick="handleFloatingBack()" title="Nach oben">
        &uarr;
    </button>
</body>

</html>