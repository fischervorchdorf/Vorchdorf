<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vorchdorfer Mittagstisch</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #059669;
            /* Smaragdgr√ºn */
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-sec: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            font-size: 15px;
            line-height: 1.4;
            padding-bottom: 2rem;
        }

        /* Header */
        .header {
            background: var(--surface);
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-link {
            text-decoration: none;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .app-title {
            font-weight: 800;
            font-size: 1.1rem;
            color: var(--text-main);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: transparent;
            border-radius: 8px;
            font-weight: 600;
            color: var(--text-sec);
            font-size: 0.9rem;
            white-space: nowrap;
            cursor: pointer;
        }

        .tab-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        /* Content Container */
        .main {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Compact Card Design */
        .day-block {
            margin-bottom: 24px;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
            padding: 0 4px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 4px;
        }

        .day-name {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text-main);
            text-transform: uppercase;
        }

        .day-date {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-sec);
        }

        .menu-row {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }

        .wirt-icon {
            width: 40px;
            height: 40px;
            background: #ecfdf5;
            color: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .menu-details {
            flex: 1;
            min-width: 0;
        }

        .wirt-name {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-sec);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .dish-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 6px;
            white-space: pre-wrap;
        }

        .meta-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .price-badge {
            background: #f1f5f9;
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 700;
            color: var(--text-main);
        }

        .note-text {
            color: var(--text-sec);
            font-size: 0.8rem;
            font-style: italic;
        }

        /* Hosts Grid */
        .hosts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .host-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow);
        }

        .host-btn:active {
            transform: scale(0.98);
            background: #f1f5f9;
        }

        .host-btn-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        .host-btn-name {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-main);
        }

        /* Host Modal/Detail */
        .host-detail-view {
            display: none;
            margin-top: 16px;
        }

        .host-detail-view.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .close-host-btn {
            background: #f1f5f9;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
            width: 100%;
        }

        /* Utilities */
        .hidden {
            display: none;
        }

        .empty-msg {
            text-align: center;
            color: var(--text-sec);
            padding: 20px;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--primary);
            font-weight: 600;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <header class="header">
        <a href="index.html" class="back-link">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                <path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            Zur√ºck
        </a>
        <div class="app-title">Mittagstisch</div>
        <div style="width: 60px"></div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="setMode('today')">üìÖ Heute + Woche</button>
        <button class="tab-btn" onclick="setMode('hosts')">üçΩÔ∏è Wirte w√§hlen</button>
    </div>

    <div class="main">
        <div id="loader" class="loading">Lade frische Men√ºs...</div>

        <!-- View: Timeline -->
        <div id="view-timeline" class="view-section">
            <div id="timeline-container"></div>
        </div>

        <!-- View: Hosts -->
        <div id="view-hosts" class="view-section hidden">
            <div id="hosts-grid" class="hosts-grid"></div>

            <div id="host-detail-container" class="host-detail-view">
                <button class="close-host-btn" onclick="closeHostDetail()">‚Üê Zur√ºck zur Auswahl</button>
                <div id="host-plan"></div>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/16oJAdKlUthvoQBdOiFbI-1OXYnspNc3Yn8cRuqILNsw/export?format=csv';
        const DAYS = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];

        let allItems = [];
        let uniqueHosts = [];

        async function init() {
            try {
                const res = await fetch(CSV_URL);
                const text = await res.text();
                const raw = parseCSV(text);

                allItems = raw.flatMap(entry => processEntry(entry));

                // Hosts extraction
                const hostSet = new Set();
                allItems.forEach(i => hostSet.add(i.gasthaus));
                uniqueHosts = Array.from(hostSet).sort();

                buildTimeline();
                buildHostsGrid();

                document.getElementById('loader').classList.add('hidden');
            } catch (e) {
                document.getElementById('loader').innerText = "Fehler beim Laden. Bitte neu laden.";
                console.error(e);
            }
        }

        // --- Render Logic ---

        function buildTimeline() {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';

            const now = new Date();
            now.setHours(12, 0, 0, 0);

            // Find maximum date in our data
            let maxDate = new Date(now);
            allItems.forEach(item => {
                const d = new Date(item.dateStr);
                d.setHours(12, 0, 0, 0);
                if (d > maxDate) maxDate = d;
            });

            // Calculate days diff (cap at 28 days to avoid infinite loops on bad data)
            const diffTime = Math.abs(maxDate - now);
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 1) diffDays = 1; // Show at least today/tomorrow logic
            if (diffDays > 28) diffDays = 28;

            // Show timeline up to the last available data
            for (let i = 0; i <= diffDays; i++) {
                const date = new Date(now);
                date.setDate(now.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const dayName = DAYS[date.getDay()];

                // Find items for this day
                const dayItems = allItems.filter(item => item.dateStr === dateStr);

                // Render Day Header
                const dayBlock = document.createElement('div');
                dayBlock.className = 'day-block';

                let prettyDate = date.toLocaleDateString('de-AT', { day: '2-digit', month: '2-digit' });
                let label = dayName;
                if (i === 0) label = "Heute";
                if (i === 1) label = "Morgen";

                const headerHTML = `
                    <div class="day-header">
                        <span class="day-name">${label}</span>
                        <span class="day-date">${prettyDate}</span>
                    </div>
                `;

                let contentHTML = '';
                if (dayItems.length === 0) {
                    // Only show empty message if it's today or tomorrow, skip empty future days to save space
                    if (i < 2) contentHTML = `<div class="empty-msg">Keine Men√ºs eingetragen.</div>`;
                    else continue; // Skip rendering completely if empty and far future
                } else {
                    contentHTML = dayItems.map(item => `
                        <div class="menu-row">
                            <div class="wirt-icon">üçΩÔ∏è</div>
                            <div class="menu-details">
                                <div class="wirt-name">${item.gasthaus}</div>
                                <div class="dish-name">${item.menu}</div>
                                <div class="meta-info">
                                    <span class="note-text">${item.anmerkung}</span>
                                    ${item.preis ? `<span class="price-badge">‚Ç¨ ${item.preis}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                dayBlock.innerHTML = headerHTML + contentHTML;
                container.appendChild(dayBlock);
            }
        }

        function buildHostsGrid() {
            const grid = document.getElementById('hosts-grid');
            grid.innerHTML = uniqueHosts.map(host => `
                <div class="host-btn" onclick="showHost('${host}')">
                    <span class="host-btn-icon">üë®‚Äçüç≥</span>
                    <div class="host-btn-name">${host}</div>
                </div>
            `).join('');
        }

        function showHost(name) {
            document.getElementById('hosts-grid').classList.add('hidden');
            const detailView = document.getElementById('host-detail-container');
            const planContainer = document.getElementById('host-plan');
            detailView.classList.add('active');

            // Find all future/current items for this host
            const items = allItems.filter(i => i.gasthaus === name && new Date(i.dateStr) >= new Date().setHours(0, 0, 0, 0))
                .sort((a, b) => a.date - b.date);

            if (items.length === 0) {
                planContainer.innerHTML = `<div class="empty-msg">Keine aktuellen Pl√§ne vorhanden.</div>`;
                return;
            }

            planContainer.innerHTML = items.map(item => `
                <div class="day-header" style="margin-top:16px; border-bottom:1px dashed #ccc">
                     <span class="day-name" style="font-size:0.9rem">${item.dayName}</span>
                     <span class="day-date">${new Date(item.date).toLocaleDateString('de-AT', { day: '2-digit', month: '2-digit' })}</span>
                </div>
                <div class="menu-row" style="box-shadow:none; border:1px solid #eee; margin-top:8px">
                    <div class="menu-details">
                        <div class="dish-name">${item.menu}</div>
                        <div class="meta-info">
                             <span class="note-text">${item.anmerkung}</span>
                             ${item.preis ? `<span class="price-badge">‚Ç¨ ${item.preis}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function closeHostDetail() {
            document.getElementById('host-detail-container').classList.remove('active');
            document.getElementById('hosts-grid').classList.remove('hidden');
        }

        function setMode(mode) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));

            if (mode === 'today') {
                document.querySelector('button[onclick="setMode(\'today\')"]').classList.add('active');
                document.getElementById('view-timeline').classList.remove('hidden');
            } else {
                document.querySelector('button[onclick="setMode(\'hosts\')"]').classList.add('active');
                document.getElementById('view-hosts').classList.remove('hidden');
                document.getElementById('hosts-grid').classList.remove('hidden'); // Reset grid visibility
                document.getElementById('host-detail-container').classList.remove('active');
            }
        }

        // --- Parsing Logic (Kept from V2) ---

        function processEntry(entry) {
            // Logic: Relative Week Calculation + Freitext Parsing
            const gasthaus = entry.gasthausname;
            const selection = entry.woche;
            const freitext = entry.menueplanfreitext || entry.menuplanfreitext || "";
            const preis = entry.preis || "";
            const anmerkung = entry.anmerkung || "";

            const timestamp = parseDate(entry.zeitstempel);
            timestamp.setHours(12, 0, 0, 0); // Noon

            const mondayCurrent = new Date(timestamp);
            mondayCurrent.setDate(timestamp.getDate() - (timestamp.getDay() === 0 ? 6 : timestamp.getDay() - 1));

            let targetMonday = new Date(mondayCurrent);
            if (selection.includes("N√§chste")) targetMonday.setDate(mondayCurrent.getDate() + 7);
            else if (selection.includes("√úbern√§chste")) targetMonday.setDate(mondayCurrent.getDate() + 14);

            const extracted = extractFromFreitext(freitext);
            const items = [];

            ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'].forEach((day, idx) => {
                const dayKey = day.toLowerCase();
                let menu = entry[dayKey] || extracted[dayKey] || "";

                // Add "Geschlossen" if explicitly mentioned? For now just skip empty unless needed
                // Feature: If text contains "Ruhetag" or "Geschlossen", show it!
                if (menu.trim().length > 2) {
                    const menuDate = new Date(targetMonday);
                    menuDate.setDate(targetMonday.getDate() + idx);
                    items.push({
                        gasthaus, menu: menu.trim(), preis, anmerkung,
                        date: menuDate, dayName: day, dateStr: menuDate.toISOString().split('T')[0]
                    });
                }
            });
            return items;
        }

        function extractFromFreitext(text) {
            const days = { montag: ['montag', 'mo'], dienstag: ['dienstag', 'di'], mittwoch: ['mittwoch', 'mi'], donnerstag: ['donnerstag', 'do'], freitag: ['freitag', 'fr'], samstag: ['samstag', 'sa'], sonntag: ['sonntag', 'so'] };
            const result = {};
            text.split('\n').forEach(line => {
                const clean = line.trim();
                let foundHeader = false;
                for (let day in days) {
                    const pattern = new RegExp('^(' + days[day].join('|') + ')[:\\s,\\.]', 'i');
                    if (pattern.test(clean)) {
                        currentDay = day;
                        result[currentDay] = clean.replace(pattern, '').trim();
                        foundHeader = true; break;
                    }
                }
                if (!foundHeader && typeof currentDay !== 'undefined') {
                    result[currentDay] = (result[currentDay] ? result[currentDay] + '\n' : '') + clean;
                }
            });
            return result;
        }

        function parseCSV(text) {
            // Robust Parser V2
            const arr = []; let quote = false; let col = 0, row = 0;
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            for (let c = 0; c < text.length; c++) {
                let cc = text[c], nc = text[c + 1];
                arr[row] = arr[row] || []; arr[row][col] = arr[row][col] || '';
                if (cc == '"') { if (quote && nc == '"') { arr[row][col] += cc; ++c; } else { quote = !quote; } }
                else if (cc == ',' && !quote) { ++col; }
                else if (cc == '\n' && !quote) { ++row; col = 0; }
                else { arr[row][col] += cc; }
            }
            const headers = arr[0].map(h => normalizeHeader(h));
            return arr.slice(1).map(row => {
                if (row.length < 2) return null;
                const obj = {}; headers.forEach((h, i) => obj[h] = row[i] ? row[i].trim() : '');
                return obj.gasthausname ? obj : null;
            }).filter(x => x);
        }

        function normalizeHeader(h) {
            return h.trim().toLowerCase().replace(/√§/g, 'ae').replace(/√∂/g, 'oe').replace(/√º/g, 'ue').replace(/√ü/g, 'ss').replace(/[^a-z0-9]/g, '');
        }

        function parseDate(str) {
            if (!str) return new Date();
            const p = str.split(' ')[0].split('.');
            return new Date(p[2], p[1] - 1, p[0]);
        }

        init();
    </script>
</body>

</html>