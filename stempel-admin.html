<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stempelpass Admin - Vorchdorf</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #1a472a;
            --secondary: #FF9800;
            --bg: #f4f7f6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        .section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
        }

        button:hover {
            opacity: 0.9;
        }

        #qrcode {
            margin-top: 20px;
            padding: 20px;
            background: white;
            display: inline-block;
            border: 1px solid #ddd;
        }

        .result-json {
            background: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .copy-btn {
            background: #666;
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .print-btn {
            background: #2196F3;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .error-box {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #printArea,
            #printArea * {
                visibility: visible;
            }

            #printArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>üéüÔ∏è Stempelpass Admin-Tool</h1>
        <p>Erstellen Sie neue P√§sse f√ºr die <b>stempel_data.json</b> oder generieren Sie QR-Codes f√ºr Betriebe.</p>

        <div class="info-box">
            <strong>‚ÑπÔ∏è Wichtig:</strong> Dieses Tool muss vom gleichen Server geladen werden wie die Vorchdorf-App,
            damit es die <code>stempel_data.json</code> Datei finden kann.
        </div>

        <!-- SECTION 0: EXISTING PASSES -->
        <div class="section">
            <h2>üìú Vorhandene P√§sse</h2>
            <p>Klicken Sie auf einen Pass, um die ID f√ºr den QR-Generator zu √ºbernehmen:</p>
            <div id="existingPassesList"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                <div style="padding: 20px; text-align: center; color: #999;">
                    üîÑ Lade P√§sse...
                </div>
            </div>
        </div>

        <!-- SECTION 1: QR CODE GENERATOR -->
        <div class="section">
            <h2>1Ô∏è‚É£ QR-Code f√ºr Betrieb generieren</h2>

            <div class="warning-box">
                <strong>‚ö†Ô∏è NEU:</strong> QR-Codes werden jetzt im Cloud-kompatiblen Format generiert!<br>
                Format: <code>{"type": "VORCHDORF_STAMP", "pass_id": "...", "company_id": "..."}</code>
            </div>

            <p>Geben Sie die ID des Passes und den Namen des Betriebs ein.</p>
            <div class="grid">
                <div>
                    <label>Pass ID (z.B. vorchdorf_winter_2025)</label>
                    <input type="text" id="qrPassId" placeholder="Pass ID kopieren...">

                    <label>Betriebs ID / Firmenname (kleingeschrieben, ohne Leerzeichen)</label>
                    <input type="text" id="qrCompanyId" placeholder="z.b. trafik_fischer">

                    <button onclick="generateQR()">QR-Code erstellen</button>
                </div>
                <div id="printArea" style="text-align: center;">
                    <div id="qrcode"></div>
                    <div id="qrLabel" style="margin-top: 10px; font-weight: bold; font-size: 1.2rem;"></div>
                    <div id="qrSubLabel" style="font-size: 0.9rem; color: #666;">Scan f√ºr Stempelpass</div>
                    <br>
                    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Ausdrucken</button>
                </div>
            </div>
        </div>

        <!-- SECTION 2: PASS GENERATOR -->
        <div class="section">
            <h2>2Ô∏è‚É£ Neuen Pass anlegen (JSON Code)</h2>
            <div class="grid">
                <div>
                    <label>Eindeutige ID (z.B. cafe_2025_sommer)</label>
                    <input type="text" id="passId" oninput="updateJson()"
                        placeholder="nur_kleinbuchstaben_und_unterstriche">

                    <label>Name des Passes</label>
                    <input type="text" id="passName" oninput="updateJson()" placeholder="z.B. Caf√©-Pass Winter 2025">

                    <label>Beschreibung</label>
                    <textarea id="passDesc" oninput="updateJson()"
                        placeholder="z.B. Sammle 10 Stempel bei teilnehmenden Caf√©s in Vorchdorf" rows="3"></textarea>

                    <label>Typ</label>
                    <select id="passType" onchange="updateJson()">
                        <option value="ORTS_PASS">Orts-Pass (Mehrere Firmen)</option>
                        <option value="FIRMEN_PASS">Firmen-Pass (Einzelner Betrieb)</option>
                        <option value="EVENT_PASS">Event-Pass (Zeitlich begrenzt)</option>
                    </select>

                    <label>Anzahl Stempel (z.B. 5 oder 10)</label>
                    <input type="number" id="passTarget" value="10" min="3" max="20" oninput="updateJson()">

                    <label>G√ºltig von (Datum)</label>
                    <input type="date" id="passValidFrom" oninput="updateJson()">

                    <label>G√ºltig bis (Datum)</label>
                    <input type="date" id="passValidTo" oninput="updateJson()">
                </div>
                <div>
                    <label>JSON Ergebnis (zum Einf√ºgen in stempel_data.json)</label>
                    <div id="jsonOutput" class="result-json"></div>
                    <button class="copy-btn" onclick="copyJson()">üìã JSON in Zwischenablage kopieren</button>
                    <div class="info-box" style="margin-top: 15px; font-size: 0.85rem;">
                        <strong>üìù Anleitung:</strong><br>
                        1. Kopieren Sie diesen JSON-Block<br>
                        2. √ñffnen Sie die Datei <code>stempel_data.json</code><br>
                        3. F√ºgen Sie den Block in die Liste "passes" ein (mit Komma davor!)<br>
                        4. Speichern Sie die Datei<br>
                        5. App neu laden ‚Üí Neuer Pass erscheint!
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 3: GOOGLE SHEETS INTEGRATION INFO -->
        <div class="section">
            <h2>3Ô∏è‚É£ Cloud-Synchronisation</h2>
            <div class="info-box">
                <strong>‚òÅÔ∏è Automatische Synchronisation aktiv!</strong><br><br>
                Alle Stempel werden automatisch in Google Sheets gespeichert:<br>
                ‚Ä¢ Tab "Stempel" ‚Üí Alle gescannten Stempel<br>
                ‚Ä¢ Tab "Users" ‚Üí Benutzerstatistiken<br><br>
                Die Stempel sind damit:<br>
                ‚úÖ Ger√§te√ºbergreifend verf√ºgbar<br>
                ‚úÖ Automatisch gesichert<br>
                ‚úÖ Offline-f√§hig (Queue-System)
            </div>
        </div>
    </div>

    <script>
        let qrcode = new QRCode(document.getElementById("qrcode"), {
            width: 250,
            height: 250,
            colorDark: "#1a472a",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });

        // Setze heutige Daten als Default
        document.getElementById('passValidFrom').value = new Date().toISOString().split('T')[0];
        const endDate = new Date();
        endDate.setFullYear(endDate.getFullYear() + 1);
        document.getElementById('passValidTo').value = endDate.toISOString().split('T')[0];

        function generateQR() {
            const passId = document.getElementById('qrPassId').value.trim();
            const companyId = document.getElementById('qrCompanyId').value.trim();

            if (!passId || !companyId) {
                alert("‚ùå Bitte Pass ID und Betriebs ID eingeben!");
                return;
            }

            // NEUES FORMAT (Cloud-kompatibel)
            const data = {
                type: "VORCHDORF_STAMP",  // ‚Üê NEU!
                pass_id: passId,
                company_id: companyId
            };

            qrcode.clear();
            qrcode.makeCode(JSON.stringify(data));
            document.getElementById('qrLabel').innerText = companyId.toUpperCase();
            document.getElementById('qrSubLabel').innerText = "Vorchdorfer Stempelpass: " + passId;

            console.log('‚úÖ QR-Code generiert:', data);
        }

        function updateJson() {
            const id = document.getElementById('passId').value.trim() || "pass_id_hier";
            const name = document.getElementById('passName').value.trim() || "Pass Name hier";
            const desc = document.getElementById('passDesc').value.trim() || "Beschreibung hier";
            const type = document.getElementById('passType').value;
            const target = parseInt(document.getElementById('passTarget').value) || 10;
            const validFrom = document.getElementById('passValidFrom').value || new Date().toISOString().split('T')[0];
            const validTo = document.getElementById('passValidTo').value || "2025-12-31";

            const obj = {
                id: id,
                name: name,
                description: desc,
                type: type,
                target_stamps: target,
                valid_from: validFrom,
                valid_to: validTo,
                status: "ACTIVE",
                companies: ["betriebs_id_hier", "weitere_betriebe_hier"]
            };

            document.getElementById('jsonOutput').innerText = JSON.stringify(obj, null, 2);
        }

        function copyJson() {
            const text = document.getElementById('jsonOutput').innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert("‚úÖ JSON in Zwischenablage kopiert!");
            }).catch(err => {
                alert("‚ùå Fehler beim Kopieren: " + err);
            });
        }

        // Load existing passes
        async function loadExistingPasses() {
            const list = document.getElementById('existingPassesList');
            try {
                const response = await fetch('./stempel_data.json?v=' + Date.now());

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (!data.passes || data.passes.length === 0) {
                    list.innerHTML = `
                        <div class="warning-box" style="grid-column: 1/-1;">
                            <strong>‚ö†Ô∏è Keine P√§sse gefunden!</strong><br>
                            Die stempel_data.json enth√§lt noch keine P√§sse. Erstellen Sie unten einen neuen Pass.
                        </div>
                    `;
                    return;
                }

                list.innerHTML = data.passes.map(pass => {
                    const statusColor = pass.status === 'ACTIVE' ? '#4caf50' : '#999';
                    return `
                        <div onclick="selectPass('${pass.id}')" 
                             style="background: #fff; border: 2px solid ${statusColor}; padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <div style="font-weight: 700; color: var(--primary); margin-bottom: 5px;">${pass.name}</div>
                            <div style="font-size: 0.75rem; color: #666; font-family: monospace; margin-bottom: 5px;">ID: ${pass.id}</div>
                            <div style="font-size: 0.75rem; color: #999;">
                                üéØ ${pass.target_stamps} Stempel | üìÖ bis ${pass.valid_to}
                            </div>
                            <div style="font-size: 0.7rem; margin-top: 8px; padding: 4px 8px; background: ${statusColor}; color: white; border-radius: 4px; display: inline-block;">
                                ${pass.status}
                            </div>
                        </div>
                    `;
                }).join('');

                console.log('‚úÖ P√§sse geladen:', data.passes.length);

            } catch (error) {
                console.error('‚ùå Fehler beim Laden:', error);
                list.innerHTML = `
                    <div class="error-box" style="grid-column: 1/-1;">
                        <strong>‚ùå stempel_data.json konnte nicht geladen werden!</strong><br><br>
                        M√∂gliche Ursachen:<br>
                        ‚Ä¢ Die Datei existiert nicht im gleichen Ordner<br>
                        ‚Ä¢ Die HTML wird lokal ge√∂ffnet (file://) statt vom Server<br>
                        ‚Ä¢ Die JSON-Datei hat Syntaxfehler<br><br>
                        <strong>L√∂sung:</strong> Laden Sie diese HTML vom gleichen Server wie die Vorchdorf-App!<br><br>
                        <small>Fehler: ${error.message}</small>
                    </div>
                `;
            }
        }

        function selectPass(id) {
            document.getElementById('qrPassId').value = id;
            // Scroll to QR Generator
            document.querySelector('.section:nth-of-type(2)').scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Highlight input
            document.getElementById('qrPassId').focus();
            document.getElementById('qrPassId').select();
        }

        // Initialize
        updateJson();
        loadExistingPasses();

        console.log('üéüÔ∏è Stempelpass Admin Tool geladen - Cloud Version');
    </script>

</body>

</html>